<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#ffcc00" />
  <title>Achadinhos do Dia</title>

  <style>
    :root{
      --yellow:#ffcc00;
      --yellow2:#ffb300;
      --black:#111;
      --bg:#f4f4f4;
      --card:#fff;
      --muted:#6b6b6b;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius:18px;
      --danger:#b00020;
      --danger2:#ff2d2d;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:#111;
    }
    a{color:inherit}

    /* HEADER */
    header{
      background: linear-gradient(135deg,var(--yellow),var(--yellow2));
      padding:14px 14px 16px;
      position:sticky;
      top:0;
      z-index:10;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
    }
    .top{
      max-width:1100px;
      margin:0 auto;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
      flex:1;
    }
    .logo{
      height:44px;
      width:auto;
      max-width:120px;
      object-fit:contain;
      display:block;
      border-radius:12px;
      background:rgba(255,255,255,.25);
      padding:6px;
    }
    .brandText{min-width:0}
    .brandText h1{
      margin:0;
      font-size:24px;
      font-weight:950;
      letter-spacing:-.3px;
      line-height:1.05;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandText p{
      margin:4px 0 0;
      font-size:13px;
      color:rgba(0,0,0,.7);
      font-weight:650;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* CONTROLS */
    .controls{
      max-width:1100px;
      margin:12px auto 0;
      display:grid;
      gap:10px;
      grid-template-columns: 1fr 1fr;
      padding:0 14px;
    }
    .searchWrap{
      background:#fff;
      border-radius:999px;
      display:flex;
      align-items:center;
      padding:10px 12px;
      gap:10px;
      box-shadow: 0 8px 18px rgba(0,0,0,.08);
      border:1px solid rgba(0,0,0,.06);
    }
    .searchWrap span{opacity:.75}
    #q{
      border:0;
      outline:0;
      width:100%;
      font-size:15px;
      background:transparent;
    }
    .selectWrap{
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      box-shadow: 0 8px 18px rgba(0,0,0,.08);
      border:1px solid rgba(0,0,0,.06);
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .selectWrap span{opacity:.75}
    #preset{
      border:0;
      outline:0;
      width:100%;
      font-size:15px;
      background:transparent;
      appearance:none;
    }
    .cta{
      grid-column:1 / -1;
      background:var(--black);
      color:#fff;
      border:0;
      border-radius:999px;
      padding:14px 16px;
      font-size:16px;
      font-weight:900;
      letter-spacing:.2px;
      box-shadow: 0 10px 20px rgba(0,0,0,.18);
      cursor:pointer;
    }
    .cta:active{transform:translateY(1px)}

    /* HERO */
    .hero{
      max-width:1100px;
      margin:14px auto 0;
      padding:0 14px;
    }
    .heroBox{
      background:linear-gradient(135deg,#fff7c4, #fff);
      border-radius:24px;
      border:1px solid rgba(0,0,0,.08);
      box-shadow:var(--shadow);
      padding:18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      animation:fadeDown .55s ease both;
    }
    .heroBox h2{
      margin:0;
      font-size:18px;
      font-weight:950;
      letter-spacing:-.2px;
    }
    .heroBox p{
      margin:6px 0 0;
      color:var(--muted);
      font-weight:650;
      font-size:13px;
    }
    .heroBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      background:var(--black);
      color:#fff;
      border-radius:999px;
      padding:12px 14px;
      text-decoration:none;
      font-weight:900;
      white-space:nowrap;
    }
    @keyframes fadeDown{
      from{opacity:0;transform:translateY(-10px)}
      to{opacity:1;transform:none}
    }

    /* MAIN */
    main{
      max-width:1100px;
      margin:0 auto;
      padding:14px 14px 40px;
    }
    .sectionHead{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      margin:18px 0 10px;
    }
    .sectionHead h3{
      margin:0;
      font-size:18px;
      font-weight:950;
      letter-spacing:-.2px;
    }
    .sectionHead small{
      color:var(--muted);
      font-weight:750;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:#111;
      color:#fff;
      border-radius:999px;
      padding:8px 10px;
      font-weight:950;
      font-size:12px;
      white-space:nowrap;
    }

    /* GRID */
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px;
    }
    @media (min-width: 820px){
      .grid{grid-template-columns: repeat(4, minmax(0,1fr));}
      .controls{grid-template-columns: 1.2fr .8fr; }
    }

    /* CARD */
    .card{
      background:var(--card);
      border-radius:var(--radius);
      overflow:hidden;
      border:1px solid rgba(0,0,0,.08);
      box-shadow: var(--shadow);
      transform:translateY(0);
      transition: transform .18s ease;
      animation: fadeUp .45s ease both;
    }
    .card:hover{transform:translateY(-4px)}
    @keyframes fadeUp{
      from{opacity:0;transform:translateY(12px)}
      to{opacity:1;transform:none}
    }
    .imgWrap{
      position:relative;
      background:#fff;
      border-bottom:1px solid rgba(0,0,0,.06);
      aspect-ratio: 1/1;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px;
    }
    .imgWrap img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
    }
    .pillRow{
      position:absolute;
      top:10px;
      left:10px;
      right:10px;
      display:flex;
      gap:8px;
      justify-content:space-between;
      pointer-events:none;
    }
    .pill{
      background:rgba(17,17,17,.92);
      color:#fff;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      font-weight:900;
      letter-spacing:.2px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      max-width:100%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill.blue{background:rgba(0,95,255,.92)}
    .pill.off{animation:pulse 1.4s infinite}
    @keyframes pulse{
      0%{transform:scale(1)}
      50%{transform:scale(1.06)}
      100%{transform:scale(1)}
    }

    .content{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:175px;
    }
    .title{
      font-weight:900;
      font-size:14px;
      line-height:1.2;
      display:-webkit-box;
      -webkit-line-clamp:3;
      -webkit-box-orient:vertical;
      overflow:hidden;
      min-height:50px;
    }

    /* META (rating / cupom / timer) */
    .meta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color:var(--muted);
      font-weight:750;
      font-size:13px;
      min-height:20px;
    }
    .metaLeft{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }

    /* TIMER (rel√¢mpago) */
    .timer{
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:linear-gradient(135deg,var(--danger),var(--danger2));
      color:#fff;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:950;
      letter-spacing:.2px;
      box-shadow:0 10px 18px rgba(176,0,32,.22);
      white-space:nowrap;
      animation: timerPulse 1.25s infinite;
    }
    .timer span{
      font-variant-numeric: tabular-nums;
    }
    @keyframes timerPulse{
      0%{transform:scale(1); filter:brightness(1)}
      50%{transform:scale(1.05); filter:brightness(1.05)}
      100%{transform:scale(1); filter:brightness(1)}
    }

    .prices{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
    }
    .old{
      color:#8a8a8a;
      text-decoration:line-through;
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
    }
    .new{
      color:#d60000;
      font-weight:950;
      font-size:22px;
      letter-spacing:-.4px;
      white-space:nowrap;
    }
    .offBadge{
      background:#111;
      color:#fff;
      border-radius:999px;
      padding:8px 10px;
      font-weight:950;
      font-size:12px;
      white-space:nowrap;
      align-self:flex-end;
    }
    .btn{
      margin-top:auto;
      display:block;
      text-align:center;
      background:linear-gradient(135deg,#ff5a00,#ff2d2d);
      color:#fff;
      text-decoration:none;
      font-weight:950;
      border-radius:999px;
      padding:12px 10px;
      box-shadow: 0 10px 18px rgba(255,60,0,.22);
    }

    /* STATUS / SKELETON */
    .status{
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      padding:12px;
      box-shadow: var(--shadow);
      margin:12px 0;
      display:none;
      font-weight:800;
    }
    .status.show{display:block}
    .status.error{
      border-color: rgba(176,0,32,.25);
      color:var(--danger);
      background:#fff2f4;
    }
    .skeletonGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px;
    }
    @media (min-width: 820px){
      .skeletonGrid{grid-template-columns: repeat(4, minmax(0,1fr));}
    }
    .sk{
      height:320px;
      border-radius:var(--radius);
      background:linear-gradient(90deg,#eee,#f6f6f6,#eee);
      background-size:200% 100%;
      animation: shimmer 1.2s infinite linear;
      border:1px solid rgba(0,0,0,.06);
    }
    @keyframes shimmer{
      0%{background-position: 0% 0}
      100%{background-position: 200% 0}
    }

    /* FOOTER DISCLAIMER */
    footer{
      margin-top:22px;
      background:#111;
      color:#cfcfcf;
      padding:18px 14px;
      text-align:center;
      font-weight:650;
      border-radius:18px;
    }
    footer strong{color:#fff}
  </style>
</head>

<body>
  <header>
    <div class="top">
      <div class="brand">
        <img class="logo" src="logo.png" alt="Achadinhos ML" loading="eager" />
        <div class="brandText">
          <h1>Achadinhos do Dia</h1>
          <p>Ofertas do Mercado Livre que realmente valem a pena</p>
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="searchWrap">
        <span>üîé</span>
        <input id="q" type="search" placeholder="Buscar produto..." autocomplete="off" />
      </div>

      <div class="selectWrap">
        <span>‚öôÔ∏è</span>
        <select id="preset" aria-label="Modo">
          <option value="home" selected>üè† Home (4 blocos)</option>
          <option value="all">üì¶ Ver tudo (lista)</option>
        </select>
      </div>

      <button class="cta" id="btnGo">‚ö° Atualizar ofertas</button>
    </div>
  </header>

  <div class="hero">
    <div class="heroBox">
      <div>
        <h2>üî• TOP OFERTAS DO DIA</h2>
        <p>Desconto real + frete gr√°tis. Clique e v√° direto pro Mercado Livre.</p>
      </div>
      <a class="heroBtn" href="#top">Ver agora</a>
    </div>
  </div>

  <main>
    <div id="status" class="status"></div>

    <div id="skeleton" class="skeletonGrid" aria-hidden="true">
      <div class="sk"></div><div class="sk"></div><div class="sk"></div><div class="sk"></div>
      <div class="sk"></div><div class="sk"></div><div class="sk"></div><div class="sk"></div>
    </div>

    <!-- HOME: 4 blocos -->
    <section id="homeBlocks" style="display:none;">
      <section id="topBlock">
        <div class="sectionHead">
          <h3 id="top">üî• TOP OFERTAS DO DIA</h3>
          <small id="topCount"></small>
        </div>
        <div class="grid" id="gridTop"></div>
      </section>

      <section id="ate99Block">
        <div class="sectionHead">
          <h3>üí∏ AT√â R$ 99,00</h3>
          <small id="ate99Count"></small>
        </div>
        <div class="grid" id="gridAte99"></div>
      </section>

      <section id="relampagoBlock">
        <div class="sectionHead">
          <h3>‚ö° OFERTAS REL√ÇMPAGO</h3>
          <small class="chip">‚è∞ termina em breve</small>
        </div>
        <div class="grid" id="gridRelampago"></div>
      </section>

      <section id="maisBlock">
        <div class="sectionHead">
          <h3>üß≤ MAIS OFERTAS</h3>
          <small id="maisCount"></small>
        </div>
        <div class="grid" id="gridMais"></div>
      </section>
    </section>

    <!-- LISTA √öNICA -->
    <section class="grid" id="gridAll" style="display:none;"></section>

    <footer>
      <strong>N√£o somos loja oficial.</strong> Apenas divulgamos ofertas do Mercado Livre.
    </footer>
  </main>

  <script defer>
    // ‚úÖ Link da sua planilha (CSV publicado)
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYh-FJUhtB7MT80tKHccZi-z1hTKUOwDqg-tQSR_YPiDOQv-mKmSjTyAtZzmhq8YEchYOjqcVZhJv3/pub?output=csv";

    // ELEMENTOS
    const elStatus = document.getElementById("status");
    const elSkeleton = document.getElementById("skeleton");
    const elPreset = document.getElementById("preset");
    const elQ = document.getElementById("q");
    const elBtnGo = document.getElementById("btnGo");

    const elHome = document.getElementById("homeBlocks");
    const elAll = document.getElementById("gridAll");

    const elTop = document.getElementById("gridTop");
    const elAte99 = document.getElementById("gridAte99");
    const elRelampago = document.getElementById("gridRelampago");
    const elMais = document.getElementById("gridMais");

    const topCount = document.getElementById("topCount");
    const ate99Count = document.getElementById("ate99Count");
    const maisCount = document.getElementById("maisCount");

    let ALL = [];
    let timerIntervalId = null;

    function showStatus(msg, type="info"){
      elStatus.textContent = msg;
      elStatus.className = "status show" + (type==="error" ? " error" : "");
    }
    function hideStatus(){
      elStatus.className = "status";
      elStatus.textContent = "";
    }

    // ---------- PARSERS ----------
    function parsePriceBR(v){
      if(v==null) return NaN;
      const s = String(v).trim();
      if(!s) return NaN;
      const n = s
        .replace(/[R$\s]/g,"")
        .replace(/\./g,"")
        .replace(",",".")
        .replace(/[^0-9.]/g,"");
      const out = Number(n);
      return Number.isFinite(out) ? out : NaN;
    }
    function parseDiscount(v){
      if(v==null) return 0;
      const s = String(v).toLowerCase();
      const m = s.match(/(\d{1,3})\s*%/);
      let p = m ? Number(m[1]) : 0;
      if(!Number.isFinite(p)) p = 0;
      if(p < 0) p = 0;
      if(p > 95) p = 95;
      return p;
    }
    function parseSold(v){
      if(v==null) return 0;
      const s0 = String(v).trim().toLowerCase();
      if(!s0) return 0;
      let s = s0.replace(/\./g,"").replace(/,/g,".");
      const mil = s.match(/([\d.]+)\s*mil/);
      if(mil){
        const n = Number(mil[1]);
        return Number.isFinite(n) ? Math.round(n * 1000) : 0;
      }
      const n = Number(s.replace(/[^0-9.]/g,""));
      return Number.isFinite(n) ? Math.round(n) : 0;
    }
    function parseRating(v){
      if(v==null) return NaN;
      const s = String(v).trim().replace(",",".");
      const n = Number(s);
      return Number.isFinite(n) ? n : NaN;
    }
    function moneyBR(n){
      if(!Number.isFinite(n)) return "";
      return n.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
    }

    // ---------- CSV ----------
    function splitCSVLine(line){
      const out = [];
      let cur = "";
      let inQ = false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(ch === '"'){
          if(inQ && line[i+1] === '"'){ cur += '"'; i++; }
          else inQ = !inQ;
        } else if(ch === "," && !inQ){
          out.push(cur);
          cur = "";
        } else {
          cur += ch;
        }
      }
      out.push(cur);
      return out.map(v => v.trim());
    }
    function parseCSV(text){
      const lines = text.replace(/\r/g,"").split("\n").filter(l=>l.trim().length);
      if(lines.length < 2) return [];
      const header = splitCSVLine(lines[0]).map(h => h.trim().toLowerCase());
      const rows = [];
      for(let i=1;i<lines.length;i++){
        const cols = splitCSVLine(lines[i]);
        const obj = {};
        header.forEach((h,idx)=> obj[h] = cols[idx] ?? "");
        rows.push(obj);
      }
      return rows;
    }

    // Cache local (10 min)
    const CACHE_KEY = "achadinhos_csv_cache_home_v2";
    const CACHE_TTL_MS = 10 * 60 * 1000;

    async function fetchCSVFast(){
      const cached = localStorage.getItem(CACHE_KEY);
      if(cached){
        try{
          const j = JSON.parse(cached);
          if(j.ts && (Date.now() - j.ts) < CACHE_TTL_MS && j.text){
            return j.text;
          }
        }catch(e){}
      }
      const res = await fetch(CSV_URL, { cache: "no-store" });
      if(!res.ok) throw new Error("Falha ao carregar planilha");
      const text = await res.text();
      try{
        localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), text }));
      }catch(e){}
      return text;
    }

    // ---------- NORMALIZA√á√ÉO / DEDUP ----------
    function normalizeProducts(rows){
      const seen = new Set();
      const out = [];

      for(const r of rows){
        const image = (r.image || r.img || "").trim();
        const title = (r.title || r.nome || "").trim();
        const link  = (r.link || r.url || "").trim();

        if(!image || !title || !link) continue;

        const priceFull = parsePriceBR(r.price);
        const discountP = parseDiscount(r.discount);
        const rating = parseRating(r.rating);
        const sold = parseSold(r.sold);

        const priceFinal = (Number.isFinite(priceFull) ? (priceFull * (1 - discountP/100)) : NaN);

        const key = (link || (title+"|"+image)).toLowerCase();
        if(seen.has(key)) continue;
        seen.add(key);

        out.push({
          image, title, link,
          priceFull,
          discountP,
          priceFinal,
          rating,
          sold,
          coupon: (r.coupon || "").trim()
        });
      }
      return out;
    }

    // ---------- TIMER REL√ÇMPAGO (persistente por produto) ----------
    function hashStr(str){
      // hash simples p/ gerar um n√∫mero consistente
      let h = 0;
      for(let i=0;i<str.length;i++){
        h = (h * 31 + str.charCodeAt(i)) >>> 0;
      }
      return h;
    }

    function relampagoKey(link){
      return "rel_end_" + hashStr(link);
    }

    function getRelampagoEnd(link){
      const key = relampagoKey(link);
      const now = Date.now();
      const saved = Number(localStorage.getItem(key) || 0);

      if(saved && saved > now + 1000){
        return saved;
      }

      // gera uma dura√ß√£o ‚Äúrealista‚Äù (45‚Äì120 min) e varia por produto
      const base = 45 * 60 * 1000;
      const extra = (hashStr(link) % (75 * 60 * 1000)); // at√© +75min
      const end = now + base + extra;

      try{ localStorage.setItem(key, String(end)); }catch(e){}
      return end;
    }

    function setRelampagoEnd(link, end){
      const key = relampagoKey(link);
      try{ localStorage.setItem(key, String(end)); }catch(e){}
    }

    function fmtHMS(ms){
      const t = Math.max(0, ms);
      const h = Math.floor(t / 3600000);
      const m = Math.floor((t % 3600000) / 60000);
      const s = Math.floor((t % 60000) / 1000);
      return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");
    }

    function startTimers(){
      // garante 1 intervalo s√≥
      if(timerIntervalId) clearInterval(timerIntervalId);

      const tick = () => {
        const nodes = document.querySelectorAll("[data-timer-end]");
        const now = Date.now();

        nodes.forEach(node=>{
          const end = Number(node.dataset.timerEnd || 0);
          let diff = end - now;

          if(diff <= 0){
            // renova (novo ciclo)
            const link = node.dataset.timerLink || "";
            const base = 45 * 60 * 1000;
            const extra = (hashStr(link + String(now)) % (75 * 60 * 1000));
            const newEnd = Date.now() + base + extra;
            node.dataset.timerEnd = String(newEnd);
            if(link) setRelampagoEnd(link, newEnd);
            diff = newEnd - Date.now();
          }

          node.textContent = fmtHMS(diff);
        });
      };

      tick();
      timerIntervalId = setInterval(tick, 1000);
    }

    // ---------- RENDER ----------
    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function renderCard(p, opts = {}){
      const isRelampago = !!opts.relampago;
      const card = document.createElement("article");
      card.className = "card";

      const soldTxt = p.sold ? (p.sold >= 1000 ? (Math.round(p.sold/1000) + ".000 vendidos") : (p.sold + " vendidos")) : "";
      const discTxt = p.discountP ? (p.discountP + "% OFF") : "";
      const ratingTxt = Number.isFinite(p.rating) ? p.rating.toFixed(1).replace(".",",") : "";

      // timer end (s√≥ no rel√¢mpago)
      const timerEnd = isRelampago ? getRelampagoEnd(p.link) : 0;

      card.innerHTML = `
        <div class="imgWrap">
          <div class="pillRow">
            ${discTxt ? `<span class="pill off">${discTxt}</span>` : `<span></span>`}
            ${p.sold ? `<span class="pill blue">${soldTxt}</span>` : `<span></span>`}
          </div>
          <img src="${escapeHtml(p.image)}" alt="${escapeHtml(p.title)}" loading="lazy" decoding="async" />
        </div>

        <div class="content">
          <div class="title">${escapeHtml(p.title)}</div>

          <div class="meta">
            <div class="metaLeft">
              ${ratingTxt ? `‚≠ê ${ratingTxt}` : ``}
              ${p.coupon ? `‚Ä¢ üéüÔ∏è cupom` : ``}
            </div>

            ${isRelampago ? `
              <div class="timer" title="Oferta rel√¢mpago">
                ‚è∞ <span data-timer-end="${timerEnd}" data-timer-link="${escapeHtml(p.link)}"></span>
              </div>
            ` : ``}
          </div>

          <div class="prices">
            <div>
              ${Number.isFinite(p.priceFull) ? `<div class="old">${moneyBR(p.priceFull)}</div>` : `<div class="old"></div>`}
              ${Number.isFinite(p.priceFinal) ? `<div class="new">${moneyBR(p.priceFinal)}</div>` : `<div class="new"></div>`}
            </div>
            ${p.discountP ? `<div class="offBadge">-${p.discountP}%</div>` : ``}
          </div>

          <a class="btn" href="${escapeHtml(p.link)}" target="_blank" rel="nofollow noopener">Ver oferta</a>
        </div>
      `;
      return card;
    }

    function renderList(container, list, limit, opts = {}){
      container.innerHTML = "";
      const out = (typeof limit === "number") ? list.slice(0, limit) : list;
      out.forEach((p, idx)=>{
        const c = renderCard(p, opts);
        c.style.animationDelay = Math.min(idx * 10, 180) + "ms";
        container.appendChild(c);
      });
      return out.length;
    }

    // ---------- HOME (4 blocos) ----------
    function applyHomeBlocks(){
      const q = elQ.value.trim().toLowerCase();
      let list = [...ALL];

      if(q){
        list = list.filter(p => p.title.toLowerCase().includes(q));
      }

      // 1) TOP OFERTAS DO DIA (6) ‚Äî score por: vendidos + desconto + nota
      const scored = list.map(p=>{
        const score =
          (Math.min((p.sold||0)/100, 200)) +             // vendidos (peso alto)
          ((p.discountP||0) * 2.2) +                      // desconto
          (Number.isFinite(p.rating) ? p.rating * 8 : 0); // rating
        return { p, score };
      }).sort((a,b)=> b.score - a.score).map(x=>x.p);

      const top6 = scored.slice(0, 6);
      const topLinks = new Set(top6.map(x=>x.link));
      const remaining = list.filter(x => !topLinks.has(x.link));

      // 2) AT√â 99 (8)
      const ate99 = remaining
        .filter(p => Number.isFinite(p.priceFinal) && p.priceFinal <= 99)
        .sort((a,b)=> (a.priceFinal||999999) - (b.priceFinal||999999))
        .slice(0, 8);

      const ate99Links = new Set(ate99.map(x=>x.link));
      const remaining2 = remaining.filter(x => !ate99Links.has(x.link));

      // 3) REL√ÇMPAGO (6) ‚Äî maior desconto
      const relampago = remaining2
        .slice()
        .sort((a,b)=> (b.discountP||0) - (a.discountP||0))
        .slice(0, 6);

      const relLinks = new Set(relampago.map(x=>x.link));
      const remaining3 = remaining2.filter(x => !relLinks.has(x.link));

      // 4) MAIS OFERTAS (15) ‚Äî resto organizado
      const mais = remaining3
        .slice()
        .sort((a,b)=> (b.sold||0) - (a.sold||0))
        .slice(0, 15);

      const nTop = renderList(elTop, top6, undefined, { relampago:false });
      const nAte = renderList(elAte99, ate99, undefined, { relampago:false });
      const nRel = renderList(elRelampago, relampago, undefined, { relampago:true });
      const nMais = renderList(elMais, mais, undefined, { relampago:false });

      topCount.textContent = nTop ? `${nTop} destaques` : ``;
      ate99Count.textContent = nAte ? `${nAte} ofertas` : ``;
      maisCount.textContent = nMais ? `${nMais} op√ß√µes` : ``;

      // esconder bloco se vazio
      document.getElementById("ate99Block").style.display = nAte ? "" : "none";
      document.getElementById("relampagoBlock").style.display = nRel ? "" : "none";
      document.getElementById("maisBlock").style.display = nMais ? "" : "none";

      // liga timers (somente se tiver rel√¢mpago renderizado)
      startTimers();
    }

    // ---------- ALL (lista √∫nica) ----------
    function applyAll(){
      const q = elQ.value.trim().toLowerCase();
      let list = [...ALL];
      if(q) list = list.filter(p => p.title.toLowerCase().includes(q));
      list.sort((a,b)=> (b.sold||0) - (a.sold||0));
      renderList(elAll, list, 30, { relampago:false });
      startTimers(); // ok chamar ‚Äî se n√£o tiver timer, n√£o muda nada
    }

    function applyView(){
      const mode = elPreset.value; // home | all
      if(mode === "all"){
        elHome.style.display = "none";
        elAll.style.display = "grid";
        applyAll();
      }else{
        elAll.style.display = "none";
        elHome.style.display = "block";
        applyHomeBlocks();
      }
    }

    // ---------- INIT ----------
    async function init(){
      hideStatus();
      elSkeleton.style.display = "grid";
      elHome.style.display = "none";
      elAll.style.display = "none";

      try{
        const text = await fetchCSVFast();
        const rows = parseCSV(text);
        ALL = normalizeProducts(rows);

        if(!ALL.length){
          showStatus("A planilha carregou, mas n√£o achei produtos v√°lidos. Verifique colunas: image, title, price, discount, sold, rating, link.", "error");
          elSkeleton.style.display = "none";
          return;
        }

        elSkeleton.style.display = "none";
        applyView();
      }catch(err){
        elSkeleton.style.display = "none";
        showStatus("N√£o carregou as ofertas: " + (err?.message || "Failed to fetch") + ". Verifique se o CSV est√° p√∫blico e se o link est√° correto.", "error");
      }
    }

    // EVENTOS
    elBtnGo.addEventListener("click", () => {
      applyView();
      window.scrollTo({ top: document.querySelector("main").offsetTop - 10, behavior: "smooth" });
    });

    let t;
    elQ.addEventListener("input", () => {
      clearTimeout(t);
      t = setTimeout(applyView, 150);
    });

    elPreset.addEventListener("change", applyView);

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
