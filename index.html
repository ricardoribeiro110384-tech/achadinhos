<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Achadinhos do Dia</title>
  <link rel="icon" href="logo.png" />
  <style>
    :root{
      --yellow:#f5c400;
      --yellow2:#ffdb3a;
      --bg:#f4f4f4;
      --card:#ffffff;
      --text:#111;
      --muted:#666;
      --shadow: 0 12px 30px rgba(0,0,0,.10);
      --radius: 18px;
      --danger:#c40000;
      --chip:#0a0a0a;
      --blue:#1b75ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    a{color:inherit}

    header{
      background:linear-gradient(180deg,var(--yellow2),var(--yellow));
      padding:16px;
      position:sticky;top:0;z-index:10;
      box-shadow: 0 6px 18px rgba(0,0,0,.10);
    }
    .wrap{max-width:1040px;margin:0 auto}
    .brandRow{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .logo{
      width:42px;height:42px;border-radius:14px;background:#fff;
      display:grid;place-items:center;overflow:hidden;flex:0 0 auto;
      box-shadow: 0 10px 24px rgba(0,0,0,.12);
    }
    .logo img{width:100%;height:100%;object-fit:contain;padding:6px}
    .titleBox{flex:1 1 auto;min-width:220px}
    h1{margin:0;font-size:24px;line-height:1.1}
    .sub{margin:6px 0 0;color:rgba(0,0,0,.72);font-weight:800;font-size:13px}

    /* HOME */
    .home{padding:18px 16px 28px}
    .gridHome{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:14px;
    }
    @media (min-width:720px){
      .gridHome{grid-template-columns:repeat(3,minmax(0,1fr));gap:16px}
    }
    .block{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      position:relative;
      min-height:118px;
      cursor:pointer;
      user-select:none;
    }
    .emoji{font-size:22px}
    .bt{margin:10px 0 0;font-size:17px;font-weight:1000}
    .bd{margin:6px 0 0;color:var(--muted);font-weight:650;font-size:13px;line-height:1.25}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background:rgba(0,0,0,.06);font-weight:1000;font-size:12px;
      margin-top:12px;
    }
    .arrow{
      position:absolute;right:14px;bottom:12px;
      width:40px;height:40px;border-radius:999px;
      background:#111;color:#fff;display:grid;place-items:center;
      font-size:18px;
      box-shadow: 0 12px 26px rgba(0,0,0,.18);
    }

    /* OFERTAS */
    .offers{padding:14px 16px 28px; display:none;}
    .controls{display:grid;gap:10px;margin-top:12px}
    @media(min-width:860px){
      .controls{grid-template-columns: 1fr 280px 140px;align-items:center}
    }
    .search{
      background:#fff;border-radius:999px;padding:12px 14px;
      display:flex;gap:10px;align-items:center;
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
    }
    .search input{border:0;outline:0;width:100%;font-size:15px}
    .select{
      background:#fff;border-radius:999px;padding:10px 12px;
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
    }
    .select select{
      width:100%;border:0;outline:0;background:transparent;font-weight:1000;font-size:14px;
    }
    .btn{
      background:#111;color:#fff;border:0;border-radius:999px;
      padding:12px 14px;font-weight:1000;cursor:pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      white-space:nowrap;
    }

    /* Atalhos */
    .quickBar{
      margin-top:10px;
      display:flex;
      gap:10px;
      overflow:auto;
      padding-bottom:6px;
      -webkit-overflow-scrolling:touch;
    }
    .qbtn{
      flex:0 0 auto;
      border:0;
      cursor:pointer;
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      font-weight:1000;
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
      white-space:nowrap;
    }
    .qbtn.active{outline:3px solid rgba(0,0,0,.12)}

    .timerBar{
      display:none;
      margin-top:10px;
      background:rgba(0,0,0,.06);
      border-radius:14px;
      padding:10px 12px;
      font-weight:1000;
      color:#111;
    }
    .timerBar.show{display:block}
    .timer{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .timer strong{font-size:14px}
    .timer span{font-variant-numeric:tabular-nums;font-size:14px}

    .state{padding:12px 0;color:#111;font-weight:1000}
    .err{
      background:#ffe6e6;border:1px solid #ffb0b0;border-radius:14px;
      padding:12px 14px;color:#7a0000;font-weight:1000;
      margin:10px 0 0;
    }

    /* Cards (inteiro clic√°vel) */
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns:repeat(1,minmax(0,1fr));
      gap:14px;
    }
    @media(min-width:640px){ .grid{grid-template-columns:repeat(2,minmax(0,1fr));} }
    @media(min-width:980px){ .grid{grid-template-columns:repeat(3,minmax(0,1fr));} }

    .cardLink{
      text-decoration:none;
      color:inherit;
      display:block;
    }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;flex-direction:column;
      min-height: 420px;
    }
    .imgWrap{
      background:#fff;
      height: 250px;
      display:grid;place-items:center;
      position:relative;
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    .imgWrap img{
      width:100%;
      height:100%;
      object-fit:contain;
      padding:10px;
    }
    .chipRow{
      position:absolute;left:10px;top:10px;display:flex;gap:8px;flex-wrap:wrap;
    }
    .chip{
      background:var(--chip);color:#fff;font-weight:1000;font-size:12px;
      padding:6px 10px;border-radius:999px;
      box-shadow: 0 10px 22px rgba(0,0,0,.16);
    }
    .chip.blue{background:var(--blue)}
    .body{padding:14px 14px 14px;display:flex;flex-direction:column;gap:10px;flex:1}
    .t{font-weight:1000;font-size:16px;line-height:1.2}
    .meta{display:flex;gap:10px;align-items:center;color:var(--muted);font-weight:1000}
    .star{color:#f0b400}
    .prices{display:flex;align-items:flex-end;justify-content:space-between;gap:10px}
    .full{color:#777;text-decoration:line-through;font-weight:900}
    .final{color:var(--danger);font-weight:1000;font-size:30px;letter-spacing:-.5px}
    .badgeOff{
      background:#111;color:#fff;border-radius:999px;
      padding:8px 12px;font-weight:1000;
    }

    /* Load more */
    .loadMoreWrap{
      margin-top:14px;
      display:flex;
      justify-content:center;
    }

    footer{
      margin-top:18px;
      padding:14px 16px 22px;
      color:#fff;background:#111;text-align:center;font-weight:900;
    }
    footer small{display:block;color:rgba(255,255,255,.72);font-weight:700;margin-top:6px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brandRow">
        <div class="logo"><img src="logo.png" alt="Achadinhos" /></div>
        <div class="titleBox">
          <h1 id="hdrTitle">üî• Achadinhos do Dia</h1>
          <div class="sub" id="hdrSub">Ofertas do Mercado Livre que realmente valem a pena</div>
        </div>
      </div>

      <!-- controles aparecem s√≥ em OFERTAS -->
      <div class="controls wrap" id="controls" style="display:none;">
        <div class="search">
          <span>üîé</span>
          <input id="q" type="search" placeholder="Buscar produto..." autocomplete="off" />
        </div>

        <div class="select">
          <select id="preset">
            <option value="dia">‚ö° Ofertas do dia</option>
            <option value="flash">‚è±Ô∏è Oferta rel√¢mpago</option>
            <option value="mais">üõí Mais pedidos</option>
            <option value="ate99">üí∏ At√© R$ 99,00</option>
            <option value="tudo">üìã Ver tudo</option>
          </select>
        </div>

        <button class="btn" id="btnHome">‚Üê Home</button>
      </div>

      <div class="quickBar wrap" id="quickBar" style="display:none;">
        <button class="qbtn" data-k="dia">‚ö° Dia</button>
        <button class="qbtn" data-k="flash">‚è±Ô∏è Rel√¢mpago</button>
        <button class="qbtn" data-k="mais">üõí Mais pedidos</button>
        <button class="qbtn" data-k="ate99">üí∏ At√© 99</button>
        <button class="qbtn" data-k="tudo">üìã Ver tudo</button>
      </div>

      <div class="timerBar wrap" id="timerBar">
        <div class="timer">
          <strong>‚è±Ô∏è Oferta rel√¢mpago termina em:</strong>
          <span id="timerTxt">--:--:--</span>
        </div>
      </div>
    </div>
  </header>

  <!-- HOME -->
  <section class="home wrap" id="home">
    <div class="gridHome">
      <div class="block" data-b="dia">
        <div class="emoji">‚ö°</div>
        <div class="bt">Ofertas do dia</div>
        <div class="bd">Sele√ß√£o (sem repetir)</div>
        <div class="pill">Abrir</div>
        <div class="arrow">‚Ä∫</div>
      </div>

      <div class="block" data-b="flash">
        <div class="emoji">‚è±Ô∏è</div>
        <div class="bt">Oferta rel√¢mpago</div>
        <div class="bd">Maiores descontos (sem repetir)</div>
        <div class="pill">Abrir</div>
        <div class="arrow">‚Ä∫</div>
      </div>

      <div class="block" data-b="mais">
        <div class="emoji">üõí</div>
        <div class="bt">Mais pedidos</div>
        <div class="bd">Mais vendidos (sem repetir)</div>
        <div class="pill">Abrir</div>
        <div class="arrow">‚Ä∫</div>
      </div>

      <div class="block" data-b="ate99">
        <div class="emoji">üí∏</div>
        <div class="bt">At√© R$ 99,00</div>
        <div class="bd">Baratinhos (sem repetir)</div>
        <div class="pill">Abrir</div>
        <div class="arrow">‚Ä∫</div>
      </div>

      <div class="block" data-b="tudo">
        <div class="emoji">üìã</div>
        <div class="bt">Ver tudo</div>
        <div class="bd">Todos os produtos da planilha</div>
        <div class="pill">Abrir</div>
        <div class="arrow">‚Ä∫</div>
      </div>
    </div>
  </section>

  <!-- OFERTAS -->
  <section class="offers wrap" id="offers">
    <div class="state" id="state">Carregando ofertas‚Ä¶</div>
    <div id="errBox"></div>
    <div class="grid" id="grid"></div>

    <div class="loadMoreWrap">
      <button class="btn" id="loadMore" style="display:none;">Carregar mais</button>
    </div>
  </section>

  <footer>
    N√£o somos loja oficial. Apenas divulgamos ofertas do Mercado Livre.
    <small>Os pre√ßos podem mudar a qualquer momento no site do Mercado Livre.</small>
  </footer>

<script defer>
  /* SUA PLANILHA CSV */
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYh-FJUhtB7MT80tKHccZi-z1hTKUOwDqg-tQSR_YPiDOQv-mKmSjTyAtZzmhq8YEchYOjqcVZhJv3/pub?output=csv";

  /* Quantos itens em cada bloco (sem repetir) */
  const PICK = { flash: 8, dia: 12, mais: 8, ate99: 8 };

  /* ‚ÄúVer tudo‚Äù paginado */
  const PAGE_SIZE = 24;

  const TITLES = {
    dia:"‚ö° Ofertas do dia",
    flash:"‚è±Ô∏è Oferta rel√¢mpago",
    mais:"üõí Mais pedidos",
    ate99:"üí∏ At√© R$ 99,00",
    tudo:"üìã Ver tudo"
  };

  const $ = (id)=>document.getElementById(id);

  let ALL = [];
  let CURRENT = "dia";

  let BUCKETS = { flash:[], dia:[], mais:[], ate99:[], all:[] };

  let shownCount = PAGE_SIZE; // usado s√≥ no "tudo"

  /* Timer rel√¢mpago */
  const FLASH_WINDOW_MIN = 30;
  let timerInt = null;

  function parsePriceBR(v){
    const s = String(v ?? "").trim();
    if(!s) return NaN;
    const clean = s.replace(/\./g,"").replace(",",".");
    const n = Number(clean);
    return isFinite(n) ? n : NaN;
  }
  function getDiscountPct(row){
    const s = String(row.discount ?? "").toUpperCase();
    const m = s.match(/(\d+(\.\d+)?)/);
    return m ? Number(m[1]) : 0;
  }
  function parseSold(v){
    const s = String(v ?? "").trim().toLowerCase().replace(/\./g,"").replace(",",".");
    if(!s) return 0;
    if (s.includes("mil")) {
      const n = parseFloat(s.replace("mil","").trim());
      return isNaN(n) ? 0 : Math.round(n*1000);
    }
    const n = parseFloat(s);
    return isNaN(n) ? 0 : Math.round(n);
  }
  function moneyBR(n){
    if(!isFinite(n)) return "";
    return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  }
  function calcFinal(row){
    const full = parsePriceBR(row.price);
    const pct = getDiscountPct(row);
    if(!isFinite(full) || full<=0) return NaN;
    return Math.max(0, full * (1 - pct/100));
  }

  function parseCSV(text){
    const lines = text.replace(/\r/g,"").split("\n").filter(Boolean);
    const headers = lines.shift().split(",").map(h=>h.trim());
    return lines.map(line=>{
      // CSV simples (funciona bem se t√≠tulo n√£o tiver v√≠rgula)
      const cols = line.split(",");
      const obj = {};
      headers.forEach((h,i)=> obj[h]= (cols[i] ?? "").trim());
      obj.fullPrice = parsePriceBR(obj.price);
      obj.discountPct = getDiscountPct(obj);
      obj.finalPrice = calcFinal(obj);
      obj.soldNum = parseSold(obj.sold);
      return obj;
    }).filter(r=>r.link && r.image && r.title);
  }

  function scoreDia(r){
    return (r.discountPct * 3) + Math.log10((r.soldNum || 0) + 1);
  }

  function buildBuckets(){
    // dedupe por link
    const seen = new Set();
    const base = [];
    for(const r of ALL){
      const k = String(r.link||"").trim();
      if(!k || seen.has(k)) continue;
      seen.add(k);
      base.push(r);
    }

    const used = new Set();
    const take = (arr, n, filterFn = ()=>true) => {
      const out = [];
      for(const x of arr){
        const k = String(x.link||"").trim();
        if(!k || used.has(k)) continue;
        if(!filterFn(x)) continue;
        out.push(x);
        used.add(k);
        if(out.length >= n) break;
      }
      return out;
    };

    const byDiscount = [...base].sort((a,b)=> (b.discountPct - a.discountPct) || (b.soldNum - a.soldNum));
    const byDia = [...base].sort((a,b)=> (scoreDia(b) - scoreDia(a)));
    const bySold = [...base].sort((a,b)=> (b.soldNum - a.soldNum) || (b.discountPct - a.discountPct));
    const byCheap = [...base].filter(x => isFinite(x.finalPrice)).sort((a,b)=> a.finalPrice - b.finalPrice);

    const flash = take(byDiscount, PICK.flash);
    const dia   = take(byDia,      PICK.dia);
    const mais  = take(bySold,     PICK.mais);
    const ate99 = take(byCheap,    PICK.ate99, (x)=> isFinite(x.finalPrice) && x.finalPrice <= 99);

    BUCKETS = { flash, dia, mais, ate99, all: base };
  }

  function setActiveQuick(blockKey){
    document.querySelectorAll("#quickBar .qbtn").forEach(b=>{
      b.classList.toggle("active", b.getAttribute("data-k") === blockKey);
    });
  }

  function stopFlashTimer(){
    if(timerInt){ clearInterval(timerInt); timerInt = null; }
  }
  function startFlashTimer(){
    stopFlashTimer();
    function tick(){
      const now = new Date();
      const minutes = now.getMinutes();
      const blockStart = Math.floor(minutes / FLASH_WINDOW_MIN) * FLASH_WINDOW_MIN;
      const end = new Date(now);
      end.setMinutes(blockStart + FLASH_WINDOW_MIN);
      end.setSeconds(0); end.setMilliseconds(0);

      let diff = end - now;
      if(diff <= 0){
        applyBlock("flash");
        return;
      }
      const h = String(Math.floor(diff/3600000)).padStart(2,"0");
      diff %= 3600000;
      const m = String(Math.floor(diff/60000)).padStart(2,"0");
      diff %= 60000;
      const s = String(Math.floor(diff/1000)).padStart(2,"0");
      $("timerTxt").textContent = `${h}:${m}:${s}`;
    }
    tick();
    timerInt = setInterval(tick, 1000);
  }

  function getCurrentBaseList(blockKey){
    if(blockKey === "flash") return BUCKETS.flash;
    if(blockKey === "dia")   return BUCKETS.dia;
    if(blockKey === "mais")  return BUCKETS.mais;
    if(blockKey === "ate99") return BUCKETS.ate99;
    if(blockKey === "tudo")  return BUCKETS.all; // ‚úÖ ver tudo mostra TODOS
    return BUCKETS.dia;
  }

  function applySearch(list){
    const q = $("q").value.trim().toLowerCase();
    if(!q) return list;
    return list.filter(r => String(r.title).toLowerCase().includes(q));
  }

  function getDisplayList(blockKey){
    const base = applySearch(getCurrentBaseList(blockKey));
    if(blockKey !== "tudo") return base; // blocos fixos
    // ‚úÖ ‚Äútudo‚Äù paginado
    return base.slice(0, shownCount);
  }

  function render(items){
    const grid = $("grid");
    grid.innerHTML = "";
    if(!items.length){
      grid.innerHTML = `<div class="err">Nenhum produto encontrado.</div>`;
      return;
    }
    const frag = document.createDocumentFragment();

    items.forEach(r=>{
      const off = r.discountPct ? `${Math.round(r.discountPct)}% OFF` : "OFERTA";
      const soldTxt = r.soldNum ? `${r.soldNum.toLocaleString("pt-BR")} vendidos` : "";
      const ratingTxt = r.rating ? String(r.rating).replace(".",",") : "‚Äî";

      const a = document.createElement("a");
      a.className = "cardLink";
      a.href = r.link;
      a.target = "_blank";
      a.rel = "noopener";

      a.innerHTML = `
        <article class="card">
          <div class="imgWrap">
            <div class="chipRow">
              <div class="chip">${off}</div>
              ${soldTxt ? `<div class="chip blue">${soldTxt}</div>` : ``}
            </div>
            <img loading="lazy" src="${r.image}" alt="${(r.title||"").replace(/"/g,"")}" />
          </div>
          <div class="body">
            <div class="t">${r.title}</div>
            <div class="meta"><span class="star">‚≠ê</span><span>${ratingTxt}</span></div>
            <div class="prices">
              <div>
                <div class="full">${isFinite(r.fullPrice) ? moneyBR(r.fullPrice) : ""}</div>
                <div class="final">${isFinite(r.finalPrice) ? moneyBR(r.finalPrice) : ""}</div>
              </div>
              <div class="badgeOff">-${Math.round(r.discountPct)}%</div>
            </div>
          </div>
        </article>
      `;
      frag.appendChild(a);
    });

    grid.appendChild(frag);
  }

  function updateLoadMore(){
    const btn = $("loadMore");
    if(!btn) return;

    if(CURRENT !== "tudo"){
      btn.style.display = "none";
      return;
    }

    const totalAfterSearch = applySearch(BUCKETS.all).length;
    btn.style.display = (shownCount < totalAfterSearch) ? "" : "none";
  }

  function applyBlock(blockKey){
    CURRENT = blockKey;
    $("preset").value = blockKey;
    setActiveQuick(blockKey);

    $("hdrTitle").textContent = TITLES[blockKey] || "Ofertas";
    $("hdrSub").textContent = "Toque no produto para abrir no Mercado Livre";

    if(blockKey === "flash"){
      $("timerBar").classList.add("show");
      startFlashTimer();
    } else {
      $("timerBar").classList.remove("show");
      stopFlashTimer();
    }

    const list = getDisplayList(blockKey);
    const totalBase = applySearch(getCurrentBaseList(blockKey)).length;

    $("state").textContent =
      (blockKey === "tudo")
        ? `Mostrando ${list.length} de ${totalBase} itens`
        : `Itens exibidos: ${list.length}`;

    render(list);
    updateLoadMore();
    window.scrollTo({top:0,behavior:"smooth"});
  }

  function showHome(){
    $("home").style.display = "";
    $("offers").style.display = "none";
    $("controls").style.display = "none";
    $("quickBar").style.display = "none";
    $("timerBar").classList.remove("show");
    stopFlashTimer();

    $("hdrTitle").textContent = "üî• Achadinhos do Dia";
    $("hdrSub").textContent = "Ofertas do Mercado Livre que realmente valem a pena";
  }

  function showOffers(blockKey){
    $("home").style.display = "none";
    $("offers").style.display = "block";
    $("controls").style.display = "grid";
    $("quickBar").style.display = "flex";
    $("q").value = "";
    $("errBox").innerHTML = "";

    shownCount = PAGE_SIZE; // reset pagina√ß√£o ao entrar
    applyBlock(blockKey || "dia");
  }

  async function load(){
    try{
      const res = await fetch(CSV_URL, { cache:"no-store" });
      if(!res.ok) throw new Error("Falha ao buscar planilha");
      const text = await res.text();
      ALL = parseCSV(text);
      if(!ALL.length) throw new Error("Planilha vazia ou colunas incompat√≠veis");
      buildBuckets();
    } catch(e){
      $("errBox").innerHTML = `<div class="err">N√£o carregou as ofertas: ${String(e.message||e)}</div>`;
    }
  }

  document.addEventListener("DOMContentLoaded", async ()=>{
    await load();

    document.querySelectorAll(".block").forEach(el=>{
      el.addEventListener("click", ()=>{
        const b = el.getAttribute("data-b") || "dia";
        showOffers(b);
      });
    });

    document.querySelectorAll("#quickBar .qbtn").forEach(el=>{
      el.addEventListener("click", ()=>{
        const k = el.getAttribute("data-k") || "dia";
        shownCount = PAGE_SIZE; // reset ao trocar de bloco
        applyBlock(k);
      });
    });

    $("preset").addEventListener("change", ()=>{
      shownCount = PAGE_SIZE;
      applyBlock($("preset").value);
    });

    $("btnHome").addEventListener("click", showHome);

    // Busca (funciona em qualquer bloco; em "tudo" respeita load more)
    let t=null;
    $("q").addEventListener("input", ()=>{
      clearTimeout(t);
      t=setTimeout(()=>{
        shownCount = PAGE_SIZE; // reset pagina√ß√£o ao buscar
        applyBlock(CURRENT);
      }, 180);
    });

    // Load more (s√≥ no "tudo")
    $("loadMore").addEventListener("click", ()=>{
      shownCount += PAGE_SIZE; // +24
      applyBlock("tudo");
    });

    showHome();
  });
</script>
</body>
</html>
