<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#f6c400" />
  <title>Achadinhos do Dia</title>

  <style>
    :root{
      --amarelo:#f6c400;
      --preto:#111;
      --cinza:#f3f3f3;
      --card:#fff;
      --borda:#e7e7e7;
      --muted:#6b7280;
      --laranja:#ff6a00;
      --vermelho:#c40000;
      --radius:18px;
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--cinza);color:#111}
    .wrap{max-width:1100px;margin:0 auto}
    header{
      background:var(--amarelo);
      padding:18px 14px 16px;
      border-bottom:1px solid rgba(0,0,0,.08);
    }
    .top{display:flex;align-items:center;gap:12px}
    .logo{
      width:42px;height:42px;border-radius:12px;background:#fff;
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;border:1px solid rgba(0,0,0,.1);flex:0 0 auto;
    }
    .logo img{width:100%;height:100%;object-fit:contain}
    .brand h1{margin:0;font-size:28px;line-height:1.05}
    .brand p{margin:6px 0 0;color:rgba(0,0,0,.75);font-weight:700}

    .controls{
      margin-top:14px;
      display:grid;
      grid-template-columns:1fr 260px 170px;
      gap:10px;
    }
    @media (max-width:820px){
      .controls{grid-template-columns:1fr 1fr;}
      .controls .cta{grid-column:1 / -1;}
    }

    .searchWrap,.selectWrap{
      background:#fff;border:1px solid rgba(0,0,0,.1);
      border-radius:999px;display:flex;align-items:center;gap:10px;
      padding:10px 14px;
    }
    .searchWrap span,.selectWrap .icon{opacity:.65}
    .searchWrap input{
      border:0;outline:0;width:100%;
      font-size:15px;background:transparent
    }
    .selectWrap{padding:8px 12px}
    .selectWrap select{
      width:100%;
      border:0;outline:0;background:transparent;
      font-size:15px;font-weight:800;color:#111;
      appearance:none;
    }

    .cta button{
      width:100%;
      border:0;cursor:pointer;
      background:var(--preto);color:#fff;
      border-radius:999px;
      padding:12px 14px;
      font-weight:900;font-size:15px;
      box-shadow:0 10px 22px rgba(0,0,0,.16);
    }

    main{padding:16px 14px 70px}
    .sectionTitle{
      display:flex;align-items:flex-end;justify-content:space-between;
      gap:10px;margin:18px 0 10px;
    }
    .sectionTitle h2{margin:0;font-size:22px}
    .sectionTitle small{color:var(--muted);font-weight:800}

    .grid{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:12px;
    }
    @media (max-width:980px){ .grid{grid-template-columns:repeat(3,1fr)} }
    @media (max-width:720px){ .grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:420px){ .grid{grid-template-columns:1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--borda);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:0 8px 18px rgba(0,0,0,.06);
      display:flex;flex-direction:column;
      min-height:100%;
    }
    .imgWrap{position:relative;background:#fff}
    .imgWrap img{
      width:100%;height:220px;object-fit:contain;display:block;
      background:#fff;
    }
    .pill{
      position:absolute;top:10px;left:10px;
      background:#0b0b0b;color:#fff;
      padding:6px 10px;border-radius:999px;
      font-weight:900;font-size:12px;
    }
    .pill2{
      position:absolute;top:10px;right:10px;
      background:#1f5eff;color:#fff;
      padding:6px 10px;border-radius:999px;
      font-weight:900;font-size:12px;
      max-width:70%;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .body{padding:12px 12px 10px;display:flex;flex-direction:column;gap:8px}
    .title{
      margin:0;font-size:14px;line-height:1.25;font-weight:900;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
      min-height:36px;
    }
    .meta{display:flex;gap:10px;align-items:center;color:var(--muted);font-weight:800}
    .priceRow{display:flex;align-items:flex-end;justify-content:space-between;gap:10px}
    .old{
      color:#9ca3af;text-decoration:line-through;font-weight:900;
      font-size:14px;
    }
    .new{
      color:var(--vermelho);font-weight:1000;font-size:26px;letter-spacing:-.4px;
    }
    .badgeOff{
      background:#111;color:#fff;border-radius:999px;
      padding:6px 10px;font-weight:1000;font-size:12px;white-space:nowrap;
    }
    .btn{
      margin:10px 12px 12px;
      border:0;cursor:pointer;
      background:var(--laranja);color:#fff;
      border-radius:14px;
      padding:12px;
      font-weight:1000;font-size:15px;
    }

    .listMode .grid{grid-template-columns:1fr}
    .listMode .card{flex-direction:row;align-items:stretch}
    .listMode .imgWrap img{height:170px;min-width:220px;max-width:220px}
    @media (max-width:650px){
      .listMode .card{flex-direction:column}
      .listMode .imgWrap img{min-width:auto;max-width:none;height:220px}
    }

    .skeleton{
      background:linear-gradient(90deg,#eee,#f7f7f7,#eee);
      background-size:200% 100%;
      animation:shimmer 1.1s infinite;
      border-radius:16px;
      height:320px;
      border:1px solid var(--borda);
    }
    @keyframes shimmer{
      0%{background-position:200% 0}
      100%{background-position:-200% 0}
    }

    footer{
      margin-top:26px;
      background:#111;color:#fff;
      padding:18px 14px;
      text-align:center;
      font-weight:700;
      opacity:.92;
    }
    footer small{display:block;opacity:.85;margin-top:6px;font-weight:600}
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="top">
        <div class="logo" title="Achadinhos">
          <img src="logo.png" alt="Logo Achadinhos" />
        </div>
        <div class="brand">
          <h1>üî• Achadinhos do Dia</h1>
          <p>Ofertas do Mercado Livre que realmente valem a pena</p>
        </div>
      </div>

      <div class="controls">
        <div class="searchWrap">
          <span>üîé</span>
          <input id="q" type="search" placeholder="Buscar produto..." autocomplete="off" />
        </div>

        <!-- ‚úÖ AQUI √© o seletor de BLOCOS -->
        <div class="selectWrap">
          <span class="icon">‚öôÔ∏è</span>
          <select id="viewSelect" aria-label="Selecionar bloco">
            <option value="home" selected>üè† Home (4 blocos)</option>
            <option value="day">‚ö° Achadinhos do Dia</option>
            <option value="under99">üí∏ At√© R$ 99</option>
            <option value="most">üõí Mais pedidos</option>
            <option value="flash">‚ö° Oferta rel√¢mpago</option>
            <option value="list">üì¶ Ver tudo (lista)</option>
          </select>
        </div>

        <div class="cta">
          <button id="goBtn">‚ö° Ver ofertas</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap" id="main">
    <div id="loadingGrid" class="grid"></div>

    <!-- BLOCOS -->
    <section id="sec-day">
      <div class="sectionTitle">
        <h2>‚ö° Achadinhos do Dia</h2>
        <small id="count-day"></small>
      </div>
      <div class="grid" id="grid-day"></div>
    </section>

    <section id="sec-under99">
      <div class="sectionTitle">
        <h2>üí∏ At√© R$ 99,00</h2>
        <small id="count-99"></small>
      </div>
      <div class="grid" id="grid-99"></div>
    </section>

    <section id="sec-most">
      <div class="sectionTitle">
        <h2>üõí Mais pedidos</h2>
        <small id="count-most"></small>
      </div>
      <div class="grid" id="grid-most"></div>
    </section>

    <section id="sec-flash">
      <div class="sectionTitle">
        <h2>‚ö° Oferta rel√¢mpago</h2>
        <small id="count-flash"></small>
      </div>
      <div class="grid" id="grid-flash"></div>
    </section>

    <footer>
      N√£o somos loja oficial. Apenas divulgamos ofertas do Mercado Livre.
      <small>Pre√ßos e disponibilidade podem mudar a qualquer momento.</small>
    </footer>
  </main>

  <script defer>
    // ‚úÖ SEU CSV PUBLICADO
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYh-FJUhtB7MT80tKHccZi-z1hTKUOwDqg-tQSR_YPiDOQv-mKmSjTyAtZzmhq8YEchYOjqcVZhJv3/pub?output=csv";

    const els = {
      q: document.getElementById("q"),
      viewSelect: document.getElementById("viewSelect"),
      goBtn: document.getElementById("goBtn"),
      main: document.getElementById("main"),
      loadingGrid: document.getElementById("loadingGrid"),
      gridDay: document.getElementById("grid-day"),
      grid99: document.getElementById("grid-99"),
      gridMost: document.getElementById("grid-most"),
      gridFlash: document.getElementById("grid-flash"),
      cDay: document.getElementById("count-day"),
      c99: document.getElementById("count-99"),
      cMost: document.getElementById("count-most"),
      cFlash: document.getElementById("count-flash"),
      secDay: document.getElementById("sec-day"),
      sec99: document.getElementById("sec-under99"),
      secMost: document.getElementById("sec-most"),
      secFlash: document.getElementById("sec-flash"),
    };

    // Skeletons
    (function showSkeletons(){
      els.loadingGrid.innerHTML = "";
      for(let i=0;i<8;i++){
        const d = document.createElement("div");
        d.className="skeleton";
        els.loadingGrid.appendChild(d);
      }
    })();

    function parseCSV(text){
      // CSV simples (funciona bem com Google Sheets publicado)
      const rows = [];
      let cur = "", inQ = false;
      const lines = [];
      for(let i=0;i<text.length;i++){
        const ch = text[i], next = text[i+1];
        if(ch === '"' && next === '"'){ cur += '"'; i++; continue; }
        if(ch === '"'){ inQ = !inQ; continue; }
        if(ch === '\n' && !inQ){ lines.push(cur); cur=""; continue; }
        cur += ch;
      }
      if(cur) lines.push(cur);

      const split = (line)=>{
        const out=[]; let c=""; let q=false;
        for(let i=0;i<line.length;i++){
          const ch=line[i], next=line[i+1];
          if(ch === '"' && next === '"'){ c+='"'; i++; continue; }
          if(ch === '"'){ q=!q; continue; }
          if(ch === ',' && !q){ out.push(c); c=""; continue; }
          c+=ch;
        }
        out.push(c);
        return out.map(v=>v.trim());
      };

      const header = split(lines[0] || "").map(h=>h.toLowerCase());
      for(let i=1;i<lines.length;i++){
        const cols = split(lines[i]);
        if(cols.every(v=>v==="")) continue;
        const obj = {};
        header.forEach((h,idx)=> obj[h] = (cols[idx] ?? "").trim());
        rows.push(obj);
      }
      return rows;
    }

    function toNumberBR(v){
      if(v==null) return 0;
      const s = String(v).trim();
      if(!s) return 0;
      // aceita "287,12" ou "287.12"
      const norm = s.replace(/\./g,"").replace(",",".").replace(/[^\d.]/g,"");
      const n = Number(norm);
      return Number.isFinite(n) ? n : 0;
    }

    function discountToPct(discount){
      // aceita "53% OFF", "53%", "0.53" etc
      const s = String(discount||"").toUpperCase();
      const m = s.match(/(\d{1,3})\s*%/);
      if(m) return Math.min(99, Math.max(0, Number(m[1])));
      const n = Number(String(discount).replace(",","."));
      if(Number.isFinite(n) && n > 0 && n < 1) return Math.round(n*100);
      return 0;
    }

    function formatBRL(n){
      return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    }

    function sanitizeSold(s){
      // exemplos: "10 MIL", "1000", "1.000", "100 mil"
      const t = String(s||"").toLowerCase().replace(/\./g,"").trim();
      if(!t) return 0;
      const m = t.match(/(\d+)\s*(mil|k)/);
      if(m) return Number(m[1]) * 1000;
      const mm = t.match(/(\d+)\s*(m|mi|milh|milhao|milh√£o)/);
      if(mm) return Number(mm[1]) * 1000000;
      const num = Number(t.replace(/[^\d]/g,""));
      return Number.isFinite(num) ? num : 0;
    }

    function makeCard(p){
      const title = p.title || "";
      const img = p.image || "";
      const link = p.link || "#";

      const priceFull = toNumberBR(p.price);
      const pct = discountToPct(p.discount);
      const priceFinal = priceFull > 0 && pct > 0 ? (priceFull * (1 - pct/100)) : priceFull;

      const rating = (p.rating || "").replace(".",",");
      const soldN = sanitizeSold(p.sold);
      const soldLabel = soldN >= 1000000 ? (Math.round(soldN/100000)/10).toString().replace(".",",")+" mi vendidos"
                     : soldN >= 1000 ? (Math.round(soldN/100)/10).toString().replace(".",",")+" mil vendidos"
                     : soldN > 0 ? soldN+" vendidos" : "";

      const offLabel = pct ? `${pct}% OFF` : (p.discount || "");

      const div = document.createElement("article");
      div.className = "card";
      div.innerHTML = `
        <div class="imgWrap">
          ${offLabel ? `<div class="pill">${offLabel}</div>` : ``}
          ${soldLabel ? `<div class="pill2">${soldLabel}</div>` : ``}
          <img loading="lazy" src="${img}" alt="${title.replace(/"/g,"")}" />
        </div>
        <div class="body">
          <p class="title">${title}</p>
          <div class="meta">
            ${rating ? `<span>‚≠ê ${rating}</span>` : ``}
          </div>
          <div class="priceRow">
            <div>
              ${priceFull && pct ? `<div class="old">${formatBRL(priceFull)}</div>` : (priceFull ? `<div class="old" style="text-decoration:none;color:#111;font-weight:1000">${formatBRL(priceFull)}</div>` : ``)}
              <div class="new">${formatBRL(priceFinal)}</div>
            </div>
            ${pct ? `<div class="badgeOff">-${pct}%</div>` : ``}
          </div>
        </div>
        <button class="btn" onclick="window.open('${link}','_blank')">Ver oferta</button>
      `;
      return div;
    }

    let ALL = [];

    function renderBlocks(searchTerm=""){
      const q = (searchTerm||"").toLowerCase().trim();

      const filtered = ALL.filter(p=>{
        const t = (p.title||"").toLowerCase();
        return !q || t.includes(q);
      });

      // bloco dia: por sold desc (mais chance de compra)
      const day = [...filtered].sort((a,b)=> sanitizeSold(b.sold)-sanitizeSold(a.sold)).slice(0,12);

      // at√© 99: pelo pre√ßo final <= 99
      const under99 = [...filtered].filter(p=>{
        const full = toNumberBR(p.price);
        const pct = discountToPct(p.discount);
        const final = full>0 && pct>0 ? full*(1-pct/100) : full;
        return final > 0 && final <= 99;
      }).slice(0,12);

      // mais pedidos: sold desc
      const most = [...filtered].sort((a,b)=> sanitizeSold(b.sold)-sanitizeSold(a.sold)).slice(0,12);

      // rel√¢mpago: maior desconto
      const flash = [...filtered].sort((a,b)=> discountToPct(b.discount)-discountToPct(a.discount)).slice(0,12);

      const paint = (grid, arr)=>{
        grid.innerHTML = "";
        arr.forEach(p=> grid.appendChild(makeCard(p)));
      };

      paint(els.gridDay, day);
      paint(els.grid99, under99);
      paint(els.gridMost, most);
      paint(els.gridFlash, flash);

      els.cDay.textContent = day.length ? `${day.length} itens` : "";
      els.c99.textContent = under99.length ? `${under99.length} itens` : "";
      els.cMost.textContent = most.length ? `${most.length} itens` : "";
      els.cFlash.textContent = flash.length ? `${flash.length} itens` : "";
    }

    function setMode(value){
      // HOME: mostra tudo (4 blocos)
      // LIST: transforma em lista (tudo)
      // os outros: rola at√© o bloco
      localStorage.setItem("viewSelect", value);

      // tira modo lista
      els.main.classList.remove("listMode");

      if(value === "home"){
        window.scrollTo({ top: 0, behavior: "smooth" });
        return;
      }

      if(value === "list"){
        // vira lista (todos os cards em um bloco s√≥)
        els.main.classList.add("listMode");
        window.scrollTo({ top: els.secDay.offsetTop - 10, behavior: "smooth" });
        return;
      }

      const map = {
        day: els.secDay,
        under99: els.sec99,
        most: els.secMost,
        flash: els.secFlash,
      };
      const target = map[value] || els.secDay;
      target.scrollIntoView({ behavior:"smooth", block:"start" });
    }

    async function load(){
      try{
        const res = await fetch(CSV_URL, { cache: "no-store" });
        if(!res.ok) throw new Error("Falha ao carregar a planilha");
        const text = await res.text();
        const rows = parseCSV(text);

        // normaliza campos esperados
        ALL = rows
          .filter(r => (r.title || r.link || r.image))
          .map(r=>({
            title: r.title || "",
            image: r.image || "",
            price: r.price || "",
            discount: r.discount || "",
            coupon: r.coupon || "",
            sold: r.sold || "",
            rating: r.rating || "",
            link: r.link || ""
          }));

        els.loadingGrid.style.display = "none";

        // render
        renderBlocks("");

        // restaurar seletor
        const saved = localStorage.getItem("viewSelect") || "home";
        els.viewSelect.value = saved;
        setMode(saved);

      }catch(err){
        els.loadingGrid.innerHTML = `
          <div style="grid-column:1/-1;background:#fff;border:1px solid #f0c1c1;color:#7a1010;padding:14px;border-radius:16px;font-weight:900">
            N√£o carregou as ofertas: ${String(err.message || err)}
          </div>
        `;
      }
    }

    // eventos
    els.viewSelect.addEventListener("change", (e)=> setMode(e.target.value));
    els.goBtn.addEventListener("click", ()=>{
      // bot√£o usa o bloco selecionado
      setMode(els.viewSelect.value);
    });
    els.q.addEventListener("input", ()=>{
      renderBlocks(els.q.value);
    });

    load();
  </script>
</body>
</html>
