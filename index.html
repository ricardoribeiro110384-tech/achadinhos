<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Achadinhos do Dia</title>
  <meta name="description" content="Ofertas do Mercado Livre que realmente valem a pena." />
  <meta name="theme-color" content="#FFD000" />
  <link rel="icon" href="logo.png" />

  <style>
    :root{
      --yellow:#FFD000;
      --yellow2:#FFC400;
      --black:#111;
      --bg:#f4f4f4;
      --card:#fff;
      --muted:#6b6b6b;
      --border:#e8e8e8;
      --shadow:0 10px 24px rgba(0,0,0,.08);
      --radius:18px;
      --btn:#111;
      --btnTxt:#fff;
      --accent:#ff4d00;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#111}
    a{color:inherit;text-decoration:none}

    /* HEADER */
    header{
      background:linear-gradient(180deg,var(--yellow),var(--yellow2));
      border-bottom:1px solid rgba(0,0,0,.06);
      position:sticky;top:0;z-index:10;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:14px 16px}
    .top{
      overflow:hidden; /* impede estourar layout */
    }
    .brand{
      display:flex;gap:12px;align-items:center;
    }
    .logo{
      width:48px;height:48px;max-width:48px;max-height:48px;
      object-fit:contain;display:block;
      background:rgba(255,255,255,.35);
      border-radius:14px;
      padding:6px;
      box-shadow:0 6px 18px rgba(0,0,0,.10);
      flex:0 0 auto;
    }
    .brand h1{
      margin:0;
      font-size:28px;
      letter-spacing:-.6px;
      line-height:1.05;
    }
    .brand p{
      margin:6px 0 0;
      color:#2b2b2b;
      font-weight:600;
      opacity:.9;
    }

    /* CONTROLS */
    .controls{
      display:grid;
      grid-template-columns:1fr 240px;
      gap:12px;
      margin-top:14px;
      align-items:stretch;
    }
    .searchWrap{
      background:#fff;border:1px solid rgba(0,0,0,.08);
      border-radius:999px;
      display:flex;align-items:center;gap:10px;
      padding:10px 14px;
      box-shadow:0 10px 20px rgba(0,0,0,.06);
    }
    .searchWrap span{font-size:18px}
    #q{
      width:100%;
      border:0;outline:0;background:transparent;
      font-size:16px;
    }
    .selectWrap{
      background:#fff;border:1px solid rgba(0,0,0,.08);
      border-radius:999px;
      padding:10px 14px;
      display:flex;align-items:center;gap:10px;
      box-shadow:0 10px 20px rgba(0,0,0,.06);
    }
    #preset{
      width:100%;
      border:0;outline:0;background:transparent;
      font-size:16px;
      appearance:none;
    }
    .cta{
      grid-column:1 / -1;
      display:flex;
      gap:12px;
    }
    #btnLoad{
      width:100%;
      border:0;
      border-radius:999px;
      padding:14px 16px;
      background:var(--btn);
      color:var(--btnTxt);
      font-weight:800;
      font-size:16px;
      box-shadow:0 14px 30px rgba(0,0,0,.16);
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:10px;
    }
    #btnLoad:active{transform:translateY(1px)}
    .hint{
      margin-top:10px;
      color:#2b2b2b;
      font-weight:700;
      opacity:.85;
    }

    /* MAIN */
    main{max-width:1100px;margin:18px auto;padding:0 16px 70px}
    .sectionTitle{
      display:flex;align-items:flex-end;justify-content:space-between;
      gap:10px;margin:12px 0 14px;
    }
    .sectionTitle h2{
      margin:0;font-size:34px;letter-spacing:-.8px;line-height:1.0;
    }

    /* GRID */
    #grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:14px;
    }
    @media(max-width:980px){
      .controls{grid-template-columns:1fr}
      #grid{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
    @media(max-width:520px){
      .logo{width:36px;height:36px;max-width:36px;max-height:36px}
      .brand h1{font-size:26px}
      #grid{grid-template-columns:1fr}
    }

    /* CARD */
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:var(--shadow);
      display:flex;flex-direction:column;
      min-height:420px;
    }
    .imgWrap{
      position:relative;
      height:220px;
      background:#fff;
      display:flex;align-items:center;justify-content:center;
      border-bottom:1px solid var(--border);
    }
    .imgWrap img{
      width:100%;
      height:100%;
      object-fit:contain; /* n√£o corta */
      display:block;
      padding:10px;
      background:#fff;
    }

    .badgeTop{
      position:absolute;left:10px;top:10px;
      display:flex;gap:8px;flex-wrap:wrap;
      pointer-events:none;
    }
    .pill{
      font-size:12px;
      font-weight:900;
      padding:7px 10px;
      border-radius:999px;
      background:#111;color:#fff;
      box-shadow:0 10px 18px rgba(0,0,0,.18);
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .pill.blue{background:#0b64ff}
    .pill.gray{background:#2c2c2c}
    .pill.red{background:#ff2b2b}
    .pill.green{background:#11a34a}

    .body{
      padding:12px 12px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      flex:1;
    }
    .title{
      font-weight:900;
      font-size:16px;
      line-height:1.25;
      margin:0;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .meta{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;
      color:var(--muted);
      font-weight:700;
      font-size:14px;
    }
    .stars{color:#111;font-weight:900}
    .priceRow{
      display:flex;align-items:flex-end;justify-content:space-between;gap:12px;
      margin-top:2px;
    }
    .prices{
      display:flex;flex-direction:column;gap:4px;
    }
    .oldPrice{
      color:#7b7b7b;
      font-weight:800;
      text-decoration:line-through;
      font-size:14px;
    }
    .newPrice{
      color:#d90000;
      font-weight:950;
      font-size:30px;
      letter-spacing:-.5px;
      line-height:1;
    }
    .discountBubble{
      background:#111;color:#fff;
      font-weight:950;
      padding:10px 12px;
      border-radius:999px;
      font-size:14px;
      box-shadow:0 14px 26px rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .actions{
      margin-top:auto;
      display:flex;
    }
    .btn{
      width:100%;
      border:0;
      border-radius:14px;
      padding:14px 14px;
      background:linear-gradient(180deg,#ff7a00,#ff4d00);
      color:#fff;
      font-weight:950;
      font-size:16px;
      cursor:pointer;
      box-shadow:0 12px 22px rgba(255,77,0,.25);
    }
    .btn:active{transform:translateY(1px)}

    /* LOADER OVERLAY */
    #overlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;justify-content:center;
      z-index:9999;
      padding:18px;
    }
    .panel{
      width:min(560px,100%);
      background:#fff;
      border-radius:18px;
      padding:16px;
      box-shadow:0 30px 70px rgba(0,0,0,.35);
    }
    .panelTop{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-bottom:10px;
    }
    .panelTop strong{font-size:16px}
    .mini{
      font-size:13px;color:#5d5d5d;font-weight:700
    }
    .bar{
      height:10px;border-radius:999px;background:#eee;overflow:hidden;
    }
    .bar > i{
      display:block;height:100%;width:30%;
      background:#111;border-radius:999px;
      animation:move 1.1s infinite ease-in-out;
    }
    @keyframes move{
      0%{transform:translateX(-100%)}
      50%{transform:translateX(120%)}
      100%{transform:translateX(240%)}
    }

    /* FOOTER DISCLAIMER */
    footer{
      background:#0f0f0f;color:#cfcfcf;
      padding:22px 16px;
      text-align:center;
      font-weight:700;
      margin-top:30px;
    }
    footer strong{color:#fff}
    .error{
      background:#ffe8e8;
      border:1px solid #ffbcbc;
      color:#8a1f1f;
      padding:12px 12px;
      border-radius:14px;
      font-weight:800;
      margin:12px 0;
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="top">
        <div class="brand">
          <img src="logo.png" alt="Achadinhos do Dia" class="logo" />
          <div>
            <h1>Achadinhos do Dia</h1>
            <p>Ofertas do Mercado Livre que realmente valem a pena</p>
          </div>
        </div>
      </div>

      <div class="controls">
        <div class="searchWrap">
          <span>üîé</span>
          <input id="q" type="search" placeholder="Buscar produto..." autocomplete="off" />
        </div>

        <div class="selectWrap">
          <span>‚ö°</span>
          <select id="preset">
            <option value="achadinhos">‚ö° Achadinhos do Dia</option>
            <option value="ate99">üí∏ At√© R$ 99,00</option>
            <option value="maisPedidos">üõí Mais pedidos</option>
            <option value="relampago">‚ö° Oferta rel√¢mpago</option>
            <option value="todas">üì¶ Todas as ofertas</option>
          </select>
        </div>

        <div class="cta">
          <button id="btnLoad" type="button">‚ö° Ver ofertas</button>
        </div>
      </div>

      <div id="msg"></div>
    </div>
  </header>

  <main>
    <div class="sectionTitle">
      <h2 id="titleSection">Achadinhos do Dia</h2>
    </div>

    <div id="grid"></div>

    <footer>
      <div><strong>N√£o somos loja oficial.</strong> Apenas divulgamos ofertas do Mercado Livre.</div>
      <div class="mini" style="margin-top:6px">Os pre√ßos e condi√ß√µes podem mudar a qualquer momento na p√°gina do vendedor.</div>
    </footer>
  </main>

  <!-- Overlay de carregamento -->
  <div id="overlay" aria-hidden="true">
    <div class="panel" role="dialog" aria-label="Carregando ofertas">
      <div class="panelTop">
        <strong>Carregando ofertas‚Ä¶</strong>
        <span class="mini" id="overlayInfo">Aguarde</span>
      </div>
      <div class="bar"><i></i></div>
      <div class="mini" style="margin-top:10px">Se demorar, pode ser a planilha/CSV respondendo lento.</div>
    </div>
  </div>

  <script defer>
    // ‚úÖ CSV publicado (o seu link)
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYh-FJUhtB7MT80tKHccZi-z1hTKUOwDqg-tQSR_YPiDOQv-mKmSjTyAtZzmhq8YEchYOjqcVZhJv3/pub?output=csv";

    const els = {
      q: document.getElementById('q'),
      preset: document.getElementById('preset'),
      btnLoad: document.getElementById('btnLoad'),
      grid: document.getElementById('grid'),
      msg: document.getElementById('msg'),
      title: document.getElementById('titleSection'),
      overlay: document.getElementById('overlay'),
      overlayInfo: document.getElementById('overlayInfo')
    };

    // Cache simples em mem√≥ria (pra carregar mais r√°pido na segunda vez)
    let RAW = [];
    let lastFetchAt = 0;

    function showOverlay(text="Carregando‚Ä¶"){
      els.overlayInfo.textContent = text;
      els.overlay.style.display = "flex";
      els.overlay.setAttribute("aria-hidden","false");
    }
    function hideOverlay(){
      els.overlay.style.display = "none";
      els.overlay.setAttribute("aria-hidden","true");
    }

    function setMsg(html){
      els.msg.innerHTML = html || "";
    }

    // --- Helpers de n√∫mero/BR ---
    function parseBRNumber(v){
      if(v == null) return NaN;
      const s = String(v).trim();
      if(!s) return NaN;
      // troca milhar/ponto e v√≠rgula decimal
      const norm = s.replace(/\./g,'').replace(',', '.').replace(/[^\d.-]/g,'');
      const n = Number(norm);
      return Number.isFinite(n) ? n : NaN;
    }

    function parseDiscountPercent(v){
      // exemplos: "44% OFF", "60%OFF", "71% OFF"
      if(v == null) return 0;
      const s = String(v).toUpperCase();
      const m = s.match(/(\d+)\s*%/);
      const p = m ? Number(m[1]) : 0;
      return Number.isFinite(p) ? p : 0;
    }

    function formatBRL(n){
      try{
        return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
      }catch{
        return "R$ " + (Math.round(n*100)/100).toFixed(2).replace('.',',');
      }
    }

    function soldToNumber(v){
      // exemplos: "1000", "1.000", "10 mil", "10 MIL", "100 mil"
      if(v == null) return 0;
      const s = String(v).trim().toLowerCase();
      if(!s) return 0;
      if(s.includes('mil')){
        const num = parseBRNumber(s.replace('mil','').trim());
        return Number.isFinite(num) ? Math.round(num*1000) : 0;
      }
      if(s.includes('mi') && s.includes('l')){ // "10 mil" j√° pega acima
        const num = parseBRNumber(s.replace(/[^\d,.-]/g,''));
        return Number.isFinite(num) ? Math.round(num) : 0;
      }
      const n = parseBRNumber(s);
      return Number.isFinite(n) ? Math.round(n) : 0;
    }

    // CSV parser robusto (aceita aspas e v√≠rgulas em texto)
    function parseCSV(text){
      const rows = [];
      let row = [];
      let cur = '';
      let inQuotes = false;

      for(let i=0;i<text.length;i++){
        const c = text[i];
        const next = text[i+1];

        if(c === '"' ){
          if(inQuotes && next === '"'){ // escape ""
            cur += '"';
            i++;
          }else{
            inQuotes = !inQuotes;
          }
          continue;
        }
        if(!inQuotes && (c === '\n' || c === '\r')){
          if(c === '\r' && next === '\n') i++;
          row.push(cur);
          rows.push(row);
          row = [];
          cur = '';
          continue;
        }
        if(!inQuotes && c === ','){
          row.push(cur);
          cur = '';
          continue;
        }
        cur += c;
      }
      // √∫ltimo
      if(cur.length || row.length){
        row.push(cur);
        rows.push(row);
      }

      // remove linhas vazias
      return rows.filter(r => r.some(cell => String(cell).trim() !== ""));
    }

    function normalizeKey(k){
      return String(k||'').trim().toLowerCase();
    }

    function mapRows(rows){
      if(rows.length < 2) return [];
      const header = rows[0].map(normalizeKey);

      const idx = (name) => header.indexOf(name);
      const iImage = idx('image');
      const iTitle = idx('title');
      const iPrice = idx('price');
      const iDiscount = idx('discount');
      const iCoupon = idx('coupon');
      const iSold = idx('sold');
      const iRating = idx('rating');
      const iLink = idx('link');

      const out = [];
      for(let r=1;r<rows.length;r++){
        const cols = rows[r];
        const o = {
          image: iImage>=0 ? (cols[iImage]||'').trim() : '',
          title: iTitle>=0 ? (cols[iTitle]||'').trim() : '',
          price: iPrice>=0 ? (cols[iPrice]||'').trim() : '',
          discount: iDiscount>=0 ? (cols[iDiscount]||'').trim() : '',
          coupon: iCoupon>=0 ? (cols[iCoupon]||'').trim() : '',
          sold: iSold>=0 ? (cols[iSold]||'').trim() : '',
          rating: iRating>=0 ? (cols[iRating]||'').trim() : '',
          link: iLink>=0 ? (cols[iLink]||'').trim() : ''
        };

        // valida m√≠nimo
        if(!o.title && !o.image && !o.link) continue;
        if(!o.link) continue;

        // remove duplicados por link
        if(out.some(x => x.link === o.link)) continue;

        out.push(o);
      }
      return out;
    }

    async function fetchData(){
      const now = Date.now();
      // cache 2 minutos
      if(RAW.length && (now - lastFetchAt) < 120000) return RAW;

      showOverlay("Buscando planilha‚Ä¶");
      setMsg("");

      // evita cache agressivo do browser
      const url = CSV_URL + (CSV_URL.includes('?') ? '&' : '?') + 't=' + now;

      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error("Falha ao carregar CSV ("+res.status+")");

      const text = await res.text();
      const rows = parseCSV(text);
      RAW = mapRows(rows);
      lastFetchAt = now;

      if(!RAW.length) throw new Error("Planilha carregou, mas est√° vazia.");

      return RAW;
    }

    function compute(item){
      const priceFull = parseBRNumber(item.price);
      const disc = parseDiscountPercent(item.discount);
      const final = (Number.isFinite(priceFull) ? priceFull : 0) * (1 - (disc/100));
      const rating = parseBRNumber(item.rating);
      const sold = soldToNumber(item.sold);

      return {
        ...item,
        _priceFull: Number.isFinite(priceFull) ? priceFull : NaN,
        _disc: disc,
        _priceFinal: Number.isFinite(final) ? final : NaN,
        _rating: Number.isFinite(rating) ? rating : NaN,
        _sold: sold
      };
    }

    function applyPreset(list, preset){
      let items = list.map(compute);

      // busca
      const q = els.q.value.trim().toLowerCase();
      if(q){
        items = items.filter(x => (x.title||'').toLowerCase().includes(q));
      }

      // filtros
      if(preset === 'ate99'){
        items = items.filter(x => Number.isFinite(x._priceFinal) && x._priceFinal <= 99);
      }

      // ordena√ß√£o e sele√ß√£o
      if(preset === 'maisPedidos'){
        items.sort((a,b)=> (b._sold||0)-(a._sold||0));
      }else if(preset === 'relampago'){
        items.sort((a,b)=> (b._disc||0)-(a._disc||0));
      }else if(preset === 'achadinhos'){
        // ‚ÄúAchadinhos do dia‚Äù = boa combina√ß√£o: desconto + vendidos + nota
        items.sort((a,b)=>{
          const sa = (a._disc||0)*2 + Math.min((a._sold||0)/1000, 100) + (a._rating||0)*4;
          const sb = (b._disc||0)*2 + Math.min((b._sold||0)/1000, 100) + (b._rating||0)*4;
          return sb - sa;
        });
      }else{
        // todas: ordena por desconto desc
        items.sort((a,b)=> (b._disc||0)-(a._disc||0));
      }

      // limite visual (melhora performance)
      const LIMIT = 60;
      return items.slice(0, LIMIT);
    }

    function presetTitle(p){
      if(p==='achadinhos') return "Achadinhos do Dia";
      if(p==='ate99') return "At√© R$ 99,00";
      if(p==='maisPedidos') return "Mais pedidos";
      if(p==='relampago') return "Oferta rel√¢mpago";
      return "Todas as ofertas";
    }

    function safeImg(url){
      const u = (url||'').trim();
      if(!u) return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" width="800" height="600">
          <rect width="100%" height="100%" fill="#f2f2f2"/>
          <text x="50%" y="50%" font-size="28" text-anchor="middle" fill="#888" font-family="Arial">Sem imagem</text>
        </svg>`
      );
      return u;
    }

    function cardHTML(x){
      const off = (x._disc||0);
      const fullOk = Number.isFinite(x._priceFull);
      const finalOk = Number.isFinite(x._priceFinal);

      const oldP = fullOk ? formatBRL(x._priceFull) : "‚Äî";
      const newP = finalOk ? formatBRL(x._priceFinal) : "‚Äî";

      const soldTxt = x._sold ? (x._sold >= 1000 ? (Math.round(x._sold/1000)*1000).toLocaleString('pt-BR') + " vendidos" : x._sold + " vendidos") : "";
      const ratingTxt = Number.isFinite(x._rating) ? x._rating.toFixed(1) : "";

      return `
        <article class="card">
          <div class="imgWrap">
            <div class="badgeTop">
              ${off ? `<span class="pill gray">${off}% OFF</span>` : ``}
              ${soldTxt ? `<span class="pill blue">${soldTxt}</span>` : ``}
            </div>
            <img src="${safeImg(x.image)}" alt="${escapeHtml(x.title||'Produto')}" loading="lazy" decoding="async"
                 onerror="this.onerror=null;this.src='${safeImg('')}'">
          </div>

          <div class="body">
            <p class="title">${escapeHtml(x.title||'Produto')}</p>

            <div class="meta">
              ${ratingTxt ? `<span class="stars">‚≠ê ${ratingTxt}</span>` : ``}
              ${x.coupon ? `<span>üè∑Ô∏è ${escapeHtml(x.coupon)}</span>` : ``}
            </div>

            <div class="priceRow">
              <div class="prices">
                <div class="oldPrice">${oldP}</div>
                <div class="newPrice">${newP}</div>
              </div>
              ${off ? `<div class="discountBubble">-${off}%</div>` : ``}
            </div>

            <div class="actions">
              <a class="btn" href="${escapeAttr(x.link)}" target="_blank" rel="nofollow noopener">Ver oferta</a>
            </div>
          </div>
        </article>
      `;
    }

    function escapeHtml(str){
      return String(str ?? '').replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[s]));
    }
    function escapeAttr(str){
      return String(str ?? '').replace(/"/g,'&quot;');
    }

    function render(items){
      els.grid.innerHTML = items.map(cardHTML).join('');
    }

    async function load(){
      try{
        showOverlay("Carregando ofertas‚Ä¶");
        const data = await fetchData();
        const preset = els.preset.value;

        els.title.textContent = presetTitle(preset);

        const items = applyPreset(data, preset);
        if(!items.length){
          setMsg(`<div class="error">Nenhum produto encontrado com esses filtros. Tente mudar o filtro ou limpar a busca.</div>`);
          els.grid.innerHTML = "";
          return;
        }

        setMsg("");
        render(items);
      }catch(err){
        setMsg(`<div class="error">N√£o carregou as ofertas: ${escapeHtml(err.message || String(err))}</div>`);
        els.grid.innerHTML = "";
      }finally{
        hideOverlay();
      }
    }

    // eventos
    els.btnLoad.addEventListener('click', load);
    els.preset.addEventListener('change', load);

    // busca com debounce
    let t=null;
    els.q.addEventListener('input', ()=>{
      clearTimeout(t);
      t = setTimeout(load, 250);
    });

    // primeira carga autom√°tica (depois do parse do HTML)
    window.addEventListener('DOMContentLoaded', () => {
      load();
    });
  </script>
</body>
</html>
