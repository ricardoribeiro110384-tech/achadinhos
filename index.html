<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Achadinhos ML</title>

<style>
:root{
  --yellow:#ffd400;
  --card: rgba(255,255,255,.9);
  --shadow:0 18px 40px rgba(0,0,0,.35);
  --radius:22px;
}
*{box-sizing:border-box}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#111}
.wrap{max-width:1100px;margin:auto;padding:16px}
.top{background:var(--yellow);border-radius:var(--radius);padding:22px;text-align:center;box-shadow:var(--shadow)}
.logo{width:320px;max-width:90%}
.poster{background:var(--card);margin-top:14px;border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
.title{text-align:center;padding:18px}
.title h1{margin:0;font-size:26px;font-weight:900}
.redbar{background:#c62828;color:#fff;margin:0 14px;border-radius:16px;padding:14px}
.qgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;font-weight:bold}
@media(max-width:700px){.qgrid{grid-template-columns:1fr}}
.lead{text-align:center;padding:14px;font-weight:bold}
.section{padding:14px 18px}
.section h2{text-align:center;font-size:22px;margin-bottom:8px}
.hint{text-align:center;font-weight:bold;margin-bottom:10px}

/* oculto (n√£o mostra "atualizado...") */
.notice{display:none}

/* ===== destaque ===== */
.featured{
  margin: 12px 14px 0;
  border-radius:16px;
  overflow:hidden;
  box-shadow:0 12px 26px rgba(0,0,0,.18);
  background:#fff;
  display:grid;
  grid-template-columns: 1.1fr 1fr;
}
@media(max-width:850px){ .featured{grid-template-columns:1fr} }
.featured .imgwrap{
  background:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:10px;
}
.featured img{width:100%;height:280px;object-fit:contain}
.featured .content{
  padding:14px;
  background:linear-gradient(180deg, rgba(255,212,0,.35), rgba(255,255,255,1));
}
.badgeTop{
  display:inline-block;
  background:#111;
  color:#fff;
  padding:6px 10px;
  border-radius:999px;
  font-weight:1000;
  font-size:12px;
}
.featured h3{margin:10px 0 8px;font-size:20px}
.pricesLine{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:baseline;
  margin:8px 0 6px;
}
.old{color:#777;text-decoration:line-through;font-weight:900}
.new{font-weight:1000;font-size:20px}
.offPill{
  background:#dff3e1;color:#1b5e20;
  padding:6px 10px;border-radius:999px;
  font-size:12px;font-weight:1000
}
.couponPill{
  background:#e8f0fe;
  color:#1a73e8;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:1000;
}
.timer{margin-top:8px;font-weight:900}
.ctaWide{
  display:inline-block;
  margin-top:12px;
  background:var(--yellow);
  color:#000;
  padding:12px 16px;
  border-radius:14px;
  font-weight:1000;
  text-decoration:none;
}

/* ===== carrossel ===== */
.carousel{
  display:flex;
  gap:12px;
  overflow-x:auto;
  scroll-snap-type:x mandatory;
  -webkit-overflow-scrolling: touch;
  padding: 2px 4px 10px;
}
.carousel::-webkit-scrollbar{height:8px}
.carousel::-webkit-scrollbar-thumb{background:#bbb;border-radius:999px}

.carditem{
  flex:0 0 82%;
  background:#fff;
  border-radius:16px;
  box-shadow:0 10px 20px rgba(0,0,0,.2);
  text-decoration:none;
  color:#000;
  scroll-snap-align:start;
  overflow:hidden;
}
.carditem img{
  width:100%;
  height:260px;
  object-fit:contain;
  background:#fff;
  display:block;
}
.cardinfo{padding:12px}
.cardinfo strong{display:block;margin-bottom:6px}
.prices{display:flex;align-items:baseline;gap:10px;flex-wrap:wrap}
.newSmall{font-weight:1000;font-size:18px}
.offSmall{
  background:#dff3e1;color:#1b5e20;
  padding:4px 8px;border-radius:999px;
  font-size:12px;font-weight:1000
}
.couponSmall{
  background:#e8f0fe;
  color:#1a73e8;
  padding:4px 8px;
  border-radius:999px;
  font-size:12px;
  font-weight:1000;
}

/* bot√µes rolar */
.carousel-controls{
  display:flex;
  justify-content:center;
  gap:10px;
  margin-top:8px;
}
.cbtn{
  padding:10px 14px;
  border-radius:12px;
  border:none;
  background:var(--yellow);
  font-weight:900;
  cursor:pointer;
}
.cbtn:active{transform:translateY(1px)}

/* ‚úÖ PC: ofertas em grade; promos com cards menores */
@media(min-width:900px){
  .offers-grid{
    display:grid !important;
    grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));
    gap:12px;
    overflow:visible !important;
    padding:0 !important;
  }
  .offers-grid .carditem{flex:initial}
  #trackPromos .carditem{flex:0 0 340px}
}

/* centraliza quando n√£o precisa rolar */
.carousel.no-scroll{justify-content:center}
.carousel.no-scroll .carditem{flex:0 0 340px}

/* aten√ß√£o */
.attention{margin:14px;border-radius:16px;overflow:hidden}
.att-top{background:#ffb300;text-align:center;font-weight:900;padding:12px}
.att-body{background:#222;color:#fff;text-align:center;padding:14px}
.cta{
  display:inline-block;margin-top:10px;background:var(--yellow);color:#000;
  padding:12px 18px;border-radius:14px;font-weight:900;text-decoration:none
}
footer{text-align:center;color:#aaa;font-size:12px;margin-top:10px}
</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <img src="logo.png" class="logo" alt="Achadinhos ML">
  </div>

  <main class="poster">
    <div class="title">
      <h1>Descubra como comprar online com seguran√ßa, pagando menos e sem cair em golpes</h1>
    </div>

    <div class="redbar">
      <div class="qgrid">
        <div>‚úî E se n√£o chegar?</div>
        <div>‚úî E se eu perder meu dinheiro?</div>
        <div>‚úî E se for falso?</div>
        <div>‚úî E se for golpe?</div>
      </div>
    </div>

    <div class="lead">
      Isso acontece com milhares de pessoas todos os dias. A boa not√≠cia? Agora existe uma forma simples e segura de comprar.
    </div>

    <div id="status" class="notice">Carregando ofertas da planilha‚Ä¶</div>

    <!-- DESTAQUE AUTOM√ÅTICO -->
    <div id="featuredWrap" class="featured" style="display:none;">
      <div class="imgwrap"><img id="featuredImg" alt="Destaque do dia"></div>
      <div class="content">
        <span class="badgeTop">üî• Melhor oferta do dia</span>
        <h3 id="featuredTitle"></h3>

        <div class="pricesLine">
          <span class="old" id="featuredOld" style="display:none;"></span>
          <span class="new" id="featuredNew"></span>
          <span class="offPill" id="featuredOff" style="display:none;"></span>
          <span class="couponPill" id="featuredCoupon" style="display:none;"></span>
        </div>

        <div class="timer">‚è≥ Termina em: <span id="countdown">--:--:--</span></div>
        <a class="ctaWide" id="featuredCTA" href="#" target="_blank" rel="noopener">Ver no grupo do WhatsApp ‚Üí</a>
      </div>
    </div>

    <!-- OFERTAS -->
    <section class="section" id="ofertas">
      <h2>Ofertas principais üî•</h2>

      <div class="carousel offers-grid" id="trackOfertas"></div>

      <div class="carousel-controls">
        <button class="cbtn" type="button" onclick="rolar('trackOfertas', -1)">‚¨ÖÔ∏è</button>
        <button class="cbtn" type="button" onclick="rolar('trackOfertas', 1)">‚û°Ô∏è</button>
      </div>
    </section>

    <!-- PROMO√á√ïES -->
    <section class="section" id="promocoes">
      <h2>Promo√ß√µes do dia ‚è∞</h2>
      <p class="hint">Atualize s√≥ a planilha e o site muda sozinho</p>

      <div class="carousel" id="trackPromos"></div>

      <div class="carousel-controls">
        <button class="cbtn" type="button" onclick="rolar('trackPromos', -1)">‚¨ÖÔ∏è</button>
        <button class="cbtn" type="button" onclick="rolar('trackPromos', 1)">‚û°Ô∏è</button>
      </div>
    </section>

    <div class="attention">
      <div class="att-top">‚ö†Ô∏è Aten√ß√£o!</div>
      <div class="att-body">
        As melhores ofertas acabam r√°pido.<br>
        <a class="cta" href="https://chat.whatsapp.com/GdvrM4Ct4Q6CA6Tf0DRyov" target="_blank" rel="noopener">
          Entrar no grupo do WhatsApp ‚Üí
        </a>
      </div>
    </div>
  </main>

  <footer>¬© <span id="year"></span> Achadinhos ML</footer>
</div>

<script>
/** ‚úÖ SUA PLANILHA */
const SHEET_PUBHTML_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYh-FJUhtB7MT80tKHccZi-z1hTKUOwDqg-tQSR_YPiDOQv-mKmSjTyAtZzmhq8YEchYOjqcVZhJv3/pubhtml";
const SHEET_CSV_URL = SHEET_PUBHTML_URL.replace("/pubhtml", "/pub?output=csv");

/** ‚úÖ SEU GRUPO WHATSAPP */
const WA_GROUP = "https://chat.whatsapp.com/GdvrM4Ct4Q6CA6Tf0DRyov";

document.getElementById("year").textContent = new Date().getFullYear();

function rolar(trackId, dir){
  const t = document.getElementById(trackId);
  if(!t) return;
  const amount = Math.min(t.clientWidth * 0.85, 520) * dir;
  t.scrollBy({ left: amount, behavior: "smooth" });
}

/* ‚úÖ CSV parser robusto */
function parseCSV(text){
  const rows = [];
  let row = [], cur = "", inQuotes = false;

  for (let i=0;i<text.length;i++){
    const c = text[i];
    const next = text[i+1];

    if (c === '"'){
      if (inQuotes && next === '"'){ cur += '"'; i++; }
      else inQuotes = !inQuotes;
      continue;
    }
    if (!inQuotes && (c === ',' || c === '\n' || c === '\r')){
      if (c === '\r' && next === '\n') continue;
      row.push(cur);
      cur = "";
      if (c === '\n'){
        if (row.some(cell => String(cell).trim().length)) rows.push(row.map(x => String(x).trim()));
        row = [];
      }
      continue;
    }
    cur += c;
  }
  if (cur.length || row.length){
    row.push(cur);
    if (row.some(cell => String(cell).trim().length)) rows.push(row.map(x => String(x).trim()));
  }
  return rows;
}

function safeText(s){ return (s || "").replace(/</g,"&lt;"); }

function toNumberBR(v){
  let s = String(v || "").trim();
  if(!s) return NaN;
  s = s.replace(/[^\d,.\-]/g,"");
  if (s.includes(",") && s.includes(".")) s = s.replace(/\./g,"").replace(",",".");
  else if (s.includes(",") && !s.includes(".")) s = s.replace(",",".");
  const n = parseFloat(s);
  return Number.isFinite(n) ? n : NaN;
}

function toDiscount(v){
  let s = String(v || "").trim();
  if(!s) return 0;
  s = s.replace(",",".");
  const m = s.match(/-?\d+(\.\d+)?/);
  const n = m ? parseFloat(m[0]) : 0;
  return Number.isFinite(n) ? n : 0;
}

function formatBRL(n){
  return n.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
}

function normalizeCoupon(v){
  let s = String(v || "").trim();
  if(!s) return "";
  // remove "cupom:" se a pessoa escrever
  s = s.replace(/^cupom\s*:\s*/i, "").trim();
  return s;
}

function buildCard(item){
  const a = document.createElement("a");
  a.className = "carditem";
  a.href = WA_GROUP;
  a.target = "_blank";
  a.rel = "noopener";

  const img = document.createElement("img");
  img.src = item.image;
  img.alt = item.title || "Oferta";
  img.onerror = () => { img.style.display = "none"; };

  const info = document.createElement("div");
  info.className = "cardinfo";

  const strong = document.createElement("strong");
  strong.innerHTML = safeText(item.title || "");

  const prices = document.createElement("div");
  prices.className = "prices";

  const p = toNumberBR(item.price);
  const d = toDiscount(item.discount);
  const coupon = normalizeCoupon(item.coupon);

  if (Number.isFinite(p) && p > 0 && d > 0){
    const old = document.createElement("span");
    old.className = "old";
    old.textContent = formatBRL(p);

    const final = p * (1 - d/100);

    const neu = document.createElement("span");
    neu.className = "newSmall";
    neu.textContent = formatBRL(final);

    const off = document.createElement("span");
    off.className = "offSmall";
    off.textContent = `${d}% OFF`;

    prices.appendChild(old);
    prices.appendChild(neu);
    prices.appendChild(off);
  } else {
    const neu = document.createElement("span");
    neu.className = "newSmall";
    if (Number.isFinite(p) && p > 0) neu.textContent = formatBRL(p);
    else neu.textContent = "Ver no grupo ‚Üí";
    prices.appendChild(neu);
  }

  if (coupon){
    const cp = document.createElement("span");
    cp.className = "couponSmall";
    cp.textContent = `CUPOM: ${coupon}`;
    prices.appendChild(cp);
  }

  info.appendChild(strong);
  info.appendChild(prices);

  a.appendChild(img);
  a.appendChild(info);
  return a;
}

/* centraliza quando n√£o precisa rolar */
function markScrollable(track){
  if(!track) return;
  const needsScroll = track.scrollWidth > (track.clientWidth + 2);
  track.classList.toggle("no-scroll", !needsScroll);
}

/* countdown at√© 23:59:59 */
let countdownTimer = null;
function startCountdown(){
  const el = document.getElementById("countdown");
  if(!el) return;

  function tick(){
    const now = new Date();
    const end = new Date();
    end.setHours(23,59,59,999);
    const diff = Math.max(0, end - now);
    const h = String(Math.floor(diff/3600000)).padStart(2,"0");
    const m = String(Math.floor((diff%3600000)/60000)).padStart(2,"0");
    const s = String(Math.floor((diff%60000)/1000)).padStart(2,"0");
    el.textContent = `${h}:${m}:${s}`;
  }

  tick();
  if(countdownTimer) clearInterval(countdownTimer);
  countdownTimer = setInterval(tick, 1000);
}

/* destaque autom√°tico: maior desconto */
function renderFeatured(best){
  const wrap = document.getElementById("featuredWrap");
  if(!best){ wrap.style.display="none"; return; }

  const img = document.getElementById("featuredImg");
  const title = document.getElementById("featuredTitle");
  const cta = document.getElementById("featuredCTA");

  const oldEl = document.getElementById("featuredOld");
  const newEl = document.getElementById("featuredNew");
  const offEl = document.getElementById("featuredOff");
  const cupEl = document.getElementById("featuredCoupon");

  img.src = best.image;
  title.textContent = best.title || "Destaque do dia";
  cta.href = WA_GROUP;

  const p = toNumberBR(best.price);
  const d = toDiscount(best.discount);
  const coupon = normalizeCoupon(best.coupon);

  if (Number.isFinite(p) && p > 0 && d > 0){
    oldEl.style.display = "";
    offEl.style.display = "";
    oldEl.textContent = "De: " + formatBRL(p);
    newEl.textContent = "Por: " + formatBRL(p * (1 - d/100));
    offEl.textContent = `${d}% OFF`;
  } else if (Number.isFinite(p) && p > 0){
    oldEl.style.display = "none";
    offEl.style.display = "none";
    newEl.textContent = "Pre√ßo: " + formatBRL(p);
  } else {
    oldEl.style.display = "none";
    offEl.style.display = "none";
    newEl.textContent = "Ver no grupo ‚Üí";
  }

  if (coupon){
    cupEl.style.display = "";
    cupEl.textContent = `CUPOM: ${coupon}`;
  } else {
    cupEl.style.display = "none";
    cupEl.textContent = "";
  }

  wrap.style.display = "grid";
  startCountdown();
}

async function loadFromSheet(){
  const status = document.getElementById("status");
  const ofertasWrap = document.getElementById("trackOfertas");
  const promosWrap  = document.getElementById("trackPromos");

  try{
    const res = await fetch(SHEET_CSV_URL, { cache:"no-store" });
    if (!res.ok) throw new Error("Falha ao buscar CSV");
    const csv = await res.text();
    const rows = parseCSV(csv);

    if (!rows.length){
      status.textContent = "Planilha vazia.";
      return;
    }

    const header = rows[0].map(h => (h || "").toLowerCase().trim());
    const idx = (name) => header.indexOf(name);

    const sI = idx("section");
    const iI = idx("image");
    const tI = idx("title");
    const pI = idx("price");
    const dI = idx("discount");
    const cI = idx("coupon"); // ‚úÖ novo

    if (sI < 0 || iI < 0 || tI < 0){
      status.textContent = "Cabe√ßalhos inv√°lidos. Use: section | image | title | price | discount | coupon";
      return;
    }

    const items = rows.slice(1).map(r => ({
      section: (r[sI] || "").trim().toLowerCase(),
      image:   (r[iI] || "").trim(),
      title:   (r[tI] || "").trim(),
      price:   pI >= 0 ? (r[pI] || "").trim() : "",
      discount:dI >= 0 ? (r[dI] || "").trim() : "",
      coupon:  cI >= 0 ? (r[cI] || "").trim() : ""
    })).filter(x => x.section && x.image);

    // destaque: maior desconto (se empate, pega o primeiro)
    let best = null;
    items.forEach(it=>{
      const d = toDiscount(it.discount);
      if(!best || d > toDiscount(best.discount)) best = it;
    });

    const ofertas = items.filter(x => x.section === "oferta");
    const promos  = items.filter(x => x.section === "promo");

    ofertasWrap.innerHTML = "";
    promosWrap.innerHTML  = "";

    ofertas.forEach(item => ofertasWrap.appendChild(buildCard(item)));
    promos.forEach(item  => promosWrap.appendChild(buildCard(item)));

    renderFeatured(best);

    requestAnimationFrame(()=>{
      markScrollable(promosWrap);
      markScrollable(ofertasWrap);
    });

    status.textContent = "OK";
  } catch(e){
    status.textContent = "N√£o consegui carregar a planilha.";
  }
}

window.addEventListener("resize", () => {
  markScrollable(document.getElementById("trackPromos"));
  markScrollable(document.getElementById("trackOfertas"));
});

loadFromSheet();
</script>
</body>
</html>
