<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Achadinhos Oficial</title>
  <meta name="theme-color" content="#0f172a" />

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a33;
      --soft:#132047;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --brand:#22c55e;
      --accent:#f59e0b;
      --danger:#ef4444;
      --border:rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;

      --yellow:#ffd000;
      --yellowText:#1a1400;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1000px 600px at 20% 0%, rgba(34,197,94,.12), transparent 60%),
                  radial-gradient(800px 500px at 80% 10%, rgba(245,158,11,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}

    /* =========================
       TOP YELLOW STRIP (logo)
       ========================= */
    .topbar{
      background: linear-gradient(90deg, #ffd000, #ffb800);
      color:var(--yellowText);
      border-bottom:1px solid rgba(0,0,0,.10);
    }
    .topbar .wrap{
      padding:10px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .topbrand{
      display:flex;align-items:center;gap:10px;
      font-weight:1000;
      letter-spacing:.2px;
      min-width:0;
    }
    .toplogo{
      width:38px;height:38px;border-radius:12px;
      background:#111;
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    /* Se voc√™ tiver uma logo.png no mesmo reposit√≥rio, ela aparece aqui */
    .toplogo img{width:100%;height:100%;object-fit:contain}
    .topbrand .name{
      font-size:16px;
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .topbrand .tagline{
      font-size:12px;
      opacity:.85;
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:60vw;
    }
    .topright{
      display:flex;gap:10px;align-items:center;flex:0 0 auto;
      font-weight:1000;
      font-size:12px;
      background: rgba(0,0,0,.10);
      border:1px solid rgba(0,0,0,.12);
      border-radius:999px;
      padding:8px 10px;
      white-space:nowrap;
    }

    /* Header */
    header{
      position:sticky; top:0; z-index:50;
      background: rgba(11,18,32,.90);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .headbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:12px 0;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      font-weight:1000; letter-spacing:.3px;
      min-width:0;
    }
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(245,158,11,.85));
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    .brandText{min-width:0}
    .brandText > div:first-child{
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .sub{
      font-size:12px;color:var(--muted);margin-top:2px;font-weight:800;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .status{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border:1px solid var(--border);
      border-radius:999px;background: rgba(255,255,255,.04);
      font-size:12px;color:var(--muted);
      white-space:nowrap;
      max-width:520px;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .dot{width:9px;height:9px;border-radius:999px;background:var(--accent);box-shadow: 0 0 0 4px rgba(245,158,11,.12)}
    .status b{color:var(--text)}
    .pill{
      padding:8px 10px;border-radius:999px;
      background: rgba(34,197,94,.14);
      border:1px solid rgba(34,197,94,.28);
      font-size:12px;font-weight:1000;color:#bbf7d0;
      white-space:nowrap;
    }

    /* MOBILE header fix (n√£o ‚Äúestoura‚Äù/n√£o fica espa√ßo vazio ao puxar) */
    @media (max-width: 860px){
      .headbar{flex-wrap:wrap; align-items:flex-start}
      .brand{flex:1 1 auto}
      .pill{order:2}
      .status{
        order:3;
        width:100%;
        justify-content:center;
        max-width:none;
      }
    }

    /* Hero promise */
    .hero{
      margin-top:16px;
      background: linear-gradient(180deg, rgba(19,32,71,.9), rgba(15,26,51,.7));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .hero:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(500px 200px at 20% 10%, rgba(34,197,94,.25), transparent 60%),
                  radial-gradient(450px 220px at 75% 0%, rgba(245,158,11,.22), transparent 55%);
      pointer-events:none;
    }
    .hero-inner{
      position:relative;
      padding:18px;
      display:grid;
      grid-template-columns: 1.3fr .7fr;
      gap:14px;
      align-items:center;
    }
    @media (max-width: 860px){
      .hero-inner{grid-template-columns:1fr}
    }
    .hero h1{margin:0;font-size:22px;line-height:1.2}
    .hero p{margin:8px 0 0;color:var(--muted);font-weight:800}
    .hero .ctaRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      display:inline-flex;align-items:center;gap:10px;
      padding:12px 14px;border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      font-weight:1000;
      cursor:pointer;
      transition: transform .08s ease;
      user-select:none;
      color:var(--text);
    }
    .btn:active{transform: translateY(1px)}
    .btnPrimary{
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(34,197,94,.75));
      color:#052014;border:none;
    }

    .kpi{display:grid;gap:10px}
    .kpiCard{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius:14px;
      padding:12px;
    }
    .kpiCard b{font-size:16px}
    .kpiCard span{display:block;color:var(--muted);font-size:12px;font-weight:900;margin-top:2px}

    /* OPTIONAL VIDEO (mantido) */
    .videoBox{
      margin-top:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    .videoBox .vpad{padding:12px}
    .videoBox h3{margin:0 0 8px;font-size:14px}
    .videoBox p{margin:0 0 10px;color:var(--muted);font-weight:800;font-size:12px;line-height:1.4}
    .videoWrap{
      background:#000;
      aspect-ratio:16/9;
      width:100%;
      display:flex;align-items:center;justify-content:center;
    }
    video{
      width:100%;
      height:100%;
      display:block;
      object-fit:cover;
      background:#000;
    }

    /* Controls */
    .controls{
      margin-top:14px;
      display:flex;gap:10px;flex-wrap:wrap;
      align-items:center;justify-content:space-between;
    }
    .search{
      flex:1;
      min-width:240px;
      display:flex;align-items:center;gap:10px;
      padding:12px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background: rgba(255,255,255,.04);
    }
    .search input{
      width:100%;
      background:transparent;border:none;outline:none;color:var(--text);
      font-size:14px;font-weight:900;
    }
    .select{
      min-width:180px;
      padding:12px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background: rgba(255,255,255,.04);
      color:var(--text);
      font-weight:1000;
      outline:none;
    }

    /* Social proof / urgency */
    .bar{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 860px){
      .bar{grid-template-columns:1fr}
    }
    .notice{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius:14px;
      padding:12px;
      display:flex;gap:10px;align-items:flex-start;
    }
    .badge{
      width:34px;height:34px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(245,158,11,.16);
      border:1px solid rgba(245,158,11,.30);
      flex:0 0 auto;
    }
    .notice h3{margin:0;font-size:13px}
    .notice p{margin:4px 0 0;color:var(--muted);font-weight:900;font-size:12px;line-height:1.35}
    .mini{font-size:12px;color:var(--muted);font-weight:1000}

    /* Grid / cards */
    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
    }
    @media (max-width: 980px){.grid{grid-template-columns: repeat(2,1fr)}}
    @media (max-width: 620px){.grid{grid-template-columns: 1fr}}

    /* Mobile: ‚Äúcarrossel‚Äù com 2 cards por vez (sem estourar a tela) */
    @media (max-width: 860px){
      .grid{
        display:flex;
        overflow-x:auto;
        gap:12px;
        padding: 6px 2px 12px;
        scroll-snap-type:x mandatory;
        -webkit-overflow-scrolling: touch;
      }
      .grid::after{content:"";flex:0 0 8px}
      .card{
        flex:0 0 calc(50% - 8px);
        min-width: 240px;
        scroll-snap-align:start;
      }
    }

    .card{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: 0 12px 24px rgba(0,0,0,.25);
      display:flex;flex-direction:column;
      min-height: 430px;
    }

    /* IMAGENS SEM CORTAR */
    .imgbox{
      background: rgba(255,255,255,.03);
      border-bottom:1px solid var(--border);
      aspect-ratio: 16 / 11;
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
      padding:8px;
    }
    .imgbox img{
      width:100%;height:100%;
      object-fit:contain; /* <- n√£o corta */
      display:block;
      background: rgba(255,255,255,.02);
      border-radius:12px;
    }

    .cardBody{padding:12px;display:grid;gap:10px}
    .title{
      margin:0;
      font-size:14px;
      line-height:1.25;
      font-weight:1000;
      min-height: 38px;
    }
    .row{
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      flex-wrap:wrap;
    }

    /* pre√ßos */
    .priceWrap{display:flex;flex-direction:column;gap:4px}
    .priceNow{
      font-size:18px;font-weight:1100;
      display:inline-flex;align-items:center;gap:8px;
      background: rgba(34,197,94,.16);
      border:1px solid rgba(34,197,94,.30);
      color:#bbf7d0;
      padding:6px 10px;
      border-radius:999px;
      width:max-content;
    }
    .priceOld{
      font-size:13px;
      color: rgba(229,231,235,.75);
      font-weight:900;
      text-decoration: line-through;
      padding-left:2px;
    }

    .muted{color:var(--muted);font-weight:900;font-size:12px}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      font-size:12px;font-weight:1000;color:var(--text);
    }
    .off{
      border:1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.14);
      color:#fecaca;
    }
    .coupon{
      border:1px solid rgba(34,197,94,.28);
      background: rgba(34,197,94,.12);
      color:#bbf7d0;
    }

    /* buttons */
    .buy{
      margin-top:2px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .btnSmall{
      display:flex;align-items:center;justify-content:center;
      padding:12px 10px;border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      font-weight:1100;
      cursor:pointer;
      color:var(--text);
    }
    .btnBuy{
      background: linear-gradient(135deg, rgba(245,158,11,.95), rgba(245,158,11,.75));
      color:#1b1201;border:none;
    }
    .btnGroup{
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(34,197,94,.75));
      color:#052014;border:none;
    }

    /* Share button (sempre vis√≠vel, boa leitura) */
    .shareRow{
      display:flex;
      gap:10px;
      margin-top:8px;
    }
    .btnShare{
      flex:1;
      padding:11px 10px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      color:#e5e7eb;
      font-weight:1100;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:8px;
    }

    /* Footer */
    footer{
      margin:18px 0 110px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius: var(--radius);
      padding:14px;
    }
    footer b{display:block;margin-bottom:6px}
    footer ul{margin:0;padding-left:18px;color:var(--muted);font-weight:800;font-size:13px;line-height:1.45}

    /* WhatsApp fixed button */
    .wa{
      position:fixed;right:16px;bottom:16px;z-index:999;
      display:flex;align-items:center;gap:10px;
      padding:14px 14px;
      border-radius:999px;
      background: linear-gradient(135deg, rgba(34,197,94,.98), rgba(34,197,94,.78));
      color:#052014;
      font-weight:1100;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      border:none;
      cursor:pointer;
    }
    .wa small{display:block;font-weight:1000;opacity:.9;line-height:1}
    .wa span{display:block;line-height:1}
    .waIcon{
      width:38px;height:38px;border-radius:999px;
      background: rgba(0,0,0,.12);
      display:flex;align-items:center;justify-content:center;
      font-size:18px;
    }

    /* Loading */
    .loading{
      margin-top:16px;
      border:1px dashed rgba(255,255,255,.22);
      border-radius: var(--radius);
      padding:14px;
      color:var(--muted);
      font-weight:900;
    }
  </style>
</head>

<body>

<!-- FAIXA AMARELA (logo + nome) -->
<div class="topbar">
  <div class="wrap">
    <div class="topbrand">
      <div class="toplogo" aria-hidden="true">
        <!-- coloque uma imagem "logo.png" no reposit√≥rio para aparecer aqui -->
        <img src="logo.png" alt="" onerror="this.style.display='none'">
      </div>
      <div style="min-width:0">
        <div class="name">Achadinhos Oficial</div>
        <div class="tagline">Links + cupons no grupo ‚Ä¢ aproveite antes que acabe</div>
      </div>
    </div>

    <div class="topright" title="Grupo oficial">
      üîó Grupo WhatsApp
    </div>
  </div>
</div>

<header>
  <div class="wrap">
    <div class="headbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="brandText">
          <div>Achadinhos <span style="color:#bbf7d0">Oficial</span></div>
          <div class="sub">Ofertas atualizadas direto da planilha</div>
        </div>
      </div>

      <div class="status" title="Atualiza√ß√£o autom√°tica">
        <span class="dot" id="statusDot"></span>
        <span id="updatedLabel"><b>Carregando</b></span>
        <span id="updatedTime" class="mini" data-mode="checking">Verificando‚Ä¶</span>
      </div>

      <div class="pill" id="countPill">0 ofertas</div>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- üîù Topo com promessa -->
  <section class="hero">
    <div class="hero-inner">
      <div>
        <h1>As melhores ofertas do dia ‚Äî sem enrola√ß√£o. <span style="color:#bbf7d0">Se piscar, some.</span></h1>
        <p>‚ö†Ô∏è Desconto alto costuma acabar r√°pido. Quer os links e cupons? Entre no grupo.</p>
        <div class="ctaRow">
          <button class="btn btnPrimary" onclick="scrollToOffers()">üéÅ Ver ofertas agora</button>
          <button class="btn" onclick="openGroup()">üü¢ Entrar no grupo</button>
          <button class="btn" onclick="forceReload()">üîÑ Atualizar agora</button>
        </div>
      </div>

      <div class="kpi">
        <div class="kpiCard">
          <b id="kpi1">0</b>
          <span>ofertas dispon√≠veis</span>
        </div>
        <div class="kpiCard">
          <b id="kpi2">‚Äî</b>
          <span>vendidos hoje (estimativa)</span>
        </div>
      </div>
    </div>
  </section>

  <!-- üé¨ V√çDEO (mantido) -->
  <section class="videoBox">
    <div class="vpad">
      <h3>üé• Aviso r√°pido</h3>
      <p>Se o v√≠deo estiver sem √°udio, toque no √≠cone üîä do player. (No celular, autoplay com som √© bloqueado.)</p>
    </div>
    <div class="videoWrap">
      <!-- Troque "video.mp4" pelo seu arquivo de v√≠deo no reposit√≥rio -->
      <video controls playsinline preload="metadata">
        <source src="video.mp4" type="video/mp4">
        Seu navegador n√£o suporta v√≠deo.
      </video>
    </div>
  </section>

  <!-- Busca / filtro -->
  <section class="controls">
    <div class="search">
      üîé <input id="q" type="text" placeholder="Buscar produto (ex: t√™nis, perfume, mesa...)" />
    </div>

    <select class="select" id="sort">
      <option value="best">Ordenar: destaque</option>
      <option value="priceAsc">Menor pre√ßo</option>
      <option value="priceDesc">Maior pre√ßo</option>
      <option value="discountDesc">Maior desconto</option>
      <option value="soldDesc">Mais vendidos</option>
      <option value="ratingDesc">Melhor avalia√ß√£o</option>
    </select>
  </section>

  <!-- üî• Urg√™ncia social / Prova -->
  <section class="bar">
    <div class="notice">
      <div class="badge">üî•</div>
      <div>
        <h3>Acabando r√°pido</h3>
        <p id="urgencyText">Quando aparece desconto alto, costuma acabar r√°pido. Se gostou, garanta agora.</p>
      </div>
    </div>

    <div class="notice">
      <div class="badge">‚úÖ</div>
      <div>
        <h3>Quem compra, leva</h3>
        <p id="socialText">As melhores ofertas saem do ar primeiro. Entre no grupo para pegar o link na hora.</p>
      </div>
    </div>
  </section>

  <div id="loading" class="loading">Carregando ofertas da planilha‚Ä¶</div>

  <!-- üéÅ Destaque de ofertas -->
  <section id="offers" class="grid" aria-live="polite"></section>

  <!-- üîö Rodap√© confi√°vel -->
  <footer>
    <b>üîí Compra com seguran√ßa</b>
    <ul>
      <li>Este site apenas divulga ofertas encontradas em marketplaces e grupos de promo√ß√µes.</li>
      <li><b>N√£o somos uma loja oficial do Mercado Livre</b> e n√£o representamos a marca.</li>
      <li>Pre√ßos e disponibilidade podem mudar a qualquer momento no site do vendedor.</li>
      <li>Para receber <b>links e cupons</b>, entre no grupo do WhatsApp.</li>
    </ul>
  </footer>

</main>

<!-- üü¢ Bot√£o WhatsApp fixo -->
<button class="wa" onclick="openGroup()" aria-label="Entrar no grupo do WhatsApp">
  <div class="waIcon">üü¢</div>
  <div>
    <span>Entrar no grupo</span>
    <small>Links + cupons</small>
  </div>
</button>

<script>
  // =========================
  // CONFIG
  // =========================
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYh-FJUhtB7MT80tKHccZi-z1hTKUOwDqg-tQSR_YPiDOQv-mKmSjTyAtZzmhq8YEchYOjqcVZhJv3/pub?output=csv";

  // Link do grupo WhatsApp (para abrir no bot√£o)
  const WHATS_GROUP_LINK = "https://chat.whatsapp.com/GdvrM4Ct4Q6CA6Tf0DRyov";

  // Atualiza√ß√£o autom√°tica da planilha
  const REFRESH_MS = 2 * 60 * 1000; // 2 minutos

  // =========================
  // HELPERS
  // =========================
  function nowHHMMSS(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    const ss = String(d.getSeconds()).padStart(2,'0');
    return `${hh}:${mm}:${ss}`;
  }

  function moneyBRL(value){
    const n = Number(value);
    if (!isFinite(n)) return "‚Äî";
    return n.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
  }

  function toNumber(str){
    if (str == null) return NaN;
    const s = String(str).trim()
      .replace(/\s/g,'')
      .replace(/\./g,'')
      .replace(',', '.')
      .replace(/[^\d.-]/g,'');
    const n = Number(s);
    return isFinite(n) ? n : NaN;
  }

  function parsePercent(discountStr){
    // aceita "46% OFF", "46%", "OFF 46%"...
    const m = String(discountStr || "").match(/(\d+(?:[.,]\d+)?)/);
    if(!m) return NaN;
    const n = toNumber(m[1]);
    return isFinite(n) ? n : NaN;
  }

  function safeText(x){
    return (x ?? "").toString().replace(/\s+/g,' ').trim();
  }

  function scrollToOffers(){
    document.getElementById("offers").scrollIntoView({behavior:"smooth", block:"start"});
  }

  function openGroup(){
    window.open(WHATS_GROUP_LINK, "_blank");
  }

  function setStatus(mode, text){
    const dot = document.getElementById("statusDot");
    const label = document.getElementById("updatedLabel");
    const time = document.getElementById("updatedTime");

    if (mode === "ok"){
      dot.style.background = "var(--brand)";
      dot.style.boxShadow = "0 0 0 4px rgba(34,197,94,.12)";
      label.innerHTML = "<b>Atualizado</b>";
      time.dataset.mode = "updated";
      time.textContent = text;
    } else if (mode === "loading"){
      dot.style.background = "var(--accent)";
      dot.style.boxShadow = "0 0 0 4px rgba(245,158,11,.12)";
      label.innerHTML = "<b>Carregando</b>";
      time.dataset.mode = "checking";
      time.textContent = text;
    } else {
      dot.style.background = "var(--danger)";
      dot.style.boxShadow = "0 0 0 4px rgba(239,68,68,.12)";
      label.innerHTML = "<b>Falha</b>";
      time.dataset.mode = "checking";
      time.textContent = text;
    }
  }

  // Rel√≥gio rodando sempre
  function startLiveClock(){
    const timeEl = document.getElementById("updatedTime");
    if(!timeEl) return;

    setInterval(() => {
      if(timeEl.dataset.mode !== "updated"){
        timeEl.textContent = `Verificando: ${nowHHMMSS()}`;
      }
    }, 1000);
  }

  // CSV parser simples (suporta aspas)
  function parseCSV(text){
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for(let i=0;i<text.length;i++){
      const ch = text[i];
      const next = text[i+1];

      if(ch === '"' && inQuotes && next === '"'){
        cur += '"';
        i++;
        continue;
      }
      if(ch === '"'){
        inQuotes = !inQuotes;
        continue;
      }
      if(ch === ',' && !inQuotes){
        row.push(cur);
        cur = "";
        continue;
      }
      if((ch === '\n' || ch === '\r') && !inQuotes){
        if(ch === '\r' && next === '\n'){ i++; }
        row.push(cur);
        cur = "";
        if(row.length > 1 || row[0].trim() !== ""){
          rows.push(row);
        }
        row = [];
        continue;
      }
      cur += ch;
    }
    row.push(cur);
    if(row.length > 1 || row[0].trim() !== ""){
      rows.push(row);
    }
    return rows;
  }

  // =========================
  // RENDER
  // =========================
  let ALL_ITEMS = [];

  function forceReload(){
    loadSheet(true);
  }

  function getQuery(){
    return safeText(document.getElementById("q").value).toLowerCase();
  }

  function getSort(){
    return document.getElementById("sort").value;
  }

  function sortItems(items, mode){
    const a = [...items];

    if(mode === "priceAsc"){
      a.sort((x,y)=> (x.priceNowNum||Infinity) - (y.priceNowNum||Infinity));
    } else if(mode === "priceDesc"){
      a.sort((x,y)=> (y.priceNowNum||-Infinity) - (x.priceNowNum||-Infinity));
    } else if(mode === "discountDesc"){
      a.sort((x,y)=> (y.discountNum||0) - (x.discountNum||0));
    } else if(mode === "soldDesc"){
      a.sort((x,y)=> (y.soldNum||0) - (x.soldNum||0));
    } else if(mode === "ratingDesc"){
      a.sort((x,y)=> (y.ratingNum||0) - (x.ratingNum||0));
    } else {
      // destaque: sold + desconto + rating
      a.sort((x,y)=>{
        const sx = (x.soldNum||0) * 2 + (x.discountNum||0) * 1.2 + (x.ratingNum||0) * 10;
        const sy = (y.soldNum||0) * 2 + (y.discountNum||0) * 1.2 + (y.ratingNum||0) * 10;
        return sy - sx;
      });
    }
    return a;
  }

  function filterItems(items){
    const q = getQuery();
    if(!q) return items;

    return items.filter(it => {
      const hay = `${it.title} ${it.coupon||""}`.toLowerCase();
      return hay.includes(q);
    });
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");
  }

  function openOffer(it){
    // SE tiver link de afiliado na planilha -> abre ele
    // SEN√ÉO -> abre o grupo do WhatsApp
    const u = safeText(it.affiliate || it.link);
    if(u && /^https?:\/\//i.test(u)){
      window.open(u, "_blank");
      return;
    }
    openGroup();
  }

  async function shareOffer(it){
    const priceNow = isFinite(it.priceNowNum) ? moneyBRL(it.priceNowNum) : "‚Äî";
    const priceOld = isFinite(it.priceOldNum) ? moneyBRL(it.priceOldNum) : "";
    const coupon = it.coupon ? `\nCupom: ${it.coupon}` : "";
    const discount = it.discount ? `\nDesconto: ${it.discount}` : "";
    const link = safeText(it.affiliate || it.link) || WHATS_GROUP_LINK;

    const text =
`${it.title}
Pre√ßo: ${priceNow}${priceOld ? ` (de ${priceOld})` : ""}${discount}${coupon}

‚ö†Ô∏è Se quiser pegar o link/cupom r√°pido, entra no grupo:
${WHATS_GROUP_LINK}`;

    try{
      if(navigator.share){
        await navigator.share({ title: it.title, text, url: link });
      }else{
        await navigator.clipboard.writeText(text);
        alert("Texto da oferta copiado para compartilhar!");
      }
    }catch(e){
      try{
        await navigator.clipboard.writeText(text);
        alert("Texto da oferta copiado para compartilhar!");
      }catch{
        prompt("Copie para compartilhar:", text);
      }
    }
  }

  async function copyCoupon(coupon){
    const c = safeText(coupon);
    if(!c){ alert("Este item n√£o tem cupom."); return; }
    try{
      await navigator.clipboard.writeText(c);
      alert("Cupom copiado: " + c);
    }catch{
      prompt("Copie o cupom:", c);
    }
  }

  function render(){
    const grid = document.getElementById("offers");
    const loading = document.getElementById("loading");

    const sorted = sortItems(filterItems(ALL_ITEMS), getSort());

    grid.innerHTML = "";
    loading.style.display = sorted.length ? "none" : "block";
    loading.textContent = sorted.length ? "" : "Nenhuma oferta encontrada. Tente outra busca.";

    // KPIs
    document.getElementById("countPill").textContent = `${ALL_ITEMS.length} ofertas`;
    document.getElementById("kpi1").textContent = ALL_ITEMS.length.toString();

    const soldToday = ALL_ITEMS.reduce((acc,it)=> acc + (it.soldNum||0), 0);
    document.getElementById("kpi2").textContent = soldToday ? soldToday.toString() : "‚Äî";

    // textos de escassez (mais fortes)
    document.getElementById("urgencyText").textContent =
      "üî• As melhores ofertas somem primeiro. Se gostou, clica e garante AGORA.";
    document.getElementById("socialText").textContent =
      soldToday ? `‚úÖ Hoje j√° somou ${soldToday} compras nas ofertas da planilha. Quem chega antes, leva.` :
                 "‚úÖ Oferta boa n√£o fica muito tempo no ar. Entre no grupo pra pegar o link na hora.";

    for(const it of sorted){
      const card = document.createElement("article");
      card.className = "card";

      const img = document.createElement("div");
      img.className = "imgbox";
      img.innerHTML = `<img src="${it.image || ""}" alt="${escapeHtml(it.title)}" loading="lazy" referrerpolicy="no-referrer" />`;
      card.appendChild(img);

      const body = document.createElement("div");
      body.className = "cardBody";

      const title = document.createElement("h2");
      title.className = "title";
      title.textContent = it.title || "Oferta";
      body.appendChild(title);

      // pre√ßo (agora + antigo riscado)
      const row1 = document.createElement("div");
      row1.className = "row";

      const left = document.createElement("div");
      left.className = "priceWrap";

      const now = document.createElement("div");
      now.className = "priceNow";
      now.textContent = isFinite(it.priceNowNum) ? moneyBRL(it.priceNowNum) : "‚Äî";

      left.appendChild(now);

      if(isFinite(it.priceOldNum) && it.priceOldNum > it.priceNowNum){
        const old = document.createElement("div");
        old.className = "priceOld";
        old.textContent = moneyBRL(it.priceOldNum);
        left.appendChild(old);
      }

      row1.appendChild(left);

      const right = document.createElement("div");
      right.style.display="flex";
      right.style.gap="8px";
      right.style.flexWrap="wrap";
      right.style.justifyContent="flex-end";

      if(it.discount){
        const t = document.createElement("span");
        t.className = "tag off";
        t.textContent = it.discount;
        right.appendChild(t);
      }
      if(it.coupon){
        const t = document.createElement("span");
        t.className = "tag coupon";
        t.textContent = `CUPOM: ${it.coupon}`;
        right.appendChild(t);
      }

      row1.appendChild(right);
      body.appendChild(row1);

      const row2 = document.createElement("div");
      row2.className = "row";
      row2.innerHTML = `
        <div class="muted">${it.rating ? `‚≠ê ${it.rating}` : "‚≠ê ‚Äî"} &nbsp;‚Ä¢&nbsp; ${it.sold ? `${it.sold} vendidos` : "‚Äî vendidos"}</div>
        <div class="muted">Atualizado: ${nowHHMMSS()}</div>
      `;
      body.appendChild(row2);

      // bot√µes
      const buy = document.createElement("div");
      buy.className = "buy";

      const btn1 = document.createElement("button");
      btn1.className = "btnSmall btnBuy";
      btn1.textContent = "Ver oferta";
      btn1.onclick = () => openOffer(it);
      buy.appendChild(btn1);

      const btn2 = document.createElement("button");
      btn2.className = "btnSmall btnGroup";
      btn2.textContent = "Entrar no grupo";
      btn2.onclick = () => openGroup();
      buy.appendChild(btn2);

      body.appendChild(buy);

      // compartilhar + copiar cupom
      const shareRow = document.createElement("div");
      shareRow.className = "shareRow";

      const btnShare = document.createElement("button");
      btnShare.className = "btnShare";
      btnShare.textContent = "üì§ Compartilhar";
      btnShare.onclick = () => shareOffer(it);
      shareRow.appendChild(btnShare);

      const btnCupom = document.createElement("button");
      btnCupom.className = "btnShare";
      btnCupom.textContent = "üè∑Ô∏è Copiar cupom";
      btnCupom.onclick = () => copyCoupon(it.coupon);
      shareRow.appendChild(btnCupom);

      body.appendChild(shareRow);

      card.appendChild(body);
      grid.appendChild(card);
    }
  }

  // =========================
  // LOAD SHEET
  // =========================
  async function loadSheet(isManual=false){
    try{
      setStatus("loading", (isManual ? "Atualizando agora‚Ä¶ " : "Atualizando‚Ä¶ ") + nowHHMMSS());

      // cache-buster
      const url = SHEET_CSV_URL + (SHEET_CSV_URL.includes("?") ? "&" : "?") + "t=" + Date.now();

      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);

      const text = await res.text();
      const rows = parseCSV(text);
      if(!rows.length) throw new Error("CSV vazio");

      const header = rows[0].map(h => safeText(h).toLowerCase());
      const idx = (...names) => {
        for(const n of names){
          const i = header.indexOf(n);
          if(i >= 0) return i;
        }
        return -1;
      };

      // colunas esperadas:
      // image,title,price (pre√ßo original),discount,coupon,sold,rating,link/affiliate
      const iImage    = idx("image", "img", "imagem");
      const iTitle    = idx("title", "titulo", "nome");
      const iPrice    = idx("price", "preco", "pre√ßo");
      const iDiscount = idx("discount", "desconto");
      const iCoupon   = idx("coupon", "cupom", "c√≥digo", "codigo");
      const iSold     = idx("sold", "vendidos", "vendas");
      const iRating   = idx("rating", "avaliacao", "avalia√ß√£o");
      const iLink     = idx("link", "url");
      const iAff      = idx("affiliate", "afiliado", "link_afiliado", "linkafiliado");

      const items = [];
      for(let r=1; r<rows.length; r++){
        const row = rows[r];

        const title    = safeText(iTitle   >=0 ? row[iTitle]   : "");
        const image    = safeText(iImage   >=0 ? row[iImage]   : "");
        const priceStr = safeText(iPrice   >=0 ? row[iPrice]   : "");
        const discount = safeText(iDiscount>=0 ? row[iDiscount]: "");
        const coupon   = safeText(iCoupon  >=0 ? row[iCoupon]  : "");
        const sold     = safeText(iSold    >=0 ? row[iSold]    : "");
        const rating   = safeText(iRating  >=0 ? row[iRating]  : "");
        const link     = safeText(iLink    >=0 ? row[iLink]    : "");
        const affiliate= safeText(iAff     >=0 ? row[iAff]     : "");

        if(!title && !image && !priceStr && !link && !affiliate) continue;

        const priceOldNum = toNumber(priceStr); // PRICE = pre√ßo original
        const discPercent = parsePercent(discount);
        let priceNowNum = NaN;

        if(isFinite(priceOldNum) && isFinite(discPercent) && discPercent > 0 && discPercent < 100){
          priceNowNum = +(priceOldNum * (1 - discPercent/100)).toFixed(2);
        } else {
          // se n√£o tiver desconto v√°lido, mostra o price como "agora"
          priceNowNum = isFinite(priceOldNum) ? priceOldNum : NaN;
        }

        const soldNum = toNumber(sold);
        const ratingNum = toNumber(rating);

        items.push({
          title: title || "Oferta",
          image,
          priceOldNum,
          priceNowNum,
          discount,
          discountNum: isFinite(discPercent) ? discPercent : 0,
          coupon,
          sold,
          soldNum: isFinite(soldNum) ? soldNum : 0,
          rating,
          ratingNum: isFinite(ratingNum) ? ratingNum : 0,
          link,
          affiliate
        });
      }

      ALL_ITEMS = items;

      setStatus("ok", `√öltima atualiza√ß√£o: ${nowHHMMSS()} ‚Ä¢ ${items.length} ofertas`);
      render();

    }catch(err){
      console.error(err);
      setStatus("error", `Tentando novamente‚Ä¶ ${nowHHMMSS()}`);
      const loading = document.getElementById("loading");
      loading.style.display = "block";
      loading.textContent =
        "N√£o consegui carregar a planilha agora. Verifique se ela est√° publicada e tente atualizar.";
    }
  }

  // =========================
  // EVENTS
  // =========================
  document.getElementById("q").addEventListener("input", () => render());
  document.getElementById("sort").addEventListener("change", () => render());

  // start
  startLiveClock();
  loadSheet();

  // auto refresh
  setInterval(() => loadSheet(false), REFRESH_MS);
</script>

</body>
</html>
