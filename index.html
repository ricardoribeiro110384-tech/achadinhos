<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#ffcc00" />
  <title>Achadinhos do Dia ‚Äî Ofertas do Mercado Livre</title>

  <style>
    :root{
      --yellow:#ffcc00;
      --yellow2:#ffb800;
      --black:#111111;
      --text:#1b1b1b;
      --muted:#6b6b6b;
      --card:#ffffff;
      --stroke:#e9e9e9;
      --shadow: 0 10px 30px rgba(0,0,0,.12);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#f5f5f5;
      color:var(--text);
    }

    /* HEADER */
    header{
      background:linear-gradient(180deg,var(--yellow),var(--yellow2));
      padding:18px 14px 16px;
      border-bottom:1px solid rgba(0,0,0,.08);
      position:sticky; top:0; z-index:50;
    }
    .top{
      max-width:1100px;
      margin:0 auto;
    }
    .brand{
      display:flex;
      align-items:flex-start;
      gap:10px;
      margin-bottom:10px;
    }
    .brand h1{
      margin:0;
      font-size:26px;
      letter-spacing:.2px;
      line-height:1.1;
    }
    .brand p{
      margin:3px 0 0;
      color:rgba(0,0,0,.75);
      font-weight:500;
      font-size:14px;
    }

    /* CONTROLS */
    .controls{
      display:grid;
      grid-template-columns: 1fr 170px 170px;
      gap:10px;
      align-items:center;
    }
    @media (max-width:720px){
      .controls{grid-template-columns: 1fr 1fr;}
      .controls .btn{grid-column:1 / -1;}
    }
    .searchWrap{
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius:999px;
      padding:10px 12px;
      display:flex;
      gap:8px;
      align-items:center;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
    }
    .searchWrap span{opacity:.75}
    .searchWrap input{
      border:0;
      outline:0;
      width:100%;
      font-size:15px;
      background:transparent;
    }
    select{
      width:100%;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      padding:10px 12px;
      font-size:14px;
      background:#fff;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      outline:none;
    }
    .btn{
      border:0;
      border-radius:999px;
      padding:11px 14px;
      font-weight:800;
      cursor:pointer;
      background:var(--black);
      color:#fff;
      box-shadow:0 10px 24px rgba(0,0,0,.18);
      display:flex;
      justify-content:center;
      gap:8px;
      align-items:center;
    }
    .btn:active{transform:translateY(1px)}
    .hint{
      font-size:12px;
      color:rgba(0,0,0,.7);
      margin-top:8px;
    }

    /* MAIN */
    main{
      max-width:1100px;
      margin:16px auto 0;
      padding:0 14px 24px;
    }
    .sectionTitle{
      margin:18px 0 10px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
    }
    .sectionTitle h2{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
      display:flex; gap:8px; align-items:center;
    }
    .sectionTitle small{
      color:var(--muted);
      font-weight:600;
    }

    /* GRID */
    .grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:14px;
    }
    @media (max-width:1050px){ .grid{grid-template-columns: repeat(3,1fr);} }
    @media (max-width:780px){ .grid{grid-template-columns: repeat(2,1fr);} }
    @media (max-width:460px){ .grid{grid-template-columns: 1fr;} }

    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 360px;
    }

    /* IMAGE (fix: n√£o toma a tela inteira) */
    .media{
      width:100%;
      height: 210px;            /* altura fixa pra n√£o estourar */
      background:#fafafa;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
    }
    .media img{
      width:100%;
      height:100%;
      object-fit:contain;       /* N√ÉO cortar nem estourar */
      display:block;
      background:#fff;
    }
    .badgeRow{
      position:absolute;
      top:10px;
      left:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      pointer-events:none;
    }
    .badge{
      background:rgba(0,0,0,.86);
      color:#fff;
      font-size:12px;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      letter-spacing:.2px;
      box-shadow:0 10px 20px rgba(0,0,0,.15);
    }
    .badge.blue{background:rgba(0,90,255,.90)}
    .badge.green{background:rgba(0,140,70,.92)}

    .content{
      padding:12px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      flex:1;
    }
    .title{
      font-size:14px;
      font-weight:800;
      line-height:1.25;
      margin:0;
      min-height: 36px;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .meta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      color:var(--muted);
      font-size:12px;
      font-weight:700;
    }
    .meta .dot{opacity:.45}

    .priceBox{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      margin-top:auto;
    }
    .prices{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .oldPrice{
      color:#8b8b8b;
      text-decoration:line-through;
      font-weight:800;
      font-size:12px;
    }
    .newPrice{
      color:#d80c0c;
      font-weight:1000;
      font-size:20px;
      letter-spacing:.2px;
    }
    .offPill{
      background:#111;
      color:#fff;
      font-weight:1000;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }

    .cta{
      margin-top:10px;
      background:#ff6a00; /* bot√£o laranja como voc√™ gostava */
      border:0;
      color:#fff;
      font-weight:1000;
      padding:12px 12px;
      border-radius:14px;
      cursor:pointer;
      text-align:center;
      text-decoration:none;
      box-shadow:0 14px 28px rgba(255,106,0,.25);
    }
    .cta:active{transform:translateY(1px)}
    .cta small{opacity:.9;font-weight:800}

    /* LOADING / ERROR */
    .loader{
      background:#fff;
      border:1px solid #ffd1d1;
      color:#7a0b0b;
      padding:12px;
      border-radius:14px;
      display:none;
      margin:10px 0;
    }
    .loader.ok{
      border-color:#d7f7e4;
      color:#0a5a2d;
    }

    /* SKELETON */
    .skeleton{
      background:linear-gradient(90deg,#f1f1f1,#fafafa,#f1f1f1);
      background-size: 200% 100%;
      animation: shimmer 1.1s infinite linear;
    }
    @keyframes shimmer{
      0%{background-position:200% 0}
      100%{background-position:-200% 0}
    }

    /* DISCLAIMER (rodap√©) */
    footer.disclaimer{
      margin-top:30px;
      padding:18px 16px;
      background:#111;
      color:#eee;
      text-align:center;
      font-size:13px;
      line-height:1.5;
      border-top:1px solid rgba(255,255,255,.08);
    }
    footer.disclaimer strong{color:var(--yellow)}
    footer.disclaimer a{color:#fff;text-decoration:underline}
  </style>
</head>

<body>
  <header>
    <div class="top">
      <div class="brand">
        <div style="font-size:22px">üî•</div>
        <div>
          <h1>Achadinhos do Dia</h1>
          <p>Ofertas do Mercado Livre que realmente valem a pena</p>
        </div>
      </div>

      <div class="controls">
        <div class="searchWrap">
          <span>üîé</span>
          <input id="q" type="search" placeholder="Buscar produto..." autocomplete="off" />
        </div>

        <select id="preset">
          <option value="dia">‚ö° Achadinhos do Dia</option>
          <option value="ate99">üí∏ At√© R$ 99,00</option>
          <option value="maisPedidos">üõí Mais pedidos</option>
          <option value="relampago">‚ö° Oferta rel√¢mpago</option>
          <option value="todas">üì¶ Todas as ofertas</option>
        </select>

        <button class="btn" id="btnReload" type="button">‚ö° Ver ofertas</button>
      </div>

  </header>

  <main>
    <div id="status" class="loader ok">Carregando ofertas‚Ä¶ aguarde.</div>
    <div id="error" class="loader">N√£o carregou as ofertas.</div>

    <div class="sectionTitle">
      <h2 id="sectionName">‚ö° Achadinhos do Dia</h2>
      <small id="sectionInfo"></small>
    </div>

    <div id="grid" class="grid"></div>

    <footer class="disclaimer">
      <p>
        ‚ö†Ô∏è <strong>Aviso importante:</strong>
        N√£o somos uma loja oficial.
        Este site apenas divulga ofertas e promo√ß√µes do Mercado Livre.
        Os pre√ßos, prazos e condi√ß√µes s√£o de responsabilidade do vendedor.
      </p>
    </footer>
  </main>

  <script>
    /***********************
     * CONFIG
     ***********************/
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYh-FJUhtB7MT80tKHccZi-z1hTKUOwDqg-tQSR_YPiDOQv-mKmSjTyAtZzmhq8YEchYOjqcVZhJv3/pub?output=csv";

    // Cache para carregar mais r√°pido nas pr√≥ximas visitas (reduz ‚Äúdemora um pouco‚Äù)
    const CACHE_KEY = "achadinhos_cache_v1";
    const CACHE_TTL_MS = 1000 * 60 * 20; // 20 min

    /***********************
     * HELPERS
     ***********************/
    const $ = (id) => document.getElementById(id);

    function parseDiscountPercent(s){
      if(!s) return 0;
      const m = String(s).replace(",",".").match(/(\d+(\.\d+)?)/);
      return m ? Math.max(0, Math.min(99, parseFloat(m[1]))) : 0;
    }

    function parseBRLToNumber(v){
      if(v === null || v === undefined) return 0;
      let s = String(v).trim();
      if(!s) return 0;
      // remove "R$" e espa√ßos
      s = s.replace(/R\$\s?/gi,"").trim();
      // remove separador de milhar '.' e troca v√≠rgula por ponto
      s = s.replace(/\./g,"").replace(",",".");
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : 0;
    }

    function formatBRL(n){
      return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    }

    function parseSold(v){
      if(v === null || v === undefined) return 0;
      let s = String(v).toLowerCase().trim();
      if(!s) return 0;

      // "10 mil", "10 MIL"
      const milMatch = s.match(/(\d+([.,]\d+)?)\s*mil/);
      if(milMatch){
        const base = parseFloat(milMatch[1].replace(".","").replace(",",".")) || 0;
        return Math.round(base * 1000);
      }

      // "1.000", "1000"
      s = s.replace(/\./g,"").replace(/\s/g,"");
      const n = parseInt(s,10);
      return Number.isFinite(n) ? n : 0;
    }

    function parseRating(v){
      const n = parseFloat(String(v).replace(",","."));
      return Number.isFinite(n) ? n : 0;
    }

    // CSV robusto (suporta v√≠rgula e valores com aspas)
    function parseCSV(text){
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for(let i=0;i<text.length;i++){
        const ch = text[i];
        const next = text[i+1];

        if(ch === '"' ){
          if(inQuotes && next === '"'){ cur += '"'; i++; }
          else inQuotes = !inQuotes;
        } else if(ch === "," && !inQuotes){
          row.push(cur); cur = "";
        } else if((ch === "\n" || ch === "\r") && !inQuotes){
          if(ch === "\r" && next === "\n"){ /* windows */ i++; }
          row.push(cur);
          if(row.some(c => String(c).trim() !== "")) rows.push(row);
          row = []; cur = "";
        } else {
          cur += ch;
        }
      }
      // last
      row.push(cur);
      if(row.some(c => String(c).trim() !== "")) rows.push(row);
      return rows;
    }

    function normalizeHeader(h){
      return String(h || "")
        .trim()
        .toLowerCase()
        .replace(/\s+/g,"_");
    }

    function uniqByLink(items){
      const map = new Map();
      for(const it of items){
        const key = (it.link || "").trim();
        if(!key) continue;
        if(!map.has(key)) map.set(key, it);
      }
      return [...map.values()];
    }

    function computeFinalPrice(full, discountPct){
      const p = Math.max(0, full);
      const d = Math.max(0, Math.min(99, discountPct));
      const final = p * (1 - d/100);
      return Math.round(final * 100) / 100;
    }

    /***********************
     * UI
     ***********************/
    function setStatus(msg, ok=true){
      const el = $("status");
      if(!msg){
        el.style.display = "none";
        return;
      }
      el.textContent = msg;
      el.className = "loader " + (ok ? "ok" : "");
      el.style.display = "block";
    }

    function setError(msg){
      const el = $("error");
      if(!msg){
        el.style.display = "none";
        return;
      }
      el.textContent = msg;
      el.style.display = "block";
    }

    function makeSkeleton(count=8){
      const grid = $("grid");
      grid.innerHTML = "";
      for(let i=0;i<count;i++){
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="media skeleton"></div>
          <div class="content">
            <div class="skeleton" style="height:14px;border-radius:10px;"></div>
            <div class="skeleton" style="height:14px;border-radius:10px;width:70%;"></div>
            <div class="skeleton" style="height:10px;border-radius:10px;width:80%; margin-top:8px;"></div>
            <div class="skeleton" style="height:42px;border-radius:12px;margin-top:auto;"></div>
            <div class="skeleton" style="height:42px;border-radius:14px;"></div>
          </div>
        `;
        grid.appendChild(card);
      }
    }

    function cardHTML(p){
      const soldTxt = p.sold > 0 ? `${p.sold.toLocaleString("pt-BR")} vendidos` : "";
      const ratingTxt = p.rating > 0 ? `‚≠ê ${p.rating.toFixed(1)}` : "";

      const off = p.discountPct > 0 ? `${Math.round(p.discountPct)}% OFF` : "";
      const fullPrice = formatBRL(p.priceFull);
      const finalPrice = formatBRL(p.priceFinal);

      return `
        <div class="card">
          <div class="media">
            <div class="badgeRow">
              ${off ? `<span class="badge">${off}</span>` : ``}
              ${p.sold > 0 ? `<span class="badge blue">${soldTxt}</span>` : ``}
            </div>
            <img loading="lazy" alt="${escapeHTML(p.title)}" data-src="${escapeAttr(p.image)}" />
          </div>

          <div class="content">
            <p class="title">${escapeHTML(p.title)}</p>

            <div class="meta">
              ${ratingTxt ? `<span>${ratingTxt}</span><span class="dot">‚Ä¢</span>` : ``}
              ${p.coupon ? `<span>üéüÔ∏è Cupom</span><span class="dot">‚Ä¢</span>` : ``}
              ${p.category ? `<span>${escapeHTML(p.category)}</span>` : ``}
            </div>

            <div class="priceBox">
              <div class="prices">
                <div class="oldPrice">${fullPrice}</div>
                <div class="newPrice">${finalPrice}</div>
              </div>
              ${p.discountPct > 0 ? `<div class="offPill">-${Math.round(p.discountPct)}%</div>` : ``}
            </div>

            <a class="cta" href="${escapeAttr(p.link)}" target="_blank" rel="nofollow noopener">
              Ver oferta <small>‚Üó</small>
            </a>
          </div>
        </div>
      `;
    }

    function escapeHTML(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(s){ return escapeHTML(s); }

    // lazy images + fallback
    function mountLazyImages(){
      const imgs = document.querySelectorAll("img[data-src]");
      const obs = new IntersectionObserver((entries)=>{
        entries.forEach(e=>{
          if(!e.isIntersecting) return;
          const img = e.target;
          const src = img.getAttribute("data-src");
          img.removeAttribute("data-src");
          img.src = src;
          img.onerror = () => {
            img.style.objectFit = "contain";
            img.style.background = "#fff";
          };
          obs.unobserve(img);
        });
      }, {rootMargin:"300px 0px"});
      imgs.forEach(img=>obs.observe(img));
    }

    /***********************
     * DATA
     ***********************/
    let ALL = [];

    function readCache(){
      try{
        const raw = localStorage.getItem(CACHE_KEY);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(!obj || !obj.ts || !obj.items) return null;
        if(Date.now() - obj.ts > CACHE_TTL_MS) return null;
        return obj.items;
      }catch(e){ return null; }
    }
    function writeCache(items){
      try{
        localStorage.setItem(CACHE_KEY, JSON.stringify({ts:Date.now(), items}));
      }catch(e){}
    }

    async function fetchCSV(){
      // cache-buster p/ evitar ‚Äútravadas‚Äù e pegar atualiza√ß√£o
      const url = CSV_URL + (CSV_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
      const res = await fetch(url, {cache:"no-store"});
      if(!res.ok) throw new Error("HTTP " + res.status);
      return await res.text();
    }

    function rowsToProducts(rows){
      if(!rows || rows.length < 2) return [];
      const headers = rows[0].map(normalizeHeader);
      const idx = (name) => headers.indexOf(name);

      // seus campos na planilha (pelo print):
      // image, title, price, discount, coupon, sold, rating, link
      const iImage = idx("image");
      const iTitle = idx("title");
      const iPrice = idx("price");
      const iDiscount = idx("discount");
      const iCoupon = idx("coupon");
      const iSold = idx("sold");
      const iRating = idx("rating");
      const iLink = idx("link");
      const iCategory = idx("category"); // se existir (opcional)

      const items = [];
      for(let r=1;r<rows.length;r++){
        const row = rows[r];
        const title = (row[iTitle] ?? "").trim();
        const link = (row[iLink] ?? "").trim();
        const image = (row[iImage] ?? "").trim();

        if(!title || !link || !image) continue;

        const priceFull = parseBRLToNumber(row[iPrice]);
        const discountPct = parseDiscountPercent(row[iDiscount]);
        const priceFinal = computeFinalPrice(priceFull, discountPct);

        items.push({
          title,
          link,
          image,
          priceFull,
          discountPct,
          priceFinal,
          coupon: (row[iCoupon] ?? "").trim(),
          sold: parseSold(row[iSold]),
          rating: parseRating(row[iRating]),
          category: iCategory >= 0 ? (row[iCategory] ?? "").trim() : ""
        });
      }
      return uniqByLink(items);
    }

    /***********************
     * FILTERS / PRESETS
     ***********************/
    function applyPreset(preset, queryText){
      let list = [...ALL];

      // busca
      const q = (queryText || "").trim().toLowerCase();
      if(q){
        list = list.filter(x => (x.title || "").toLowerCase().includes(q));
      }

      // presets
      let name = "‚ö° Achadinhos do Dia";
      let info = "";

      if(preset === "dia"){
        name = "‚ö° Achadinhos do Dia";
        // mais chance de compra => mais vendidos primeiro
        list.sort((a,b)=> (b.sold - a.sold) || (b.discountPct - a.discountPct) || (a.priceFinal - b.priceFinal));
        info = `Ordenado por ‚Äúsold‚Äù (mais pedidos primeiro).`;
      }

      if(preset === "ate99"){
        name = "üí∏ At√© R$ 99,00";
        list = list.filter(x => x.priceFinal > 0 && x.priceFinal <= 99);
        list.sort((a,b)=> (a.priceFinal - b.priceFinal) || (b.discountPct - a.discountPct) || (b.sold - a.sold));
        info = `Filtrando por pre√ßo final ‚â§ R$ 99,00.`;
      }

      if(preset === "maisPedidos"){
        name = "üõí Mais pedidos";
        list.sort((a,b)=> (b.sold - a.sold) || (b.discountPct - a.discountPct));
        info = `Selecionados por ‚Äúsold‚Äù alto.`;
      }

      if(preset === "relampago"){
        name = "‚ö° Oferta rel√¢mpago";
        list.sort((a,b)=> (b.discountPct - a.discountPct) || (b.sold - a.sold));
        info = `Maior desconto primeiro.`;
      }

      if(preset === "todas"){
        name = "üì¶ Todas as ofertas";
        list.sort((a,b)=> (b.discountPct - a.discountPct) || (b.sold - a.sold));
        info = `Todas as ofertas carregadas.`;
      }

      $("sectionName").textContent = name;
      $("sectionInfo").textContent = `${info}  ‚Ä¢  Itens: ${list.length}`;

      render(list.slice(0, 120)); // limite p/ n√£o pesar muito
    }

    function render(list){
      const grid = $("grid");
      grid.innerHTML = list.map(cardHTML).join("");
      mountLazyImages();
    }

    /***********************
     * INIT
     ***********************/
    async function loadAll(force=false){
      setError("");
      setStatus("Carregando ofertas‚Ä¶ aguarde.", true);
      makeSkeleton(8);

      // tenta cache primeiro (mais r√°pido)
      if(!force){
        const cached = readCache();
        if(cached && Array.isArray(cached) && cached.length){
          ALL = cached;
          setStatus("", true);
          return;
        }
      }

      try{
        const csvText = await fetchCSV();
        const rows = parseCSV(csvText);
        const products = rowsToProducts(rows);

        if(!products.length){
          setStatus("", true);
          setError("A planilha carregou, mas n√£o encontrei produtos v√°lidos. Verifique se as colunas est√£o: image, title, price, discount, coupon, sold, rating, link.");
          ALL = [];
          $("grid").innerHTML = "";
          return;
        }

        ALL = products;
        writeCache(products);
        setStatus("", true);
      }catch(err){
        // erro comum quando abre por file:// no celular/PC (CORS)
        setStatus("", true);
        setError("N√£o carregou as ofertas: Failed to fetch. Abra o site via GitHub Pages/https (n√£o via arquivo local) e verifique se o link CSV est√° p√∫blico.");
        ALL = [];
        $("grid").innerHTML = "";
      }
    }

    // events
    $("btnReload").addEventListener("click", async ()=>{
      await loadAll(true);
      applyPreset($("preset").value, $("q").value);
    });

    $("preset").addEventListener("change", ()=>{
      applyPreset($("preset").value, $("q").value);
    });

    let qTimer = null;
    $("q").addEventListener("input", ()=>{
      clearTimeout(qTimer);
      qTimer = setTimeout(()=> applyPreset($("preset").value, $("q").value), 180);
    });

    // start
    (async function(){
      await loadAll(false);
      applyPreset("dia", "");
    })();
  </script>
</body>
</html>
