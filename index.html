<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Achadinhos Oficial</title>

  <style>
    :root{
      --yellow:#f6c100;
      --bg:#f3f3f3;
      --card:#ffffff;
      --text:#101010;
      --muted:#6b6b6b;
      --shadow: 0 8px 24px rgba(0,0,0,.08);
      --radius: 22px;
      --btn:#111;
      --btnText:#fff;
      --accent:#ff6a00;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}

    header{
      background:linear-gradient(180deg,var(--yellow),#f7d24d);
      padding:16px 14px 18px;
      border-bottom-left-radius:28px;
      border-bottom-right-radius:28px;
      box-shadow: var(--shadow);
    }
    .headRow{
      max-width:1100px;margin:0 auto;
      display:flex; gap:12px; align-items:center;
      padding:0 14px;
    }
    .logo{
      width:54px;height:54px;border-radius:14px;background:#fff;display:flex;align-items:center;justify-content:center;
      box-shadow: 0 8px 18px rgba(0,0,0,.12);
      overflow:hidden; flex:0 0 auto;
    }
    .logo img{width:100%;height:100%;object-fit:contain}
    .brand h1{margin:0;font-size:22px;line-height:1.1}
    .brand p{margin:6px 0 0;color:#2c2c2c;font-weight:600}

    .controls{
      max-width:1100px;margin:12px auto 0;
      padding:0 14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }

    .bar{
      background:rgba(255,255,255,.65);
      backdrop-filter: blur(8px);
      border-radius:999px;
      padding:10px 12px;
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .search{
      flex:1 1 240px;
      display:flex; gap:10px; align-items:center;
      background:#fff;border-radius:999px;padding:10px 12px;
      border:1px solid rgba(0,0,0,.06);
      min-width:220px;
    }
    .search input{
      border:0; outline:0; width:100%;
      font-size:16px;
    }

    .field{
      display:flex;align-items:center;gap:8px;
      background:#fff;border-radius:999px;padding:10px 12px;
      border:1px solid rgba(0,0,0,.06);
    }
    .field label{font-size:13px;color:var(--muted);font-weight:700}
    .field select{
      border:0; outline:0;
      font-size:14px;
      background:transparent;
      min-width:180px;
    }

    /* ‚úÖ Mobile bem renderizado */
    @media (max-width: 700px){
      .headRow{padding:0 10px}
      .controls{padding:0 10px}
      .bar{border-radius:22px}
      .search{min-width:0; flex:1 1 100%}
      .field{flex:1 1 100%}
      .field select{min-width:0; width:100%}
    }

    main{max-width:1100px;margin:14px auto 70px;padding:0 14px}
    .status{
      background:#fff;border-radius:999px;padding:10px 14px;
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      box-shadow: var(--shadow);
      color:var(--muted);
      font-weight:700;
    }
    .status b{color:#111}

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:14px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 520px){ .grid{grid-template-columns: 1fr;} }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 440px;
    }
    .imgWrap{position:relative;background:#fff}
    .imgWrap img{
      width:100%;
      height:260px;
      object-fit:contain;
      display:block;
      background:#fff;
    }
    .pill{
      position:absolute;top:10px;left:10px;
      background:#111;color:#fff;
      padding:7px 10px;border-radius:999px;
      font-weight:900;font-size:13px;
    }
    .pill.blue{
      left:auto; right:10px;
      background:#1b6cff;
    }

    .body{padding:12px 14px 14px;display:flex;flex-direction:column;gap:8px;flex:1}
    .title{margin:0;font-size:16px;line-height:1.25}
    .meta{display:flex;align-items:center;gap:10px;color:var(--muted);font-weight:700}
    .prices{display:flex;align-items:flex-end;gap:12px;flex-wrap:wrap}
    .old{color:#8a8a8a;text-decoration:line-through;font-weight:800}
    .new{color:#c90000;font-weight:1000;font-size:34px;letter-spacing:-.5px}
    .disc{
      margin-left:auto;
      background:#111;color:#fff;
      padding:8px 12px;border-radius:999px;
      font-weight:1000;
    }
    .cta{
      margin-top:auto;
      display:flex;gap:10px;
    }
    .cta a{
      flex:1;
      text-decoration:none;
      background:var(--accent);
      color:#fff;
      text-align:center;
      padding:12px 14px;
      border-radius:16px;
      font-weight:1000;
      display:inline-flex;justify-content:center;align-items:center;gap:8px;
    }
    .cta a:active{transform:translateY(1px)}
    .loadMore{
      margin:16px auto 0;
      display:flex;justify-content:center;
    }

    footer{
      margin-top:18px;
      background:#111;color:#cfcfcf;
      padding:16px 14px;
      text-align:center;
      font-weight:700;
    }
  </style>
</head>

<body>

<header>
  <div class="headRow">
    <div class="logo">
      <img src="logo.png" alt="Achadinhos Oficial">
    </div>
    <div class="brand">
      <h1>Achadinhos Oficial</h1>
      <p>Ofertas do Mercado Livre que realmente valem a pena</p>
    </div>
  </div>

  <div class="controls">
    <div class="bar">
      <div class="search" title="Buscar pelo nome do produto">
        üîé <input id="q" type="search" placeholder="Buscar produto..." autocomplete="off" />
      </div>

      <div class="field" title="Ordenar resultados">
        <label>Ordenar</label>
        <select id="sort">
          <option value="sold_desc">Mais vendidos</option>
          <option value="discount_desc">Maior desconto</option>
          <option value="rating_desc">Melhor avalia√ß√£o</option>
          <option value="price_asc">Menor pre√ßo</option>
          <option value="price_desc">Maior pre√ßo</option>
        </select>
      </div>

      <!-- REMOVIDOS: R$ m√≠n / R$ m√°x / Limpar -->
    </div>
  </div>
</header>

<main>
  <div class="status">
    <span id="statusLeft"><b>Carregando...</b></span>
    <span id="statusRight"></span>
  </div>

  <div id="grid" class="grid"></div>

  <div class="loadMore">
    <button id="more" class="btn" type="button" style="display:none;">Carregar mais</button>
  </div>

  <footer>
    N√£o somos loja oficial. Apenas divulgamos ofertas do Mercado Livre.
  </footer>
</main>

<script defer>
  const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRhh2oOPrSTXYeBKgnOObgib3q1Q5bMD3PQewuZXQJSfXOjaSmq9rJv6sUVgen50vz_nUCtlz7I3kng/pub?output=csv";
  const PAGE_SIZE = 24;

  let all = [];
  let filtered = [];
  let shown = 0;

  const elGrid = document.getElementById("grid");
  const elMore = document.getElementById("more");
  const elQ = document.getElementById("q");
  const elSort = document.getElementById("sort");
  const stLeft = document.getElementById("statusLeft");
  const stRight = document.getElementById("statusRight");

  const toNumber = (v) => {
    if (v === null || v === undefined) return NaN;
    const s = String(v).trim();
    if (!s) return NaN;
    const norm = s.replace(/\s/g,"").replace(/\./g,"").replace(",",".");
    const num = Number(norm);
    return Number.isFinite(num) ? num : NaN;
  };

  const parseDiscount = (v) => {
    const s = String(v ?? "").toUpperCase();
    const m = s.match(/(\d+(?:[.,]\d+)?)\s*%/);
    if (!m) return 0;
    const n = Number(String(m[1]).replace(",","."));
    return Number.isFinite(n) ? n : 0;
  };

  const parseSold = (v) => {
    const s = String(v ?? "").toLowerCase().replace(/\./g,"").trim();
    if (!s) return 0;
    const m = s.match(/(\d+(?:[.,]\d+)?)(\s*(mil|k))?/);
    if (!m) return 0;
    let n = Number(String(m[1]).replace(",","."));
    if (!Number.isFinite(n)) return 0;
    if (m[3] === "mil" || m[3] === "k") n *= 1000;
    return Math.round(n);
  };

  const money = (n) => n.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
  const safeText = (s) => (s ?? "").toString();

  function computeFinalPrice(fullPrice, discountPct){
    const p = fullPrice;
    const d = discountPct;
    if (!Number.isFinite(p) || p <= 0) return NaN;
    const fin = p * (1 - (d/100));
    return Math.max(0, fin);
  }

  function parseCSV(text){
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i=0; i<text.length; i++){
      const ch = text[i];
      const next = text[i+1];

      if (ch === '"'){
        if (inQuotes && next === '"'){ cur += '"'; i++; }
        else { inQuotes = !inQuotes; }
        continue;
      }

      if (!inQuotes && ch === ","){ row.push(cur); cur = ""; continue; }

      if (!inQuotes && (ch === "\n" || ch === "\r")){
        if (ch === "\r" && next === "\n") i++;
        row.push(cur); cur = "";
        rows.push(row); row = [];
        continue;
      }

      cur += ch;
    }
    if (cur.length || row.length){ row.push(cur); rows.push(row); }

    const header = rows.shift().map(h => h.trim());
    return rows
      .filter(r => r.some(c => String(c).trim() !== ""))
      .map(r => {
        const obj = {};
        header.forEach((h, idx) => obj[h] = r[idx] ?? "");
        return obj;
      });
  }

  function normalize(item){
    const title = safeText(item.title);
    const image = safeText(item.image);
    const link  = safeText(item.link);

    const fullPrice = toNumber(item.price);
    const discountPct = parseDiscount(item.discount);
    const ratingRaw = toNumber(item.rating);
    const sold = parseSold(item.sold);

    const finalPrice = computeFinalPrice(fullPrice, discountPct);

    // ‚úÖ rating com ponto e corrigindo caso venha 48 ao inv√©s de 4.8
    let r = Number.isFinite(ratingRaw) ? ratingRaw : null;
    if (r !== null && r >= 10) r = r / 10;

    return {
      title,
      image,
      link,
      fullPrice,
      discountPct,
      rating: r,
      sold,
      finalPrice,
    };
  }

  function applyFilters(){
    const q = elQ.value.trim().toLowerCase();

    filtered = all.filter(p => {
      if (!p.title || !p.image || !p.link) return false;
      if (q && !p.title.toLowerCase().includes(q)) return false;
      return true;
    });

    sortFiltered();
    shown = 0;
    elGrid.innerHTML = "";
    renderNext();
  }

  function sortFiltered(){
    const s = elSort.value;
    const getPrice = (p) => Number.isFinite(p.finalPrice) ? p.finalPrice : p.fullPrice;

    filtered.sort((a,b) => {
      if (s === "sold_desc") return (b.sold||0) - (a.sold||0);
      if (s === "discount_desc") return (b.discountPct||0) - (a.discountPct||0);
      if (s === "rating_desc") return ( (b.rating??-1) - (a.rating??-1) );
      if (s === "price_asc") return getPrice(a) - getPrice(b);
      if (s === "price_desc") return getPrice(b) - getPrice(a);
      return 0;
    });
  }

  function renderCard(p){
    const discTxt = `-${Math.round(p.discountPct || 0)}%`;
    const soldTxt = p.sold ? `${p.sold.toLocaleString("pt-BR")} vendidos` : "";
    const full = Number.isFinite(p.fullPrice) ? money(p.fullPrice) : "";
    const final = Number.isFinite(p.finalPrice) ? money(p.finalPrice) : full;

    const ratingTxt = (p.rating !== null && Number.isFinite(p.rating)) ? p.rating.toFixed(1) : null;

    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div class="imgWrap">
        <img loading="lazy" src="${p.image}" alt="${p.title}">
        <div class="pill">${Math.round(p.discountPct || 0)}% OFF</div>
        ${soldTxt ? `<div class="pill blue">${soldTxt}</div>` : ""}
      </div>
      <div class="body">
        <h3 class="title">${p.title}</h3>
        <div class="meta">
          ${ratingTxt ? `‚≠ê ${ratingTxt}` : ``}
        </div>
        <div class="prices">
          <div class="old">${full}</div>
          <div class="new">${final}</div>
          <div class="disc">${discTxt}</div>
        </div>
        <div class="cta">
          <a href="${p.link}" target="_blank" rel="noopener">‚ö° Ver oferta</a>
        </div>
      </div>
    `;
    return div;
  }

  function renderNext(){
    const total = filtered.length;

    if (total === 0){
      stLeft.innerHTML = `<b>Nenhum produto encontrado</b>`;
      stRight.textContent = "";
      elMore.style.display = "none";
      return;
    }

    const next = filtered.slice(shown, shown + PAGE_SIZE);
    next.forEach(p => elGrid.appendChild(renderCard(p)));
    shown += next.length;

    stLeft.innerHTML = `<b>Mostrando ${Math.min(shown,total)} de ${total}</b>`;
    stRight.textContent = "";

    elMore.style.display = shown < total ? "inline-flex" : "none";
  }

  async function init(){
    try{
      stLeft.innerHTML = `<b>Carregando...</b>`;
      const res = await fetch(SHEET_CSV, { cache: "no-store" });
      if (!res.ok) throw new Error("Falha ao abrir planilha");
      const text = await res.text();

      const raw = parseCSV(text);
      all = raw.map(normalize).filter(p => p.title && p.image && p.link);

      applyFilters();
    }catch(err){
      stLeft.innerHTML = `<b>N√£o carregou as ofertas</b>`;
      stRight.textContent = "Verifique se o link CSV est√° p√∫blico.";
      console.error(err);
    }
  }

  let t = null;
  elQ.addEventListener("input", () => {
    clearTimeout(t);
    t = setTimeout(applyFilters, 220);
  });
  elSort.addEventListener("change", applyFilters);
  elMore.addEventListener("click", renderNext);

  init();
</script>

</body>
</html>
