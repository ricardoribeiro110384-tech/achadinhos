<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Achadinhos Oficial</title>
  <link rel="icon" href="logo.png"/>
  <style>
    :root{
      --yellow:#f5c400; --yellow2:#ffdb3a;
      --bg:#f4f4f4; --card:#fff; --text:#111; --muted:#666;
      --shadow:0 12px 30px rgba(0,0,0,.10); --radius:18px;
      --danger:#c40000; --chip:#111; --blue:#1b75ff;
      --btn:#ff6a00;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{
      background:linear-gradient(180deg,var(--yellow2),var(--yellow));
      padding:16px; position:sticky; top:0; z-index:10;
      box-shadow:0 6px 18px rgba(0,0,0,.10);
    }
    .wrap{max-width:1040px;margin:0 auto}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:42px;height:42px;border-radius:14px;background:#fff;display:grid;place-items:center;overflow:hidden;box-shadow:0 10px 24px rgba(0,0,0,.12)}
    .logo img{width:100%;height:100%;object-fit:contain;padding:6px}
    h1{margin:0;font-size:22px;line-height:1.1}
    .sub{margin:6px 0 0;color:rgba(0,0,0,.72);font-weight:800;font-size:13px}

    main{padding:16px}
    .blocks{
      display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;
      margin-bottom:14px;
    }
    @media(min-width:720px){ .blocks{grid-template-columns:repeat(5,minmax(0,1fr));} }
    .b{
      background:var(--card);border-radius:14px;box-shadow:var(--shadow);
      padding:12px;cursor:pointer;font-weight:1000;text-align:center;
      user-select:none;
    }
    .b.active{outline:3px solid rgba(0,0,0,.12)}

    .controls{
      display:grid;gap:10px;margin:12px 0;
      grid-template-columns:1fr;
    }
    @media(min-width:860px){ .controls{grid-template-columns:1fr 220px;} }
    .search{
      background:#fff;border-radius:999px;padding:12px 14px;display:flex;gap:10px;align-items:center;
      box-shadow:0 10px 22px rgba(0,0,0,.10);
    }
    .search input{border:0;outline:0;width:100%;font-size:15px}
    .pill{
      background:#fff;border-radius:999px;padding:12px 14px;font-weight:1000;
      box-shadow:0 10px 22px rgba(0,0,0,.10); text-align:center;
    }

    .err{background:#ffe6e6;border:1px solid #ffb0b0;border-radius:14px;padding:12px 14px;color:#7a0000;font-weight:1000}

    .grid{
      display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:14px;
    }
    @media(min-width:640px){ .grid{grid-template-columns:repeat(2,minmax(0,1fr));} }
    @media(min-width:980px){ .grid{grid-template-columns:repeat(3,minmax(0,1fr));} }

    /* ‚úÖ CARD sem recorte */
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      height:auto;          /* <- sem altura fixa */
      min-height:0;         /* <- remove min-height que causa ‚Äúcorte‚Äù */
    }

    /* ‚úÖ imagem com propor√ß√£o est√°vel (n√£o estoura nem some) */
    .img{
      background:#fff;
      position:relative;
      border-bottom:1px solid rgba(0,0,0,.06);
      aspect-ratio: 4 / 3;     /* <- evita bagun√ßa com imagens ‚Äúaltas‚Äù */
      width:100%;
      display:grid;
      place-items:center;
    }
    .img img{
      width:100%;
      height:100%;
      object-fit:contain;
      padding:10px;
    }

    .chips{position:absolute;left:10px;top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:var(--chip);color:#fff;font-weight:1000;font-size:12px;padding:6px 10px;border-radius:999px;box-shadow:0 10px 22px rgba(0,0,0,.16)}
    .chip.blue{background:var(--blue)}

    .body{padding:14px;display:flex;flex-direction:column;gap:10px}
    .t{font-weight:1000;font-size:16px;line-height:1.2}
    .prices{display:flex;align-items:flex-end;justify-content:space-between;gap:10px}
    .full{color:#777;text-decoration:line-through;font-weight:900}
    .final{color:var(--danger);font-weight:1000;font-size:30px;letter-spacing:-.5px}
    .badge{background:#111;color:#fff;border-radius:999px;padding:8px 12px;font-weight:1000;white-space:nowrap}

    /* ‚úÖ bot√£o no rodap√© do card */
    .cta{padding:0 14px 14px}
    .cta a{
      display:block;
      text-decoration:none;
      background:var(--btn);
      color:#fff;
      text-align:center;
      font-weight:1000;
      padding:12px 14px;
      border-radius:999px;
      box-shadow:0 10px 22px rgba(0,0,0,.16);
    }
    .cta a:active{transform:scale(.99)}

    .loadWrap{margin-top:14px;display:flex;justify-content:center}
    button.btn{background:#111;color:#fff;border:0;border-radius:999px;padding:12px 14px;font-weight:1000;cursor:pointer;box-shadow:0 10px 22px rgba(0,0,0,.18)}
    footer{margin-top:18px;padding:14px 16px 22px;color:#fff;background:#111;text-align:center;font-weight:900}
    footer small{display:block;color:rgba(255,255,255,.72);font-weight:700;margin-top:6px}

    /* evita qualquer ‚Äúcorte‚Äù por layout externo */
    .grid, .card, .body{min-width:0}
    .blocks {
  display: none !important;
}
  </style>
</head>

<body>
<header>
  <div class="wrap brand">
    <div class="logo"><img src="logo.png" alt="Achadinhos"/></div>
    <div>
      <h1>Achadinhos Oficial</h1>
      <div class="sub">Ofertas do Mercado Livre que realmente valem a pena</div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="blocks" id="blocks">
    <div class="b active" data-b="tudo">üìã Ver tudo</div>
    <div class="b" data-b="dia">‚ö° Ofertas do dia</div>
    <div class="b" data-b="flash">‚è±Ô∏è Rel√¢mpago</div>
    <div class="b" data-b="mais">üõí Mais pedidos</div>
    <div class="b" data-b="ate99">üí∏ At√© 99</div>
  </div>

  <div class="controls">
    <div class="search">
      <span>üîé</span>
      <input id="q" type="search" placeholder="Buscar produto..." autocomplete="off"/>
    </div>
    <div class="pill" id="pillInfo">Carregando‚Ä¶</div>
  </div>

  <div id="msg"></div>
  <div class="grid" id="grid"></div>

  <div class="loadWrap">
    <button class="btn" id="loadMore" style="display:none;">Carregar mais</button>
  </div>
</main>

<footer>
  N√£o somos loja oficial. Apenas divulgamos ofertas do Mercado Livre.
  <small>Os pre√ßos podem mudar a qualquer momento no Mercado Livre.</small>
</footer>

<script defer>
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYh-FJUhtB7MT80tKHccZi-z1hTKUOwDqg-tQSR_YPiDOQv-mKmSjTyAtZzmhq8YEchYOjqcVZhJv3/pub?output=csv";
  const PAGE_SIZE = 24;

  const $ = (id)=>document.getElementById(id);
  let ALL = [];
  let CURRENT = "tudo";
  let shownCount = PAGE_SIZE;

  function parsePriceBR(v){
    const s = String(v ?? "").trim();
    if(!s) return NaN;
    const clean = s.replace(/\./g,"").replace(",",".");
    const n = Number(clean);
    return isFinite(n) ? n : NaN;
  }
  function getDiscountPct(row){
    const s = String(row.discount ?? "").toUpperCase();
    const m = s.match(/(\d+(\.\d+)?)/);
    return m ? Number(m[1]) : 0;
  }
  function parseSold(v){
    const s = String(v ?? "").trim().toLowerCase().replace(/\./g,"").replace(",",".");
    if(!s) return 0;
    if (s.includes("mil")) {
      const n = parseFloat(s.replace("mil","").trim());
      return isNaN(n) ? 0 : Math.round(n*1000);
    }
    const n = parseFloat(s);
    return isNaN(n) ? 0 : Math.round(n);
  }
  function moneyBR(n){
    if(!isFinite(n)) return "";
    return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  }
  function calcFinal(row){
    const full = parsePriceBR(row.price);
    const pct = getDiscountPct(row);
    if(!isFinite(full) || full<=0) return NaN;
    return Math.max(0, full * (1 - pct/100));
  }

  // CSV robusto (aspas e v√≠rgulas no t√≠tulo)
  function parseCSV(text){
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    text = String(text || "").replace(/\r/g, "");

    for (let i = 0; i < text.length; i++){
      const ch = text[i];
      const next = text[i+1];

      if (ch === '"'){
        if (inQuotes && next === '"'){ cur += '"'; i++; }
        else { inQuotes = !inQuotes; }
        continue;
      }

      if (ch === "," && !inQuotes){
        row.push(cur); cur = ""; continue;
      }
      if (ch === "\n" && !inQuotes){
        row.push(cur); rows.push(row);
        row = []; cur = ""; continue;
      }
      cur += ch;
    }
    if (cur.length || row.length){ row.push(cur); rows.push(row); }

    const cleanRows = rows.filter(r => r.some(c => String(c).trim() !== ""));
    if (!cleanRows.length) return [];

    const headers = cleanRows.shift().map(h => String(h||"").trim());
    const out = [];

    for (const r of cleanRows){
      const obj = {};
      headers.forEach((h, idx)=> obj[h] = String(r[idx] ?? "").trim());

      obj.fullPrice = parsePriceBR(obj.price);
      obj.discountPct = getDiscountPct(obj);
      obj.finalPrice = calcFinal(obj);
      obj.soldNum = parseSold(obj.sold);

      if (obj.link && obj.image && obj.title) out.push(obj);
    }
    return out;
  }

  function scoreDia(r){
    return (r.discountPct * 3) + Math.log10((r.soldNum || 0) + 1);
  }

  function applySearch(list){
    const q = $("q").value.trim().toLowerCase();
    if(!q) return list;
    return list.filter(r => String(r.title).toLowerCase().includes(q));
  }

  function getSortedList(blockKey){
    let list = ALL.slice();

    if(blockKey === "flash"){
      list.sort((a,b)=> (b.discountPct - a.discountPct) || (b.soldNum - a.soldNum));
    } else if(blockKey === "mais"){
      list.sort((a,b)=> (b.soldNum - a.soldNum) || (b.discountPct - a.discountPct));
    } else if(blockKey === "ate99"){
      list = list.filter(r => isFinite(r.finalPrice) && r.finalPrice <= 99)
                 .sort((a,b)=> a.finalPrice - b.finalPrice);
    } else if(blockKey === "dia"){
      list.sort((a,b)=> scoreDia(b) - scoreDia(a));
    } else {
      // tudo: ordem da planilha
    }
    return applySearch(list);
  }

  function getDisplayList(){
    const base = getSortedList(CURRENT);
    if(CURRENT !== "tudo") return base; // bloco mostra todos dele
    return base.slice(0, shownCount);   // tudo paginado
  }

  function render(items){
    const grid = $("grid");
    grid.innerHTML = "";

    if(!items.length){
      grid.innerHTML = `<div class="err">Nenhum produto encontrado.</div>`;
      return;
    }

    const frag = document.createDocumentFragment();

    items.forEach(r=>{
      const off = r.discountPct ? `${Math.round(r.discountPct)}% OFF` : "OFERTA";
      const soldTxt = r.soldNum ? `${r.soldNum.toLocaleString("pt-BR")} vendidos` : "";

      const card = document.createElement("article");
      card.className = "card";

      card.innerHTML = `
        <div class="img">
          <div class="chips">
            <div class="chip">${off}</div>
            ${soldTxt ? `<div class="chip blue">${soldTxt}</div>` : ``}
          </div>
          <img loading="lazy" src="${r.image}" alt="${(r.title||"").replace(/"/g,"")}"/>
        </div>

        <div class="body">
          <div class="t">${r.title}</div>
          <div class="prices">
            <div>
              <div class="full">${isFinite(r.fullPrice) ? moneyBR(r.fullPrice) : ""}</div>
              <div class="final">${isFinite(r.finalPrice) ? moneyBR(r.finalPrice) : ""}</div>
            </div>
            <div class="badge">-${Math.round(r.discountPct)}%</div>
          </div>
        </div>

        <div class="cta">
          <a href="${r.link}" target="_blank" rel="noopener">Ver oferta</a>
        </div>
      `;

      frag.appendChild(card);
    });

    grid.appendChild(frag);
  }

  function updateUI(){
    document.querySelectorAll(".b").forEach(el=>{
      el.classList.toggle("active", el.getAttribute("data-b") === CURRENT);
    });

    const base = getSortedList(CURRENT);
    const items = getDisplayList();

    if(CURRENT === "tudo"){
      $("pillInfo").textContent = `Mostrando ${items.length} de ${base.length}`;
      $("loadMore").style.display = (shownCount < base.length) ? "" : "none";
    } else {
      $("pillInfo").textContent = `Itens: ${base.length}`;
      $("loadMore").style.display = "none";
    }

    render(items);
  }

  async function load(){
    try{
      $("msg").innerHTML = "";
      const res = await fetch(CSV_URL, { cache:"no-store" });
      if(!res.ok) throw new Error("Falha ao buscar planilha");
      const text = await res.text();
      ALL = parseCSV(text);

      // dedupe por link
      const seen = new Set();
      ALL = ALL.filter(r=>{
        const k = String(r.link||"").trim();
        if(!k || seen.has(k)) return false;
        seen.add(k); return true;
      });

      if(!ALL.length) throw new Error("Planilha vazia ou colunas incompat√≠veis");
      updateUI();
    } catch(e){
      $("msg").innerHTML = `<div class="err">Erro: ${String(e.message||e)}</div>`;
      $("pillInfo").textContent = "Erro ao carregar";
    }
  }

  document.addEventListener("DOMContentLoaded", async ()=>{
    await load();

    $("blocks").addEventListener("click", (ev)=>{
      const el = ev.target.closest(".b");
      if(!el) return;
      CURRENT = el.getAttribute("data-b") || "tudo";
      shownCount = PAGE_SIZE;
      updateUI();
      window.scrollTo({top:0,behavior:"smooth"});
    });

    let t=null;
    $("q").addEventListener("input", ()=>{
      clearTimeout(t);
      t=setTimeout(()=>{
        shownCount = PAGE_SIZE;
        updateUI();
      }, 180);
    });

    $("loadMore").addEventListener("click", ()=>{
      shownCount += PAGE_SIZE;
      updateUI();
    });
  });
</script>
</body>
</html>
