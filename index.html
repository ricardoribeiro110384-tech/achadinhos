<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Achadinhos Oficial</title>
  <meta name="theme-color" content="#0f172a" />

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a33;
      --soft:#132047;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --brand:#22c55e;
      --accent:#f59e0b;
      --danger:#ef4444;
      --border:rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1000px 600px at 20% 0%, rgba(34,197,94,.12), transparent 60%),
                  radial-gradient(800px 500px at 80% 10%, rgba(245,158,11,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}

    header{
      position:sticky; top:0; z-index:50;
      background: rgba(11,18,32,.86);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .headbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:12px 0;
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.3px}
    .logo{width:38px;height:38px;border-radius:12px;background:linear-gradient(135deg, rgba(34,197,94,.95), rgba(245,158,11,.85));box-shadow:var(--shadow)}
    .sub{font-size:12px;color:var(--muted);margin-top:2px;font-weight:600}
    .status{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,.03);font-size:12px;color:var(--muted);white-space:nowrap}
    .dot{width:9px;height:9px;border-radius:999px;background:var(--accent);box-shadow:0 0 0 4px rgba(245,158,11,.12)}
    .status b{color:var(--text)}
    .pill{padding:8px 10px;border-radius:999px;background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.25);font-size:12px;font-weight:800;color:#bbf7d0}

    .hero{
      margin-top:16px;background:linear-gradient(180deg, rgba(19,32,71,.9), rgba(15,26,51,.7));
      border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;position:relative
    }
    .hero:before{content:"";position:absolute;inset:-2px;background:radial-gradient(500px 200px at 20% 10%, rgba(34,197,94,.25), transparent 60%),radial-gradient(450px 220px at 75% 0%, rgba(245,158,11,.22), transparent 55%);pointer-events:none}
    .hero-inner{position:relative;padding:18px;display:grid;grid-template-columns:1.3fr .7fr;gap:14px;align-items:center}
    @media (max-width: 860px){.hero-inner{grid-template-columns:1fr}}
    .hero h1{margin:0;font-size:22px;line-height:1.2}
    .hero p{margin:8px 0 0;color:var(--muted);font-weight:600}
    .hero .ctaRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{display:inline-flex;align-items:center;gap:10px;padding:12px 14px;border-radius:14px;border:1px solid var(--border);background:rgba(255,255,255,.03);font-weight:900;cursor:pointer;transition:transform .08s ease;user-select:none}
    .btn:active{transform:translateY(1px)}
    .btnPrimary{background:linear-gradient(135deg, rgba(34,197,94,.95), rgba(34,197,94,.75));color:#052014;border:none}
    .kpi{display:grid;gap:10px}
    .kpiCard{border:1px solid var(--border);background:rgba(255,255,255,.03);border-radius:14px;padding:12px}
    .kpiCard b{font-size:16px}
    .kpiCard span{display:block;color:var(--muted);font-size:12px;font-weight:700;margin-top:2px}

    .videoWrap{margin-top:14px;border:1px solid var(--border);border-radius:var(--radius);background:rgba(255,255,255,.03);overflow:hidden;box-shadow:var(--shadow)}
    .videoTop{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid var(--border)}
    .videoTop b{font-size:13px}
    .videoTop span{font-size:12px;color:var(--muted);font-weight:800}
    .videoBox{position:relative;width:100%;aspect-ratio:16/9;background:#000}
    .videoBox video{width:100%;height:100%;object-fit:cover;display:block}
    .videoOverlay{position:absolute;inset:auto 12px 12px auto;display:flex;gap:8px;z-index:2}
    .btnMini{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.08);color:#fff;font-weight:900;cursor:pointer}
    .btnMiniPrimary{background:linear-gradient(135deg, rgba(245,158,11,.95), rgba(245,158,11,.75));color:#1b1201;border:none}
    .videoControls{display:flex;gap:10px;flex-wrap:wrap;padding:10px 12px;border-top:1px solid var(--border);background:rgba(0,0,0,.18)}

    .controls{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .search{flex:1;min-width:240px;display:flex;align-items:center;gap:10px;padding:12px 12px;border:1px solid var(--border);border-radius:14px;background:rgba(255,255,255,.03)}
    .search input{width:100%;background:transparent;border:none;outline:none;color:var(--text);font-size:14px;font-weight:700}
    .select{min-width:180px;padding:12px 12px;border:1px solid var(--border);border-radius:14px;background:rgba(255,255,255,.03);color:var(--text);font-weight:800;outline:none}

    .bar{margin-top:14px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 860px){.bar{grid-template-columns:1fr}}
    .notice{border:1px solid var(--border);background:rgba(255,255,255,.03);border-radius:14px;padding:12px;display:flex;gap:10px;align-items:flex-start}
    .badge{width:34px;height:34px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:rgba(245,158,11,.16);border:1px solid rgba(245,158,11,.28);flex:0 0 auto}
    .notice h3{margin:0;font-size:13px}
    .notice p{margin:4px 0 0;color:var(--muted);font-weight:700;font-size:12px;line-height:1.35}
    .mini{font-size:12px;color:var(--muted);font-weight:800}

    .grid{margin-top:16px;display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width: 980px){.grid{grid-template-columns:repeat(2,1fr)}}
    .card{border:1px solid var(--border);background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border-radius:var(--radius);overflow:hidden;box-shadow:0 12px 24px rgba(0,0,0,.25);display:flex;flex-direction:column;min-height:410px}
    .imgbox{background:rgba(255,255,255,.03);border-bottom:1px solid var(--border);aspect-ratio:16/11;display:flex;align-items:center;justify-content:center;overflow:hidden;padding:10px}
    .imgbox img{width:100%;height:100%;object-fit:contain;object-position:center;display:block;filter:saturate(1.05) contrast(1.03)}
    .cardBody{padding:12px;display:grid;gap:10px}
    .title{margin:0;font-size:14px;line-height:1.25;font-weight:900;min-height:36px}
    .row{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
    .price{font-size:18px;font-weight:1000}
    .muted{color:var(--muted);font-weight:800;font-size:12px}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.03);font-size:12px;font-weight:900;color:var(--text)}
    .off{border:1px solid rgba(239,68,68,.32);background:rgba(239,68,68,.12);color:#fecaca}
    .coupon{border:1px solid rgba(34,197,94,.28);background:rgba(34,197,94,.12);color:#bbf7d0}
    .buy{margin-top:2px;display:flex;gap:10px}
    .btnSmall{flex:1;display:flex;align-items:center;justify-content:center;padding:11px 12px;border-radius:14px;border:1px solid var(--border);background:rgba(255,255,255,.03);font-weight:1000;cursor:pointer}
    .btnBuy{background:linear-gradient(135deg, rgba(245,158,11,.95), rgba(245,158,11,.75));color:#1b1201;border:none}

    @media (max-width: 620px){
      .grid{
        display:flex;overflow-x:auto;gap:12px;scroll-snap-type:x mandatory;padding:2px 4px 10px;
        -webkit-overflow-scrolling: touch;
      }
      .grid::-webkit-scrollbar{height:8px}
      .grid::-webkit-scrollbar-thumb{background:rgba(255,255,255,.16);border-radius:999px}
      .card{flex:0 0 82vw;scroll-snap-align:start;min-height:unset}
    }

    footer{margin:18px 0 100px;border:1px solid var(--border);background:rgba(255,255,255,.03);border-radius:var(--radius);padding:14px}
    footer b{display:block;margin-bottom:6px}
    footer ul{margin:0;padding-left:18px;color:var(--muted);font-weight:700;font-size:13px;line-height:1.45}

    .wa{position:fixed;right:16px;bottom:16px;z-index:999;display:flex;align-items:center;gap:10px;padding:14px 14px;border-radius:999px;background:linear-gradient(135deg, rgba(34,197,94,.98), rgba(34,197,94,.78));color:#052014;font-weight:1000;box-shadow:0 18px 40px rgba(0,0,0,.35);border:none;cursor:pointer}
    .wa small{display:block;font-weight:900;opacity:.9;line-height:1}
    .wa span{display:block;line-height:1}
    .waIcon{width:38px;height:38px;border-radius:999px;background:rgba(0,0,0,.12);display:flex;align-items:center;justify-content:center;font-size:18px}

    .loading{margin-top:16px;border:1px dashed rgba(255,255,255,.18);border-radius:var(--radius);padding:14px;color:var(--muted);font-weight:800}
  </style>
</head>

<body>

<header>
  <div class="wrap">
    <div class="headbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div>Achadinhos <span style="color:#bbf7d0">Oficial</span></div>
          <div class="sub">Ofertas atualizadas direto da planilha</div>
        </div>
      </div>

      <div class="status" title="Atualiza√ß√£o autom√°tica">
        <span class="dot" id="statusDot"></span>
        <span id="updatedLabel"><b>Carregando</b></span>
        <span id="updatedTime" class="mini" data-mode="checking">Verificando‚Ä¶</span>
      </div>

      <div class="pill" id="countPill">0 ofertas</div>
    </div>
  </div>
</header>

<main class="wrap">

  <section class="hero">
    <div class="hero-inner">
      <div>
        <h1>As melhores ofertas do dia ‚Äî sem enrola√ß√£o. <span style="color:#bbf7d0">Clique e compre.</span></h1>
        <p>Atualiza sozinho e mostra o que est√° com desconto agora. Se tiver cupom, j√° aparece.</p>
        <div class="ctaRow">
          <button class="btn btnPrimary" onclick="scrollToOffers()">üéÅ Ver ofertas agora</button>
          <button class="btn" onclick="forceReload()">üîÑ Atualizar agora</button>
        </div>
      </div>

      <div class="kpi">
        <div class="kpiCard">
          <b id="kpi1">0</b>
          <span>ofertas dispon√≠veis</span>
        </div>
        <div class="kpiCard">
          <b id="kpi2">0</b>
          <span>vendidos hoje (estimativa)</span>
        </div>
      </div>
    </div>
  </section>

  <section class="videoWrap" aria-label="V√≠deo do Achadinhos">
    <div class="videoTop">
      <div>
        <b>üé• Recado r√°pido</b>
        <span>Ative o som se quiser ouvir.</span>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btnMini" id="muteBtn" type="button">üîá Mutado</button>
        <button class="btnMini btnMiniPrimary" id="soundBtn" type="button">üîä Ativar som</button>
      </div>
    </div>

    <div class="videoBox">
      <video id="promoVideo" autoplay muted playsinline webkit-playsinline loop preload="metadata">
        <source id="videoSrc" src="" type="video/mp4" />
        Seu navegador n√£o suporta v√≠deo.
      </video>
      <div class="videoOverlay">
        <button class="btnMini" id="toggleVideoBtn" type="button">‚è∏ Pausar</button>
      </div>
    </div>

    <div class="videoControls">
      <button class="btnMini" type="button" onclick="scrollToOffers()">üéÅ Ver ofertas</button>
      <button class="btnMini" type="button" onclick="openWhatsApp()">üü¢ Tirar d√∫vida no WhatsApp</button>
    </div>
  </section>

  <section class="controls">
    <div class="search">
      üîé <input id="q" type="text" placeholder="Buscar produto (ex: t√™nis, perfume, mesa...)" />
    </div>

    <select class="select" id="sort">
      <option value="best">Ordenar: destaque</option>
      <option value="priceAsc">Menor pre√ßo</option>
      <option value="priceDesc">Maior pre√ßo</option>
      <option value="discountDesc">Maior desconto</option>
      <option value="soldDesc">Mais vendidos</option>
      <option value="ratingDesc">Melhor avalia√ß√£o</option>
    </select>
  </section>

  <section class="bar">
    <div class="notice">
      <div class="badge">üî•</div>
      <div>
        <h3>Acabando r√°pido</h3>
        <p id="urgencyText">Ofertas mudam o tempo todo ‚Äî se gostou, aproveite agora.</p>
      </div>
    </div>

    <div class="notice">
      <div class="badge">‚úÖ</div>
      <div>
        <h3>Prova social</h3>
        <p id="socialText">Hoje j√° teve v√°rias compras ‚Äî atualizando em tempo real.</p>
      </div>
    </div>
  </section>

  <div id="loading" class="loading">Carregando ofertas da planilha‚Ä¶</div>

  <section id="offers" class="grid" aria-live="polite"></section>

  <footer>
    <b>‚úÖ Compra com mais seguran√ßa</b>
    <ul>
      <li>Ofertas exibidas a partir da planilha publicada.</li>
      <li>Pre√ßos podem mudar a qualquer momento no site do vendedor.</li>
      <li>Se algum item n√£o abrir, atualize a p√°gina e tente novamente.</li>
    </ul>
  </footer>

</main>

<button class="wa" onclick="openWhatsApp()" aria-label="Falar no WhatsApp">
  <div class="waIcon">üü¢</div>
  <div>
    <span>Falar no WhatsApp</span>
    <small>Resposta r√°pida</small>
  </div>
</button>

<script>
  // ========= CONFIG =========
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYh-FJUhtB7MT80tKHccZi-z1hTKUOwDqg-tQSR_YPiDOQv-mKmSjTyAtZzmhq8YEchYOjqcVZhJv3/pub?output=csv";
  const WA_NUMBER = "5589981311034";
  const REFRESH_MS = 2 * 60 * 1000;
  const VIDEO_SRC = "video.mp4";

  // ===== Helpers =====
  function nowHHMMSS(){const d=new Date();const hh=String(d.getHours()).padStart(2,'0');const mm=String(d.getMinutes()).padStart(2,'0');const ss=String(d.getSeconds()).padStart(2,'0');return `${hh}:${mm}:${ss}`;}
  function safeText(x){return (x??"").toString().replace(/\s+/g,' ').trim();}
  function escapeHtml(s){return (s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");}

  // ‚úÖ Sempre formata em Real
  function moneyBRL(value){
    const n = Number(value);
    if (!isFinite(n)) return "‚Äî";
    return n.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
  }

  // Aceita "129,90" | "R$ 129,90" | "129.90" | "1.299,90"
  function toNumberBR(str){
    if(str == null) return NaN;
    let s = String(str).trim();
    if(!s) return NaN;
    s = s.replace(/\s/g,'').replace(/[R$r$\u00A0]/g,''); // remove R$ e espa√ßos
    s = s.replace(/\./g,''); // remove milhar
    s = s.replace(',', '.'); // decimal pt-br
    s = s.replace(/[^\d.-]/g,'');
    const n = Number(s);
    return isFinite(n) ? n : NaN;
  }

  function scrollToOffers(){document.getElementById("offers").scrollIntoView({behavior:"smooth",block:"start"});}
  function openWhatsApp(){const msg=encodeURIComponent("Oi! Quero ajuda com uma oferta do site Achadinhos Oficial.");window.open(`https://wa.me/${WA_NUMBER}?text=${msg}`,"_blank");}

  function setStatus(mode,text){
    const dot=document.getElementById("statusDot");
    const label=document.getElementById("updatedLabel");
    const time=document.getElementById("updatedTime");
    if(mode==="ok"){dot.style.background="var(--brand)";dot.style.boxShadow="0 0 0 4px rgba(34,197,94,.12)";label.innerHTML="<b>Atualizado</b>";time.dataset.mode="updated";time.textContent=text;}
    else if(mode==="loading"){dot.style.background="var(--accent)";dot.style.boxShadow="0 0 0 4px rgba(245,158,11,.12)";label.innerHTML="<b>Carregando</b>";time.dataset.mode="checking";time.textContent=text;}
    else{dot.style.background="var(--danger)";dot.style.boxShadow="0 0 0 4px rgba(239,68,68,.12)";label.innerHTML="<b>Falha</b>";time.dataset.mode="checking";time.textContent=text;}
  }

  function startLiveClock(){
    const timeEl=document.getElementById("updatedTime");
    if(!timeEl)return;
    setInterval(()=>{if(timeEl.dataset.mode!=="updated"){timeEl.textContent=`Verificando: ${nowHHMMSS()}`;}},1000);
  }

  // ===== CSV parser =====
  function parseCSV(text){
    const rows=[];let row=[];let cur="";let inQuotes=false;
    for(let i=0;i<text.length;i++){
      const ch=text[i], next=text[i+1];
      if(ch==='"'&&inQuotes&&next==='"'){cur+='"';i++;continue;}
      if(ch==='"'){inQuotes=!inQuotes;continue;}
      if(ch===','&&!inQuotes){row.push(cur);cur="";continue;}
      if((ch==='\n'||ch==='\r')&&!inQuotes){
        if(ch==='\r'&&next==='\n'){i++;}
        row.push(cur);cur="";
        if(row.length>1||row[0].trim()!==""){rows.push(row);}
        row=[];continue;
      }
      cur+=ch;
    }
    row.push(cur);
    if(row.length>1||row[0].trim()!==""){rows.push(row);}
    return rows;
  }

  // ===== V√≠deo =====
  function initVideo(){
    const video=document.getElementById("promoVideo");
    const src=document.getElementById("videoSrc");
    const btnToggle=document.getElementById("toggleVideoBtn");
    const btnSound=document.getElementById("soundBtn");
    const btnMute=document.getElementById("muteBtn");
    if(!video||!src) return;

    src.src=VIDEO_SRC;
    video.setAttribute("playsinline",""); video.setAttribute("webkit-playsinline","");
    video.muted=true;
    video.play().catch(()=>{});

    btnToggle?.addEventListener("click",()=>{
      if(video.paused){video.play().catch(()=>{});btnToggle.textContent="‚è∏ Pausar";}
      else{video.pause();btnToggle.textContent="‚ñ∂Ô∏è Reproduzir";}
    });

    btnSound?.addEventListener("click",()=>{
      video.muted=false;
      video.volume=1.0;
      video.play().catch(()=>{});
      btnMute.textContent="üîä Com som";
    });

    btnMute?.addEventListener("click",()=>{
      video.muted=!video.muted;
      btnMute.textContent = video.muted ? "üîá Mutado" : "üîä Com som";
    });
  }

  // ===== Link finder =====
  function normalizeHeader(h){
    return safeText(h).toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,''); // remove acentos
  }

  function findColumnIndex(header, candidates){
    const map = header.map(normalizeHeader);
    for(const cand of candidates){
      const c = normalizeHeader(cand);
      const i = map.indexOf(c);
      if(i >= 0) return i;
    }
    // tentativa por "cont√©m"
    for(let i=0;i<map.length;i++){
      const h = map[i];
      for(const cand of candidates){
        const c = normalizeHeader(cand);
        if(h.includes(c)) return i;
      }
    }
    return -1;
  }

  function firstHttpInRow(row){
    for(const cell of row){
      const v = safeText(cell);
      if(/^https?:\/\//i.test(v)) return v;
    }
    return "";
  }

  // ===== Render =====
  let ALL_ITEMS=[];
  function forceReload(){loadSheet(true);}
  function getQuery(){return safeText(document.getElementById("q").value).toLowerCase();}
  function getSort(){return document.getElementById("sort").value;}

  function sortItems(items,mode){
    const a=[...items];
    if(mode==="priceAsc"){a.sort((x,y)=>(x.priceNum||Infinity)-(y.priceNum||Infinity));}
    else if(mode==="priceDesc"){a.sort((x,y)=>(y.priceNum||-Infinity)-(x.priceNum||-Infinity));}
    else if(mode==="discountDesc"){a.sort((x,y)=>(y.discountNum||0)-(x.discountNum||0));}
    else if(mode==="soldDesc"){a.sort((x,y)=>(y.soldNum||0)-(x.soldNum||0));}
    else if(mode==="ratingDesc"){a.sort((x,y)=>(y.ratingNum||0)-(x.ratingNum||0));}
    else{
      a.sort((x,y)=>{
        const sx=(x.soldNum||0)*2+(x.discountNum||0)*1.2+(x.ratingNum||0)*10;
        const sy=(y.soldNum||0)*2+(y.discountNum||0)*1.2+(y.ratingNum||0)*10;
        return sy-sx;
      });
    }
    return a;
  }

  function filterItems(items){
    const q=getQuery(); if(!q) return items;
    return items.filter(it=>(`${it.title} ${it.coupon||""}`).toLowerCase().includes(q));
  }

  function render(){
    const grid=document.getElementById("offers");
    const loading=document.getElementById("loading");
    const sorted=sortItems(filterItems(ALL_ITEMS),getSort());

    grid.innerHTML="";
    loading.style.display=sorted.length?"none":"block";
    loading.textContent=sorted.length?"":"Nenhuma oferta encontrada. Tente outra busca.";

    document.getElementById("countPill").textContent=`${ALL_ITEMS.length} ofertas`;
    document.getElementById("kpi1").textContent=ALL_ITEMS.length.toString();

    const soldToday=ALL_ITEMS.reduce((acc,it)=>acc+(it.soldNum||0),0);
    document.getElementById("kpi2").textContent=soldToday?soldToday.toString():"‚Äî";
    document.getElementById("urgencyText").textContent="Quando aparece desconto alto, costuma acabar r√°pido. Se gostou, aproveite agora.";
    document.getElementById("socialText").textContent=soldToday?`Hoje j√° teve ${soldToday} compras somadas nas ofertas da planilha.`:"Ofertas com boa avalia√ß√£o e desconto tendem a vender mais r√°pido.";

    for(const it of sorted){
      const card=document.createElement("article"); card.className="card";

      const img=document.createElement("div"); img.className="imgbox";
      img.innerHTML=`<img src="${it.image||""}" alt="${escapeHtml(it.title)}" loading="lazy" referrerpolicy="no-referrer">`;
      card.appendChild(img);

      const body=document.createElement("div"); body.className="cardBody";

      const title=document.createElement("h2"); title.className="title"; title.textContent=it.title||"Oferta";
      body.appendChild(title);

      const row1=document.createElement("div"); row1.className="row";

      // ‚úÖ sempre R$
      const price=document.createElement("div"); price.className="price";
      price.textContent = isFinite(it.priceNum) ? moneyBRL(it.priceNum) : "‚Äî";
      row1.appendChild(price);

      const right=document.createElement("div");
      right.style.display="flex"; right.style.gap="8px"; right.style.flexWrap="wrap"; right.style.justifyContent="flex-end";

      if(it.discount){
        const t=document.createElement("span"); t.className="tag off"; t.textContent=it.discount;
        right.appendChild(t);
      }
      if(it.coupon){
        const t=document.createElement("span"); t.className="tag coupon"; t.textContent=`CUPOM: ${it.coupon}`;
        right.appendChild(t);
      }

      row1.appendChild(right);
      body.appendChild(row1);

      const row2=document.createElement("div"); row2.className="row";
      row2.innerHTML=`<div class="muted">${it.rating?`‚≠ê ${it.rating}`:"‚≠ê ‚Äî"} &nbsp;‚Ä¢&nbsp; ${it.sold?`${it.sold} vendidos`:"‚Äî vendidos"}</div>
                      <div class="muted">Atualizado: ${nowHHMMSS()}</div>`;
      body.appendChild(row2);

      const buy=document.createElement("div"); buy.className="buy";

      const btn1=document.createElement("button"); btn1.className="btnSmall btnBuy"; btn1.textContent="Ver oferta";
      btn1.onclick=()=>openLink(it.link);
      buy.appendChild(btn1);

      const btn2=document.createElement("button"); btn2.className="btnSmall"; btn2.textContent="Copiar cupom";
      btn2.onclick=()=>copyCoupon(it.coupon);
      buy.appendChild(btn2);

      body.appendChild(buy);
      card.appendChild(body);
      grid.appendChild(card);
    }
  }

  async function copyCoupon(coupon){
    const c=safeText(coupon); if(!c){alert("Este item n√£o tem cupom.");return;}
    try{await navigator.clipboard.writeText(c); alert("Cupom copiado: "+c);}
    catch{prompt("Copie o cupom:",c);}
  }

  function openLink(url){
    const u = safeText(url);
    if(!u){
      alert("Link do produto n√£o encontrado na planilha. Verifique a coluna de link/URL.");
      return;
    }
    window.open(u,"_blank");
  }

  // ===== Planilha =====
  async function loadSheet(isManual=false){
    try{
      setStatus("loading",(isManual?"Atualizando agora‚Ä¶ ":"Atualizando‚Ä¶ ")+nowHHMMSS());
      const url=SHEET_CSV_URL+(SHEET_CSV_URL.includes("?")?"&":"?")+"t="+Date.now();
      const res=await fetch(url,{cache:"no-store"}); if(!res.ok) throw new Error("HTTP "+res.status);

      const text=await res.text();
      const rows=parseCSV(text);
      if(!rows.length) throw new Error("CSV vazio");

      const header = rows[0].map(h => safeText(h));
      const items=[];

      // colunas aceitas
      const iImage  = findColumnIndex(header, ["image","imagem","img","foto","thumbnail","thumb"]);
      const iTitle  = findColumnIndex(header, ["title","titulo","produto","nome","descricao","descri√ß√£o"]);
      const iPrice  = findColumnIndex(header, ["price","preco","pre√ßo","valor","value","amount"]);
      const iDiscount = findColumnIndex(header, ["discount","desconto","off","promo","promocao","promo√ß√£o"]);
      const iCoupon = findColumnIndex(header, ["coupon","cupom","codigo","c√≥digo"]);
      const iSold   = findColumnIndex(header, ["sold","vendidos","vendas","qtdvendida","quantidadevendida"]);
      const iRating = findColumnIndex(header, ["rating","avaliacao","avalia√ß√£o","nota","stars","estrelas"]);

      // ‚úÖ link com muitos nomes
      const iLink = findColumnIndex(header, [
        "link","url","href","checkout","oferta","produto link","link do produto","url do produto",
        "mercadolivre","mercado livre","ml","product","product link","link produto"
      ]);

      for(let r=1;r<rows.length;r++){
        const row=rows[r];

        const title = iTitle>=0 ? safeText(row[iTitle]) : safeText(row[0]);
        const image = iImage>=0 ? safeText(row[iImage]) : "";
        const priceRaw = iPrice>=0 ? safeText(row[iPrice]) : "";
        const discount = iDiscount>=0 ? safeText(row[iDiscount]) : "";
        const coupon = iCoupon>=0 ? safeText(row[iCoupon]) : "";
        const sold = iSold>=0 ? safeText(row[iSold]) : "";
        const rating = iRating>=0 ? safeText(row[iRating]) : "";

        // ‚úÖ tenta link pela coluna; se falhar, procura http na linha
        let link = iLink>=0 ? safeText(row[iLink]) : "";
        if(!/^https?:\/\//i.test(link)) link = firstHttpInRow(row);

        // ignora linha vazia de verdade
        if(!title && !image && !priceRaw && !link) continue;

        const priceNum = toNumberBR(priceRaw);
        const discountNum = toNumberBR(discount);
        const soldNum = toNumberBR(sold);
        const ratingNum = toNumberBR(rating);

        items.push({
          title: title || "Oferta",
          image,
          priceNum: isFinite(priceNum) ? priceNum : NaN,
          discount,
          discountNum: isFinite(discountNum) ? discountNum : 0,
          coupon,
          sold,
          soldNum: isFinite(soldNum) ? soldNum : 0,
          rating,
          ratingNum: isFinite(ratingNum) ? ratingNum : 0,
          link
        });
      }

      ALL_ITEMS = items;
      setStatus("ok",`√öltima atualiza√ß√£o: ${nowHHMMSS()} ‚Ä¢ ${items.length} ofertas`);
      render();

    }catch(err){
      console.error(err);
      setStatus("error",`Tentando novamente‚Ä¶ ${nowHHMMSS()}`);
      const loading=document.getElementById("loading"); loading.style.display="block";
      loading.textContent="N√£o consegui carregar a planilha agora. Verifique se ela est√° publicada e tente atualizar.";
    }
  }

  // ===== Eventos =====
  document.getElementById("q").addEventListener("input",()=>render());
  document.getElementById("sort").addEventListener("change",()=>render());

  // Start
  initVideo();
  startLiveClock();
  loadSheet();
  setInterval(()=>loadSheet(false), REFRESH_MS);
</script>

</body>
</html>
