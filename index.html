<!doctype html>
<html lang="pt-br">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-H5DTVXXB59"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-H5DTVXXB59');
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Achadinhos Oficial</title>
  <meta name="theme-color" content="#0f172a" />

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a33;
      --soft:#132047;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --brand:#22c55e;
      --accent:#f59e0b;
      --danger:#ef4444;
      --border:rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;

      --yellow:#ffd000;
      --yellow2:#ffb800;
      --yellowText:#1a1400;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1000px 600px at 20% 0%, rgba(34,197,94,.12), transparent 60%),
                  radial-gradient(800px 500px at 80% 10%, rgba(245,158,11,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}

    /* BARRA AMARELA */
    .topbar{
      background: linear-gradient(90deg, var(--yellow), var(--yellow2));
      color:var(--yellowText);
      border-bottom:1px solid rgba(0,0,0,.12);
      position:sticky;
      top:0;
      z-index:80;
    }
    .topbar .wrap{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .topbrand{
      display:flex;align-items:center;gap:12px;
      font-weight:1000;
      letter-spacing:.2px;
      min-width:0;
    }
    .toplogo{
      width:46px;height:46px;
      border-radius:16px;
      background:#111;
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
      box-shadow: 0 12px 26px rgba(0,0,0,.20);
    }
    .toplogo img{width:100%;height:100%;object-fit:contain}
    .toptext{min-width:0}
    .topname{
      font-size:18px;
      line-height:1.05;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toptag{
      font-size:13px;
      opacity:.9;
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:60vw;
    }
    .topright{
      display:flex;gap:10px;align-items:center;flex:0 0 auto;
      font-weight:1000;
      font-size:13px;
      background: rgba(0,0,0,.10);
      border:1px solid rgba(0,0,0,.12);
      border-radius:999px;
      padding:10px 12px;
      white-space:nowrap;
      cursor:pointer;
      user-select:none;
    }
    .topright:active{transform: translateY(1px)}
    @media (max-width: 520px){
      .toptag{display:none}
      .topbar .wrap{padding:12px 14px}
      .toplogo{width:44px;height:44px}
      .topname{font-size:16px}
    }

    /* Header escuro */
    header{
      position:sticky;
      top:74px;
      z-index:60;
      background: rgba(11,18,32,.86);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    @media (max-width: 520px){
      header{top:68px}
    }

    .headbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:12px 0;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      font-weight:800; letter-spacing:.3px;
      min-width: 220px;
    }
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(245,158,11,.85));
      box-shadow: var(--shadow);
      flex: 0 0 auto;
    }
    .sub{
      font-size:12px;color:var(--muted);margin-top:2px;font-weight:600;
    }
    .status{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border:1px solid var(--border);
      border-radius:999px;background: rgba(255,255,255,.03);
      font-size:12px;color:var(--muted);
      white-space:nowrap;
      max-width: 100%;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .dot{width:9px;height:9px;border-radius:999px;background:var(--accent);box-shadow: 0 0 0 4px rgba(245,158,11,.12)}
    .status b{color:var(--text)}
    .pill{
      padding:8px 10px;border-radius:999px;
      background: rgba(34,197,94,.12);
      border:1px solid rgba(34,197,94,.25);
      font-size:12px;font-weight:800;color:#bbf7d0;
      white-space:nowrap;
    }

    /* Hero */
    .hero{
      margin-top:16px;
      background: linear-gradient(180deg, rgba(19,32,71,.9), rgba(15,26,51,.7));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .hero:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(500px 200px at 20% 10%, rgba(34,197,94,.25), transparent 60%),
                  radial-gradient(450px 220px at 75% 0%, rgba(245,158,11,.22), transparent 55%);
      pointer-events:none;
    }
    .hero-inner{
      position:relative;
      padding:18px;
      display:grid;
      grid-template-columns: 1.3fr .7fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 860px){
      .hero-inner{grid-template-columns:1fr}
    }
    .hero h1{margin:0;font-size:22px;line-height:1.2}
    .hero p{margin:8px 0 0;color:var(--muted);font-weight:600}
    .hero .ctaRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      display:inline-flex;align-items:center;gap:10px;
      padding:12px 14px;border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      font-weight:900;
      cursor:pointer;
      transition: transform .08s ease;
      user-select:none;
      color:var(--text);
    }
    .btn:active{transform: translateY(1px)}
    .btnPrimary{
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(34,197,94,.75));
      color:#052014;border:none;
    }

    .kpi{display:grid;gap:10px;}
    .kpiCard{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius:14px;
      padding:12px;
    }
    .kpiCard b{font-size:16px}
    .kpiCard span{display:block;color:var(--muted);font-size:12px;font-weight:700;margin-top:2px}

    /* V√çDEO */
    .videoWrap{
      margin:12px auto 0;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius:14px;
      overflow:hidden;
      max-width: 520px;
    }
    @media (max-width: 860px){
      .videoWrap{max-width:100%}
    }
    .videoTop{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      flex-wrap:wrap;
    }
    .videoTop b{font-size:13px}
    .videoTop .mini{font-size:12px;color:var(--muted);font-weight:900}
    .btnTiny{
      padding:10px 12px;border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      font-weight:1000;
      cursor:pointer;
      color:var(--text);
    }
    .videoFrame{
      aspect-ratio: 16 / 9;
      background:#000;
    }
    video{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      background:#000;
    }

    /* OFERTA DO MINUTO */
    .spot{
      margin-top:14px;
      border:1px solid rgba(245,158,11,.22);
      background: linear-gradient(180deg, rgba(245,158,11,.10), rgba(255,255,255,.02));
      border-radius: var(--radius);
      box-shadow: 0 12px 24px rgba(0,0,0,.20);
      overflow:hidden;
      display:grid;
      grid-template-columns: 1fr 1.25fr;
      gap:0;
    }
    @media (max-width: 860px){
      .spot{grid-template-columns:1fr}
    }
    .spotImg{
      background: rgba(0,0,0,.18);
      border-right:1px solid rgba(255,255,255,.08);
      min-height: 220px;
      display:flex;align-items:center;justify-content:center;
      padding:10px;
    }
    @media (max-width: 860px){
      .spotImg{border-right:none;border-bottom:1px solid rgba(255,255,255,.08)}
    }
    .spotImg img{
      width:100%;
      height:100%;
      max-height: 260px;
      object-fit:contain;
      border-radius: 14px;
      background: rgba(0,0,0,.14);
    }
    .spotBody{
      padding:14px;
      display:grid;
      gap:10px;
    }
    .spotTop{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .spotBadge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background: rgba(239,68,68,.14);
      border:1px solid rgba(239,68,68,.28);
      color:#fecaca;
      font-weight:1000;
      letter-spacing:.2px;
    }
    .spotTitle{
      margin:0;
      font-size:16px;
      font-weight:1000;
      line-height:1.2;
    }
    .spotPrices{
      display:flex;align-items:flex-end;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .priceNow{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(34,197,94,.18);
      border:1px solid rgba(34,197,94,.35);
      font-weight:1000;
      font-size:18px;
      color:#bbf7d0;
      white-space:nowrap;
    }
    .priceOld{
      color: rgba(229,231,235,.75);
      font-weight:900;
      font-size:14px;
      text-decoration: line-through;
      white-space:nowrap;
    }
    .spotCopy{
      font-weight:1000;
      color: rgba(229,231,235,.92);
      line-height:1.35;
    }
    .spotBtns{
      display:flex;gap:10px;flex-wrap:wrap;
    }

    /* Controls */
    .controls{
      margin-top:14px;
      display:flex;gap:10px;flex-wrap:wrap;
      align-items:center;justify-content:space-between;
    }
    .search{
      flex:1; min-width:240px;
      display:flex;align-items:center;gap:10px;
      padding:12px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background: rgba(255,255,255,.03);
    }
    .search input{
      width:100%;
      background:transparent;border:none;outline:none;color:var(--text);
      font-size:14px;font-weight:700;
    }
    .select{
      min-width:180px;
      padding:12px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background: rgba(255,255,255,.03);
      color:var(--text);
      font-weight:800;
      outline:none;
    }

    /* Chips */
    .chips{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:1000;
      cursor:pointer;
      user-select:none;
    }
    .chipOn{
      border:1px solid rgba(34,197,94,.35);
      background: rgba(34,197,94,.14);
      color:#bbf7d0;
    }

    /* Social */
    .bar{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 860px){
      .bar{grid-template-columns:1fr}
    }
    .notice{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      border-radius:14px;
      padding:14px;
      display:flex;gap:10px;align-items:flex-start;
    }
    .badge{
      width:42px;height:42px;border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(245,158,11,.18);
      border:1px solid rgba(245,158,11,.30);
      flex:0 0 auto;
      font-size:18px;
    }
    .notice h3{
      margin:0;
      font-size:16px;
      font-weight:1000;
      letter-spacing:.2px;
    }
    .notice p{
      margin:6px 0 0;
      color: rgba(229,231,235,.92);
      font-weight:1000;
      font-size:14px;
      line-height:1.35;
    }

    /* Grid / cards */
    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
    }
    @media (max-width: 980px){.grid{grid-template-columns: repeat(2,1fr)}}
    @media (max-width: 620px){.grid{grid-template-columns: repeat(2, 1fr)}}
    @media (max-width: 380px){.grid{grid-template-columns: 1fr}}

    .card{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: 0 12px 24px rgba(0,0,0,.25);
      display:flex;flex-direction:column;
      min-height: 420px;
    }
    .imgbox{
      background: rgba(255,255,255,.03);
      border-bottom:1px solid var(--border);
      aspect-ratio: 16 / 11;
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
      padding:8px;
    }
    .imgbox img{
      width:100%;height:100%;
      object-fit:contain;
      display:block;
      filter:saturate(1.05) contrast(1.03);
      background: rgba(0,0,0,.12);
      border-radius: 12px;
    }

    .cardBody{padding:12px;display:grid;gap:10px}
    .title{
      margin:0;
      font-size:14px;
      line-height:1.25;
      font-weight:900;
      min-height: 36px;
    }

    /* ‚úÖ CTA por produto (somente texto) */
    .ctaTag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(245,158,11,.30);
      background: rgba(245,158,11,.12);
      color:#fde68a;
      font-weight:1000;
      font-size:13px;
      line-height:1.25;
    }

    .prices{
      display:flex;align-items:flex-end;justify-content:space-between;gap:10px;
      flex-wrap:wrap;
    }
    .row{
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      flex-wrap:wrap;
    }
    .muted{color:var(--muted);font-weight:900;font-size:12px}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      font-size:12px;font-weight:900;color:var(--text);
    }
    .off{
      border:1px solid rgba(239,68,68,.32);
      background: rgba(239,68,68,.12);
      color:#fecaca;
    }
    .coupon{
      border:1px solid rgba(34,197,94,.28);
      background: rgba(34,197,94,.12);
      color:#bbf7d0;
    }
    .buy{
      margin-top:2px;
      display:flex;gap:10px;
      flex-wrap:wrap;
    }
    .btnSmall{
      flex:1;
      min-width: 140px;
      display:flex;align-items:center;justify-content:center;
      padding:11px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      font-weight:1000;
      cursor:pointer;
      color:var(--text);
    }
    .btnBuy{
      background: linear-gradient(135deg, rgba(245,158,11,.98), rgba(245,158,11,.78));
      color:#1b1201;border:none;
    }
    .btnGroup{
      background: linear-gradient(135deg, rgba(34,197,94,.98), rgba(34,197,94,.78));
      color:#052014;border:none;
    }
    .btnShare{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.18);
      color:var(--text);
    }

    footer{
      margin:18px 0 110px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius);
      padding:14px;
    }
    footer b{display:block;margin-bottom:6px}
    footer ul{margin:0;padding-left:18px;color:var(--muted);font-weight:800;font-size:13px;line-height:1.55}

    .wa{
      position:fixed;right:16px;bottom:16px;z-index:999;
      display:flex;align-items:center;gap:10px;
      padding:14px 14px;
      border-radius:999px;
      background: linear-gradient(135deg, rgba(34,197,94,.98), rgba(34,197,94,.78));
      color:#052014;
      font-weight:1000;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      border:none;
      cursor:pointer;
      max-width: calc(100vw - 32px);
    }
    .wa small{display:block;font-weight:900;opacity:.9;line-height:1}
    .wa span{display:block;line-height:1}
    .waIcon{
      width:38px;height:38px;border-radius:999px;
      background: rgba(0,0,0,.12);
      display:flex;align-items:center;justify-content:center;
      font-size:18px;
    }

    .loading{
      margin-top:16px;
      border:1px dashed rgba(255,255,255,.18);
      border-radius: var(--radius);
      padding:14px;
      color:var(--muted);
      font-weight:900;
    }
  </style>
</head>

<body>

<div class="topbar">
  <div class="wrap">
    <div class="topbrand">
      <div class="toplogo" aria-hidden="true">
        <img src="logo.png" alt="Logo Achadinhos" onerror="this.style.display='none'">
      </div>
      <div class="toptext">
        <div class="topname">Achadinhos Oficial</div>
        <div class="toptag">Ofertas e cupons no grupo ‚Ä¢ aproveite antes que acabe</div>
      </div>
    </div>

    <div class="topright" onclick="openGroup()" title="Abrir grupo do WhatsApp">
      üü¢ Entrar no grupo
    </div>
  </div>
</div>

<header>
  <div class="wrap">
    <div class="headbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div>Achadinhos <span style="color:#bbf7d0">Oficial</span></div>
          <div class="sub">Ofertas atualizadas direto da planilha</div>
        </div>
      </div>

      <div class="status" title="Atualiza√ß√£o autom√°tica">
        <span class="dot" id="statusDot"></span>
        <span id="updatedLabel"><b>Carregando</b></span>
        <span id="updatedTime" class="mini" data-mode="checking">Verificando‚Ä¶</span>
      </div>

      <div class="pill" id="countPill">0 ofertas</div>
    </div>
  </div>
</header>

<main class="wrap">

  <section class="hero">
    <div class="hero-inner">
      <div>
        <h1>As melhores ofertas do dia ‚Äî sem enrola√ß√£o. <span style="color:#bbf7d0">Clique e garanta.</span></h1>

        <div class="ctaRow">
          <button class="btn btnPrimary" onclick="scrollToOffers()">üéÅ Ver ofertas agora</button>
          <button class="btn" onclick="forceReload()">üîÑ Atualizar agora</button>
          <button class="btn" onclick="openGroup()">üü¢ Entrar no grupo</button>
        </div>

        <div class="videoWrap" id="videoWrap">
          <div class="videoTop">
            <div>
              <b>üé• V√≠deo</b>
              <div class="mini">No celular, autoplay com √°udio √© bloqueado. Use ‚ÄúAtivar √°udio‚Äù.</div>
            </div>
            <button class="btnTiny" onclick="enableVideoAudio()">üîä Ativar √°udio</button>
          </div>
          <div class="videoFrame">
            <video id="promoVideo" controls playsinline preload="metadata"></video>
          </div>
        </div>
      </div>

      <div class="kpi">
        <div class="kpiCard">
          <b id="kpi1">0</b>
          <span>ofertas dispon√≠veis</span>
        </div>
        <div class="kpiCard">
          <b id="kpi2">0</b>
          <span>vendidos hoje (estimativa)</span>
        </div>
      </div>
    </div>
  </section>

  <!-- OFERTA DO MINUTO -->
  <section id="spotlight" class="spot" style="display:none" aria-live="polite">
    <div class="spotImg">
      <img id="spotImg" src="" alt="Oferta do minuto" referrerpolicy="no-referrer">
    </div>
    <div class="spotBody">
      <div class="spotTop">
        <div class="spotBadge">üö® OFERTA DO MINUTO</div>
        <div class="muted" id="spotMeta">pode acabar a qualquer momento</div>
      </div>

      <h2 class="spotTitle" id="spotTitle">‚Äî</h2>

      <div class="spotPrices">
        <div class="priceNow" id="spotNow">‚Äî</div>
        <div class="priceOld" id="spotOld" style="display:none">‚Äî</div>
      </div>

      <div class="spotCopy" id="spotCopy">
        üî• Oferta rotativa: Se gostou, aproveite agora ‚Äî pode acabar a qualquer momento.
      </div>

      <div class="spotBtns">
        <button class="btnSmall btnBuy" onclick="spotOpen()">Ver oferta</button>
        <button class="btnSmall btnGroup" onclick="openGroup()">Entrar no grupo</button>
        <button class="btnSmall btnShare" onclick="spotShare()">Compartilhar</button>
      </div>
    </div>
  </section>

  <section class="controls">
    <div class="search">
      üîé <input id="q" type="text" placeholder="Buscar produto (ex: t√™nis, perfume, mesa...)" />
    </div>

    <select class="select" id="sort">
      <option value="best">Ordenar: destaque</option>
      <option value="priceAsc">Menor pre√ßo</option>
      <option value="priceDesc">Maior pre√ßo</option>
      <option value="discountDesc">Maior desconto</option>
      <option value="soldDesc">Mais vendidos</option>
      <option value="ratingDesc">Melhor avalia√ß√£o</option>
    </select>
  </section>

  <section class="chips">
    <div class="chip" id="chipCoupon" onclick="toggleChip('coupon')">üßæ Com cupom</div>
    <div class="chip" id="chipDiscount" onclick="toggleChip('discount')">üî• Maior desconto</div>
  </section>

  <section class="bar">
    <div class="notice">
      <div class="badge">‚úÖ</div>
      <div>
        <p id="socialProof">‚úÖ +1.200 pessoas j√° entraram no grupo ‚Ä¢ üî• 27 ofertas postadas hoje</p>
      </div>
    </div>

    <div class="notice">
      <div class="badge">üî•</div>
      <div>
        <p id="urgencyText">üî• As melhores ofertas somem primeiro. Se gostou, clique e garanta AGORA ‚Äî pode acabar a qualquer momento.</p>
      </div>
    </div>
  </section>

  <div id="loading" class="loading">Carregando ofertas da planilha‚Ä¶</div>

  <section id="offers" class="grid" aria-live="polite"></section>

  <footer>
    <b>üîí Compra com mais seguran√ßa</b>
    <ul>
      <li>Este site divulga ofertas encontradas em marketplaces e grupos parceiros.</li>
      <li><b>N√£o somos uma loja oficial do Mercado Livre</b> e n√£o representamos a marca.</li>
      <li>Pre√ßos e disponibilidade podem mudar a qualquer momento no site do vendedor.</li>
      <li>Se algum item n√£o abrir, atualize a p√°gina e tente novamente.</li>
    </ul>
  </footer>

</main>

<button class="wa" onclick="openGroup()" aria-label="Entrar no grupo do WhatsApp">
  <div class="waIcon">üü¢</div>
  <div>
    <span>Entrar no grupo</span>
    <small>Receber links e cupons</small>
  </div>
</button>

<script>
/* =========================
   CONFIG
========================= */
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYh-FJUhtB7MT80tKHccZi-z1hTKUOwDqg-tQSR_YPiDOQv-mKmSjTyAtZzmhq8YEchYOjqcVZhJv3/pub?output=csv";
const WHATSAPP_GROUP_LINK = "https://chat.whatsapp.com/GdvrM4Ct4Q6CA6Tf0DRyov";
const VIDEO_URL = "video.mp4";
const REFRESH_MS = 20000;

/* =========================
   SPOTLIGHT
========================= */
const SPOT_ROTATE_MS = 25000;
let SPOT_TIMER = null;
let SPOT_INDEX = 0;
let SPOT_TOP_LIST = [];
let SPOT_ITEM = null;

/* =========================
   STATE
========================= */
let ALL_ITEMS = [];

/* =========================
   HELPERS
========================= */
function safeText(x){ return (x ?? "").toString().trim(); }
function toNumber(str){
  if(!str) return NaN;
  return Number(String(str).replace(/\./g,'').replace(',','.').replace(/[^\d.-]/g,''));
}
function moneyBRL(n){
  if(!isFinite(n)) return "";
  return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}
function openGroup(){ window.open(WHATSAPP_GROUP_LINK,"_blank"); }
function openOffer(it){ window.open(it.link || WHATSAPP_GROUP_LINK,"_blank"); }

/* =========================
   CSV
========================= */
function parseCSV(text){
  const rows=[], r=[]; let c="", q=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i], nx=text[i+1];
    if(ch=='"'&&q&&nx=='"'){c+='"';i++;continue;}
    if(ch=='"'){q=!q;continue;}
    if(ch==','&&!q){r.push(c);c="";continue;}
    if((ch=='\n'||ch=='\r')&&!q){
      if(ch=='\r'&&nx=='\n')i++;
      r.push(c); rows.push([...r]); r.length=0; c=""; continue;
    }
    c+=ch;
  }
  r.push(c); rows.push([...r]);
  return rows;
}

/* =========================
   SPOTLIGHT ROTATION
========================= */
function buildSpotTopList(items){
  return [...items]
    .sort((a,b)=> (b.discountNum||0)-(a.discountNum||0))
    .slice(0,12);
}

function startSpotRotation(){
  if(SPOT_TIMER) clearInterval(SPOT_TIMER);
  if(!SPOT_TOP_LIST.length) return;

  SPOT_INDEX = 0;
  setSpotItem(SPOT_TOP_LIST[SPOT_INDEX]);

  SPOT_TIMER = setInterval(()=>{
    SPOT_INDEX = (SPOT_INDEX + 1) % SPOT_TOP_LIST.length;
    setSpotItem(SPOT_TOP_LIST[SPOT_INDEX]);
  }, SPOT_ROTATE_MS);
}

function setSpotItem(it){
  SPOT_ITEM = it;
  renderSpotlight();
}

function renderSpotlight(){
  const box = document.getElementById("spotlight");
  if(!box || !SPOT_ITEM) return;

  document.getElementById("spotImg").src = SPOT_ITEM.image;
  document.getElementById("spotTitle").textContent = SPOT_ITEM.title;
  document.getElementById("spotNow").textContent = SPOT_ITEM.finalPriceText;

  const old = document.getElementById("spotOld");
  if(SPOT_ITEM.originalPriceText){
    old.style.display="block";
    old.textContent = SPOT_ITEM.originalPriceText;
  }else old.style.display="none";

  document.getElementById("spotMeta").textContent =
    `üöö Frete Gr√°tis ‚Ä¢ üî• ${SPOT_ITEM.discount || "Oferta limitada"}`;

  box.style.display="grid";
}

/* =========================
   RENDER
========================= */
function render(){
  const grid = document.getElementById("offers");
  grid.innerHTML = "";

  ALL_ITEMS.forEach(it=>{
    const card=document.createElement("article");
    card.className="card";

    card.innerHTML=`
      <div class="imgbox">
        <img src="${it.image}" loading="lazy">
      </div>
      <div class="cardBody">
        <h2 class="title">${it.title}</h2>

        <div class="prices">
          <div class="priceNow">${it.finalPriceText}</div>
          ${it.originalPriceText ? `<div class="priceOld">${it.originalPriceText}</div>`:""}
        </div>

        <div class="row">
          <div class="muted">‚≠ê ${it.rating||"‚Äî"} ‚Ä¢ ${it.sold||"‚Äî"} vendidos</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <span class="tag" style="background:rgba(34,197,94,.15);border:1px solid rgba(34,197,94,.35);color:#bbf7d0">
              üöö Frete Gr√°tis
            </span>
            ${it.discount?`<span class="tag off">${it.discount}</span>`:""}
          </div>
        </div>

        <div class="buy">
          <button class="btnSmall btnBuy">Ver oferta</button>
          <button class="btnSmall btnGroup">Entrar no grupo</button>
        </div>
      </div>
    `;

    card.querySelector(".btnBuy").onclick=()=>openOffer(it);
    card.querySelector(".btnGroup").onclick=openGroup;

    grid.appendChild(card);
  });
}

/* =========================
   LOAD SHEET
========================= */
async function loadSheet(){
  const res = await fetch(SHEET_CSV_URL+"&t="+Date.now(),{cache:"no-store"});
  const text = await res.text();
  const rows = parseCSV(text);

  const h = rows[0].map(x=>safeText(x).toLowerCase());
  const idx = n => h.indexOf(n);

  ALL_ITEMS = [];

  for(let i=1;i<rows.length;i++){
    const r = rows[i];
    const title = safeText(r[idx("title")]);
    const image = safeText(r[idx("image")]);
    const price = toNumber(r[idx("price")]);
    const disc = toNumber(r[idx("discount")]);
    const link = safeText(r[idx("affiliate")]||r[idx("link")]);

    if(!title||!image) continue;

    const final = isFinite(disc)? price*(1-disc/100):price;

    ALL_ITEMS.push({
      title,
      image,
      link,
      discount: disc?`${disc}% OFF`:"",
      discountNum: disc||0,
      originalPriceText: price?moneyBRL(price):"",
      finalPriceText: moneyBRL(final),
      sold: safeText(r[idx("sold")]),
      rating: safeText(r[idx("rating")])
    });
  }

  SPOT_TOP_LIST = buildSpotTopList(ALL_ITEMS);
  startSpotRotation();
  render();
}

/* =========================
   START
========================= */
loadSheet();
setInterval(loadSheet, REFRESH_MS);
</script>
<body>  
</html>
